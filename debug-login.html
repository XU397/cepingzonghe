<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•APIè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; }
        .log { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
    <!-- å¼•å…¥JSEncryptåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
</head>
<body>
    <h1>ç™»å½•APIè°ƒè¯•å·¥å…·</h1>
    
    <div class="form-group">
        <label for="accountName">è´¦å·åç§° (accountName):</label>
        <input type="text" id="accountName" placeholder="è¾“å…¥æµ‹è¯•è´¦å·" value="3004">
    </div>
    
    <div class="form-group">
        <label for="password">å¯†ç :</label>
        <input type="password" id="password" placeholder="è¾“å…¥å¯†ç " value="1234">
    </div>
    
    <div class="form-group">
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <button onclick="testEncryption()">æµ‹è¯•åŠ å¯†</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="form-group">
        <label>è¯·æ±‚URLé¢„è§ˆ:</label>
        <div id="urlPreview" style="background: #eee; padding: 10px; word-break: break-all;"></div>
    </div>
    
    <div class="log" id="log">
        <div>æ—¥å¿—è¾“å‡º...</div>
    </div>

    <script>
        // RSAå…¬é’¥ï¼ˆä¸ä¸»åº”ç”¨ä¿æŒä¸€è‡´ï¼‰
        const PUBLIC_KEY = 'MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM5b2W+KjQrLMIJPLaINGAd7KCt5cRq5tLoioe6L3MdyUI9E9wwkZeRD92Aqp4AFR9GrUy1Yw9vuDfShaDcEjbsCAwEAAQ==';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' :
                            type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>æ—¥å¿—å·²æ¸…ç©º...</div>';
        }

        function updateUrlPreview() {
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;
            const url = `/stu/login?accountName=${encodeURIComponent(accountName)}&accountPass=[RSAåŠ å¯†åçš„å¯†ç ]&type=2`;
            document.getElementById('urlPreview').textContent = url;
        }

        // RSAåŠ å¯†å‡½æ•°
        function encryptPassword(password) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(PUBLIC_KEY);
                const encrypted = encrypt.encrypt(password);
                
                if (!encrypted || encrypted === 'false') {
                    throw new Error('åŠ å¯†å¤±è´¥');
                }
                
                return encrypted;
            } catch (error) {
                console.error('åŠ å¯†é”™è¯¯:', error);
                throw new Error('å¯†ç åŠ å¯†å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•åŠ å¯†åŠŸèƒ½
        function testEncryption() {
            const password = document.getElementById('password').value;
            
            if (!password) {
                log('è¯·è¾“å…¥å¯†ç ', 'error');
                return;
            }
            
            try {
                log('å¼€å§‹æµ‹è¯•RSAåŠ å¯†...');
                log(`åŸå§‹å¯†ç é•¿åº¦: ${password.length} å­—ç¬¦`);
                
                const encrypted = encryptPassword(password);
                log(`RSAåŠ å¯†æˆåŠŸ`, 'success');
                log(`åŠ å¯†åé•¿åº¦: ${encrypted.length} å­—ç¬¦`);
                log(`åŠ å¯†ç»“æœå‰50å­—ç¬¦: ${encrypted.substring(0, 50)}...`, 'info');
                
                // æµ‹è¯•æ˜¯å¦æ¯æ¬¡åŠ å¯†ç»“æœä¸åŒï¼ˆRSAåŠ å¯†æ¯æ¬¡ç»“æœåº”è¯¥ä¸åŒï¼‰
                const encrypted2 = encryptPassword(password);
                const isDifferent = encrypted !== encrypted2;
                log(`å¤šæ¬¡åŠ å¯†ç»“æœæ˜¯å¦ä¸åŒ: ${isDifferent ? 'æ˜¯' : 'å¦'} ${isDifferent ? 'âœ“' : 'âš ï¸'}`, isDifferent ? 'success' : 'warning');
                
            } catch (error) {
                log(`åŠ å¯†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('accountName').addEventListener('input', updateUrlPreview);
        document.getElementById('password').addEventListener('input', updateUrlPreview);

        async function testLogin() {
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }

            log('å¼€å§‹æµ‹è¯•ç™»å½•...');
            log(`è´¦å·: ${accountName}`);
            log(`å¯†ç é•¿åº¦: ${password.length} å­—ç¬¦`);

            try {
                // ä½¿ç”¨RSAåŠ å¯†
                log('æ­£åœ¨è¿›è¡ŒRSAåŠ å¯†...', 'info');
                const encryptedPassword = encryptPassword(password);
                log(`RSAåŠ å¯†å®Œæˆ`, 'success');
                log(`åŠ å¯†åå¯†ç é•¿åº¦: ${encryptedPassword.length} å­—ç¬¦`);
                log(`åŠ å¯†åå¯†ç å‰50å­—ç¬¦: ${encryptedPassword.substring(0, 50)}...`, 'info');

                const params = new URLSearchParams({
                    accountName: accountName,
                    accountPass: encryptedPassword,
                    type: 2
                });

                const url = `/stu/login?${params.toString()}`;
                log(`è¯·æ±‚URLé•¿åº¦: ${url.length} å­—ç¬¦`);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                log(`HTTPçŠ¶æ€: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`HTTPé”™è¯¯å“åº”: ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 
                    data.code === 200 ? 'success' : 'error');

                if (data.code === 200) {
                    log('ğŸ‰ ç™»å½•æˆåŠŸï¼', 'success');
                    if (data.obj) {
                        log(`ğŸ“‹ æ‰¹æ¬¡å·: ${data.obj.batchCode}`, 'info');
                        log(`ğŸ“ è€ƒå·: ${data.obj.examNo}`, 'info');
                        log(`ğŸ‘¤ å­¦ç”Ÿå§“å: ${data.obj.studentName}`, 'info');
                        log(`ğŸ« å­¦æ ¡: ${data.obj.schoolName}`, 'info');
                        log(`ğŸ“„ é¡µé¢æ•°: ${data.obj.pageNum}`, 'info');
                    }
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.msg}`, 'error');
                    
                    // æä¾›ä¸€äº›æ•…éšœæ’é™¤å»ºè®®
                    if (data.msg && data.msg.includes('å¯†ç é”™è¯¯')) {
                        log('ğŸ’¡ å»ºè®®æ£€æŸ¥:', 'warning');
                        log('1. ç¡®è®¤è´¦å·å’Œå¯†ç æ˜¯å¦æ­£ç¡®', 'warning');
                        log('2. ç¡®è®¤æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„æµ‹è¯•è´¦å·', 'warning');
                        log('3. è”ç³»ç®¡ç†å‘˜ç¡®è®¤è´¦å·çŠ¶æ€', 'warning');
                    }
                }

            } catch (error) {
                log(`ğŸš« è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                console.error('ç™»å½•æµ‹è¯•é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥JSEncryptæ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof JSEncrypt !== 'undefined') {
                log('âœ… JSEncryptåº“åŠ è½½æˆåŠŸ', 'success');
                log('âœ… RSAåŠ å¯†åŠŸèƒ½å¯ç”¨', 'success');
            } else {
                log('âŒ JSEncryptåº“åŠ è½½å¤±è´¥', 'error');
                log('âš ï¸ å°†ä½¿ç”¨base64åŠ å¯†ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰', 'warning');
            }
            
            updateUrlPreview();
            log('ğŸ”§ ç™»å½•APIè°ƒè¯•å·¥å…·å·²å°±ç»ª');
            log('ğŸ“ è¯·è¾“å…¥æµ‹è¯•è´¦å·å’Œå¯†ç ï¼Œç„¶åç‚¹å‡»æµ‹è¯•ç™»å½•');
            log('ğŸ’¡ å¯ä»¥å…ˆç‚¹å‡»"æµ‹è¯•åŠ å¯†"éªŒè¯RSAåŠ å¯†æ˜¯å¦æ­£å¸¸å·¥ä½œ');
            
            // æä¾›ä¸€äº›ä½¿ç”¨è¯´æ˜
            log('', 'info');
            log('ğŸ“š ä½¿ç”¨è¯´æ˜:', 'info');
            log('1. å…ˆç‚¹å‡»"æµ‹è¯•åŠ å¯†"ç¡®è®¤åŠ å¯†åŠŸèƒ½æ­£å¸¸', 'info');
            log('2. è¾“å…¥æœ‰æ•ˆçš„æµ‹è¯•è´¦å·å’Œå¯†ç ', 'info');
            log('3. ç‚¹å‡»"æµ‹è¯•ç™»å½•"è¿›è¡ŒAPIè°ƒç”¨æµ‹è¯•', 'info');
            log('4. å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è·å–æ­£ç¡®çš„æµ‹è¯•è´¦å·', 'info');
        });
    </script>
</body>
</html> 