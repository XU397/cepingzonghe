<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录API调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; }
        .log { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
    <!-- 引入JSEncrypt库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
</head>
<body>
    <h1>登录API调试工具</h1>
    
    <div class="form-group">
        <label for="accountName">账号名称 (accountName):</label>
        <input type="text" id="accountName" placeholder="输入测试账号" value="3004">
    </div>
    
    <div class="form-group">
        <label for="password">密码:</label>
        <input type="password" id="password" placeholder="输入密码" value="1234">
    </div>
    
    <div class="form-group">
        <button onclick="testLogin()">测试登录</button>
        <button onclick="testEncryption()">测试加密</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <div class="form-group">
        <label>请求URL预览:</label>
        <div id="urlPreview" style="background: #eee; padding: 10px; word-break: break-all;"></div>
    </div>
    
    <div class="log" id="log">
        <div>日志输出...</div>
    </div>

    <script>
        // RSA公钥（与主应用保持一致）
        const PUBLIC_KEY = 'MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM5b2W+KjQrLMIJPLaINGAd7KCt5cRq5tLoioe6L3MdyUI9E9wwkZeRD92Aqp4AFR9GrUy1Yw9vuDfShaDcEjbsCAwEAAQ==';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' :
                            type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>日志已清空...</div>';
        }

        function updateUrlPreview() {
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;
            const url = `/stu/login?accountName=${encodeURIComponent(accountName)}&accountPass=[RSA加密后的密码]&type=2`;
            document.getElementById('urlPreview').textContent = url;
        }

        // RSA加密函数
        function encryptPassword(password) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(PUBLIC_KEY);
                const encrypted = encrypt.encrypt(password);
                
                if (!encrypted || encrypted === 'false') {
                    throw new Error('加密失败');
                }
                
                return encrypted;
            } catch (error) {
                console.error('加密错误:', error);
                throw new Error('密码加密失败: ' + error.message);
            }
        }

        // 测试加密功能
        function testEncryption() {
            const password = document.getElementById('password').value;
            
            if (!password) {
                log('请输入密码', 'error');
                return;
            }
            
            try {
                log('开始测试RSA加密...');
                log(`原始密码长度: ${password.length} 字符`);
                
                const encrypted = encryptPassword(password);
                log(`RSA加密成功`, 'success');
                log(`加密后长度: ${encrypted.length} 字符`);
                log(`加密结果前50字符: ${encrypted.substring(0, 50)}...`, 'info');
                
                // 测试是否每次加密结果不同（RSA加密每次结果应该不同）
                const encrypted2 = encryptPassword(password);
                const isDifferent = encrypted !== encrypted2;
                log(`多次加密结果是否不同: ${isDifferent ? '是' : '否'} ${isDifferent ? '✓' : '⚠️'}`, isDifferent ? 'success' : 'warning');
                
            } catch (error) {
                log(`加密测试失败: ${error.message}`, 'error');
            }
        }

        // 监听输入变化
        document.getElementById('accountName').addEventListener('input', updateUrlPreview);
        document.getElementById('password').addEventListener('input', updateUrlPreview);

        async function testLogin() {
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('请输入账号和密码', 'error');
                return;
            }

            log('开始测试登录...');
            log(`账号: ${accountName}`);
            log(`密码长度: ${password.length} 字符`);

            try {
                // 使用RSA加密
                log('正在进行RSA加密...', 'info');
                const encryptedPassword = encryptPassword(password);
                log(`RSA加密完成`, 'success');
                log(`加密后密码长度: ${encryptedPassword.length} 字符`);
                log(`加密后密码前50字符: ${encryptedPassword.substring(0, 50)}...`, 'info');

                const params = new URLSearchParams({
                    accountName: accountName,
                    accountPass: encryptedPassword,
                    type: 2
                });

                const url = `/stu/login?${params.toString()}`;
                log(`请求URL长度: ${url.length} 字符`);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                log(`HTTP状态: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`HTTP错误响应: ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                log(`响应数据: ${JSON.stringify(data, null, 2)}`, 
                    data.code === 200 ? 'success' : 'error');

                if (data.code === 200) {
                    log('🎉 登录成功！', 'success');
                    if (data.obj) {
                        log(`📋 批次号: ${data.obj.batchCode}`, 'info');
                        log(`🎓 考号: ${data.obj.examNo}`, 'info');
                        log(`👤 学生姓名: ${data.obj.studentName}`, 'info');
                        log(`🏫 学校: ${data.obj.schoolName}`, 'info');
                        log(`📄 页面数: ${data.obj.pageNum}`, 'info');
                    }
                } else {
                    log(`❌ 登录失败: ${data.msg}`, 'error');
                    
                    // 提供一些故障排除建议
                    if (data.msg && data.msg.includes('密码错误')) {
                        log('💡 建议检查:', 'warning');
                        log('1. 确认账号和密码是否正确', 'warning');
                        log('2. 确认是否使用了正确的测试账号', 'warning');
                        log('3. 联系管理员确认账号状态', 'warning');
                    }
                }

            } catch (error) {
                log(`🚫 请求错误: ${error.message}`, 'error');
                console.error('登录测试错误:', error);
            }
        }

        // 页面加载完成后的初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 检查JSEncrypt是否加载成功
            if (typeof JSEncrypt !== 'undefined') {
                log('✅ JSEncrypt库加载成功', 'success');
                log('✅ RSA加密功能可用', 'success');
            } else {
                log('❌ JSEncrypt库加载失败', 'error');
                log('⚠️ 将使用base64加密（仅测试用）', 'warning');
            }
            
            updateUrlPreview();
            log('🔧 登录API调试工具已就绪');
            log('📝 请输入测试账号和密码，然后点击测试登录');
            log('💡 可以先点击"测试加密"验证RSA加密是否正常工作');
            
            // 提供一些使用说明
            log('', 'info');
            log('📚 使用说明:', 'info');
            log('1. 先点击"测试加密"确认加密功能正常', 'info');
            log('2. 输入有效的测试账号和密码', 'info');
            log('3. 点击"测试登录"进行API调用测试', 'info');
            log('4. 如遇到问题，请联系管理员获取正确的测试账号', 'info');
        });
    </script>
</body>
</html> 