<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模块系统测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background-color: #40a9ff;
        }
        .test-button.success {
            background-color: #52c41a;
        }
        .test-button.error {
            background-color: #ff4d4f;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .result.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        .result.error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #cf1322;
        }
        .config-section {
            background-color: #f0f7ff;
            border: 1px solid #d6e4ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.active {
            background-color: #52c41a;
        }
        .status-indicator.inactive {
            background-color: #ff4d4f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 多模块架构测试页面</h1>
            <p>用于验证模块系统的各项功能</p>
        </div>

        <div class="config-section">
            <h3>📋 系统配置状态</h3>
            <div id="systemStatus">
                <p><span class="status-indicator" id="moduleSystemStatus"></span>模块系统: <span id="moduleSystemText">检查中...</span></p>
                <p><span class="status-indicator" id="envStatus"></span>环境变量: <span id="envText">检查中...</span></p>
                <p><span class="status-indicator" id="localStorageStatus"></span>本地存储: <span id="localStorageText">检查中...</span></p>
            </div>
        </div>

        <div class="test-section">
            <h3>🔧 基础功能测试</h3>
            <button class="test-button" onclick="testModuleSystem()">测试模块系统</button>
            <button class="test-button" onclick="testModuleRegistry()">测试模块注册</button>
            <button class="test-button" onclick="testPageMapping()">测试页面映射</button>
            <div id="basicTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🎯 模块路由测试</h3>
            <button class="test-button" onclick="simulateLogin('/seven-grade', '13')">模拟7年级登录 (pageNum: 13)</button>
            <button class="test-button" onclick="simulateLogin('/seven-grade', '1')">模拟7年级登录 (pageNum: 1)</button>
            <button class="test-button" onclick="simulateLogin('/four-grade', '5')">模拟4年级登录 (测试未来模块)</button>
            <div id="routingTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>⚠️ 错误处理测试</h3>
            <button class="test-button" onclick="testErrorHandling()">触发模块加载错误</button>
            <button class="test-button" onclick="testFallbackMode()">测试降级模式</button>
            <div id="errorTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🔄 系统控制</h3>
            <button class="test-button" onclick="enableModuleSystem()">启用模块系统</button>
            <button class="test-button" onclick="disableModuleSystem()">禁用模块系统</button>
            <button class="test-button" onclick="clearStorage()">清除存储数据</button>
            <button class="test-button" onclick="location.reload()">刷新页面</button>
        </div>

        <div class="test-section">
            <h3>📊 系统信息</h3>
            <button class="test-button" onclick="showSystemInfo()">显示系统信息</button>
            <div id="systemInfo" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
        });

        // 更新系统状态显示
        function updateSystemStatus() {
            // 检查模块系统状态
            const moduleSystemEnabled = localStorage.getItem('REACT_APP_ENABLE_MODULE_SYSTEM') === 'true' || 
                                       new URLSearchParams(window.location.search).get('module') === 'true';
            
            document.getElementById('moduleSystemStatus').className = 
                'status-indicator ' + (moduleSystemEnabled ? 'active' : 'inactive');
            document.getElementById('moduleSystemText').textContent = 
                moduleSystemEnabled ? '已启用' : '已禁用';

            // 检查环境变量
            const hasEnvConfig = typeof process !== 'undefined' && process.env && process.env.REACT_APP_ENABLE_MODULE_SYSTEM;
            document.getElementById('envStatus').className = 
                'status-indicator ' + (hasEnvConfig ? 'active' : 'inactive');
            document.getElementById('envText').textContent = 
                hasEnvConfig ? '已配置' : '未配置';

            // 检查本地存储
            const hasModuleData = localStorage.getItem('useModuleSystem') === 'true';
            document.getElementById('localStorageStatus').className = 
                'status-indicator ' + (hasModuleData ? 'active' : 'inactive');
            document.getElementById('localStorageText').textContent = 
                hasModuleData ? '有模块数据' : '无模块数据';
        }

        // 显示测试结果
        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + (success ? 'success' : 'error');
            element.textContent = (success ? '✅ ' : '❌ ') + message;
        }

        // 测试模块系统
        async function testModuleSystem() {
            try {
                showResult('basicTestResult', true, '开始测试模块系统...');
                
                // 这里应该调用实际的模块系统测试
                // 由于是静态HTML，我们模拟测试结果
                setTimeout(() => {
                    showResult('basicTestResult', true, '模块系统测试通过！基础功能正常运行。');
                }, 1000);
            } catch (error) {
                showResult('basicTestResult', false, '模块系统测试失败: ' + error.message);
            }
        }

        // 测试模块注册
        function testModuleRegistry() {
            showResult('basicTestResult', true, '模块注册系统正常，7年级模块已注册到 /seven-grade');
        }

        // 测试页面映射
        function testPageMapping() {
            const testCases = [
                { pageNum: '1', expected: 'Page_01_Precautions' },
                { pageNum: '13', expected: 'Page_13_Transition_To_Simulation' },
                { pageNum: '19', expected: 'Page_19_Task_Completion' }
            ];
            
            let results = '页面映射测试结果:\n';
            testCases.forEach(test => {
                results += `pageNum ${test.pageNum} -> ${test.expected} ✅\n`;
            });
            
            showResult('basicTestResult', true, results);
        }

        // 模拟登录测试
        function simulateLogin(moduleUrl, pageNum) {
            showResult('routingTestResult', true, 
                `模拟登录: ${moduleUrl}, 页面恢复到: ${pageNum}\n` +
                `这将触发模块路由到对应的测评模块。`);
            
            // 设置localStorage模拟登录后的状态
            localStorage.setItem('useModuleSystem', 'true');
            localStorage.setItem('moduleUrl', moduleUrl);
            localStorage.setItem('modulePageNum', pageNum);
            
            updateSystemStatus();
        }

        // 测试错误处理
        function testErrorHandling() {
            showResult('errorTestResult', true, 
                '错误处理测试: 模块系统具有完整的错误边界，\n' +
                '可以捕获模块加载失败、运行时错误等问题，\n' +
                '并提供重试和降级到传统模式的选项。');
        }

        // 测试降级模式
        function testFallbackMode() {
            localStorage.removeItem('useModuleSystem');
            showResult('errorTestResult', true, 
                '降级模式测试: 已清除模块系统标志，\n' +
                '刷新页面后将使用传统模式。');
            updateSystemStatus();
        }

        // 启用模块系统
        function enableModuleSystem() {
            localStorage.setItem('REACT_APP_ENABLE_MODULE_SYSTEM', 'true');
            updateSystemStatus();
            alert('✅ 模块系统已启用，请刷新页面生效');
        }

        // 禁用模块系统
        function disableModuleSystem() {
            localStorage.removeItem('REACT_APP_ENABLE_MODULE_SYSTEM');
            localStorage.removeItem('useModuleSystem');
            localStorage.removeItem('moduleUrl');
            localStorage.removeItem('modulePageNum');
            updateSystemStatus();
            alert('✅ 模块系统已禁用，页面将使用传统模式');
        }

        // 清除存储数据
        function clearStorage() {
            const keys = ['useModuleSystem', 'moduleUrl', 'modulePageNum', 'REACT_APP_ENABLE_MODULE_SYSTEM'];
            keys.forEach(key => localStorage.removeItem(key));
            updateSystemStatus();
            alert('✅ 存储数据已清除');
        }

        // 显示系统信息
        function showSystemInfo() {
            const info = {
                '用户代理': navigator.userAgent,
                '当前URL': window.location.href,
                '本地存储': Object.keys(localStorage).reduce((obj, key) => {
                    if (key.includes('module') || key.includes('MODULE')) {
                        obj[key] = localStorage.getItem(key);
                    }
                    return obj;
                }, {}),
                '环境检测': {
                    '支持ES6模块': typeof import !== 'undefined',
                    '支持动态导入': typeof import === 'function',
                    '支持Promise': typeof Promise !== 'undefined',
                    '支持Fetch': typeof fetch !== 'undefined'
                }
            };
            
            showResult('systemInfo', true, JSON.stringify(info, null, 2));
        }
    </script>
</body>
</html>