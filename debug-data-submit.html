<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔬 Session验证失败专家诊断</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a99; }
        .log { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 700px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .warning { color: #f57c00; font-weight: bold; }
        .info { color: #1976d2; }
        .step { background: #e7f3ff; padding: 15px; margin: 15px 0; border-left: 4px solid #007acc; }
        .critical { background: #ffebee; border: 2px solid #f44336; padding: 15px; margin: 10px 0; }
        .expert { background: #f3e5f5; border: 2px solid #9c27b0; padding: 15px; margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
</head>
<body>
    <h1>🔬 Session验证失败专家诊断</h1>
    
    <div class="critical">
        <h3>🚨 关键发现</h3>
        <p><strong>登录后立即提交（1秒内）仍然401错误</strong></p>
        <p>排除：Session超时、数据格式、时机问题</p>
        <p><strong>问题焦点：</strong>Session存储/验证机制存在根本性问题</p>
    </div>
    
    <div class="expert">
        <h3>🔬 专家级诊断</h3>
        <button onclick="performExpertDiagnosis()">🔍 执行专家级全面诊断</button>
        <button onclick="compareAPIsInDetail()">📊 详细对比两个API</button>
        <button onclick="testCookieScopeIssues()">🍪 测试Cookie作用域问题</button>
        <button onclick="testWithExtraAuthParams()">🔐 测试额外认证参数</button>
    </div>
    
    <div class="step">
        <strong>核心测试：</strong> 深度Session机制分析
    </div>
    
    <div class="form-group">
        <label for="accountName">账号名称:</label>
        <input type="text" id="accountName" value="3004">
    </div>
    
    <div class="form-group">
        <label for="password">密码:</label>
        <input type="password" id="password" value="1234">
    </div>
    
    <div class="form-group">
        <label for="batchCode">批次号:</label>
        <input type="text" id="batchCode" placeholder="登录后自动填充">
    </div>
    
    <div class="form-group">
        <label for="examNo">考号:</label>
        <input type="text" id="examNo" placeholder="登录后自动填充">
    </div>
    
    <div class="form-group">
        <button onclick="testSequentialCalls()">⚡ 连续调用测试</button>
        <button onclick="testDifferentContentTypes()">📝 测试不同Content-Type</button>
        <button onclick="testBothAPIsWithSameRequest()">🔄 同请求测试两个API</button>
        <button onclick="clearLog()">🗑️ 清空日志</button>
    </div>
    
    <div class="log" id="log">
        <div>🔬 Session验证失败专家诊断工具已就绪</div>
        <div>🎯 <strong>目标：</strong>找出登录后立即提交仍失败的根本原因</div>
        <div>🔍 <strong>重点：</strong>Session存储机制、Cookie作用域、API验证逻辑差异</div>
    </div>

    <script>
        const PUBLIC_KEY = 'MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM5b2W+KjQrLMIJPLaINGAd7KCt5cRq5tLoioe6L3MdyUI9E9wwkZeRD92Aqp4AFR9GrUy1Yw9vuDfShaDcEjbsCAwEAAQ==';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' :
                            type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>🔬 日志已清空，专家诊断工具就绪</div>';
        }

        function encryptPassword(password) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(PUBLIC_KEY);
                const encrypted = encrypt.encrypt(password);
                if (!encrypted || encrypted === 'false') {
                    throw new Error('加密失败');
                }
                return encrypted;
            } catch (error) {
                throw new Error('密码加密失败: ' + error.message);
            }
        }

        // 专家级全面诊断
        async function performExpertDiagnosis() {
            log('🔬 开始专家级全面诊断...', 'info');
            log('', 'info');
            
            log('📋 环境基础信息:', 'info');
            log(`   - 当前域名: ${location.hostname}`, 'info');
            log(`   - 当前端口: ${location.port}`, 'info');
            log(`   - 当前协议: ${location.protocol}`, 'info');
            log(`   - 完整URL: ${location.href}`, 'info');
            
            log('📋 分析假设:', 'info');
            log('   1. Cookie作用域问题 - JSESSIONID可能只对特定路径有效', 'warning');
            log('   2. 后端Session存储不一致 - 两个API使用不同的Session存储', 'warning');
            log('   3. 验证逻辑差异 - 数据提交API需要额外的验证参数', 'warning');
            log('   4. 请求头差异 - 数据提交需要特定的请求头', 'warning');
            
            // 开始测试
            await testSequentialCalls();
        }

        // 详细对比两个API
        async function compareAPIsInDetail() {
            log('📊 开始详细对比两个API...', 'info');
            
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('❌ 请输入账号和密码', 'error');
                return;
            }

            try {
                const encryptedPassword = encryptPassword(password);
                
                // 1. 登录API详细分析
                log('📊 1. 登录API详细分析:', 'info');
                
                const loginParams = new URLSearchParams({
                    accountName: accountName,
                    accountPass: encryptedPassword,
                    type: 2
                });
                
                const loginUrl = `/stu/login?${loginParams.toString()}`;
                log(`   URL: ${loginUrl}`, 'info');
                
                const loginResponse = await fetch(loginUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                log(`   响应状态: ${loginResponse.status}`, 'info');
                log(`   响应类型: ${loginResponse.headers.get('content-type')}`, 'info');
                
                const loginData = await loginResponse.json();
                
                if (loginData.code === 200) {
                    log('   ✅ 登录成功', 'success');
                    
                    // 填充表单
                    document.getElementById('batchCode').value = loginData.obj.batchCode;
                    document.getElementById('examNo').value = loginData.obj.examNo;
                    
                    // 2. 数据提交API详细分析
                    log('📊 2. 数据提交API详细分析:', 'info');
                    
                    const payload = {
                        batchCode: loginData.obj.batchCode,
                        examNo: loginData.obj.examNo,
                        mark: {
                            pageNumber: "1",
                            pageDesc: "API对比测试",
                            operationList: [],
                            answerList: [],
                            beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                            endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                            imgList: []
                        }
                    };
                    
                    const submitUrl = `/stu/submitPageMarkData`;
                    log(`   URL: ${submitUrl}`, 'info');
                    
                    const submitResponse = await fetch(submitUrl, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });
                    
                    log(`   响应状态: ${submitResponse.status}`, 'info');
                    log(`   响应类型: ${submitResponse.headers.get('content-type')}`, 'info');
                    
                    const submitData = await submitResponse.json();
                    log(`   响应数据: ${JSON.stringify(submitData)}`, submitData.code === 200 ? 'success' : 'error');
                    
                    // 3. 关键差异分析
                    log('📊 3. 关键差异分析:', 'info');
                    log(`   - 登录方法: GET vs 数据提交方法: POST`, 'info');
                    log(`   - 登录参数: URL参数 vs 数据提交: JSON Body`, 'info');
                    log(`   - 登录路径: /stu/login vs 数据提交: /stu/submitPageMarkData`, 'info');
                    
                    if (submitData.code === 401) {
                        log('🔍 Session验证失败分析:', 'warning');
                        log('   可能原因1: POST请求的Session验证逻辑与GET不同', 'warning');
                        log('   可能原因2: 路径/stu/submitPageMarkData需要额外认证', 'warning');
                        log('   可能原因3: JSON请求体需要特殊处理', 'warning');
                    }
                    
                } else {
                    log(`   ❌ 登录失败: ${loginData.msg}`, 'error');
                }
                
            } catch (error) {
                log(`🚫 API对比错误: ${error.message}`, 'error');
            }
        }

        // 测试Cookie作用域问题
        async function testCookieScopeIssues() {
            log('🍪 测试Cookie作用域问题...', 'info');
            
            log('📋 Cookie作用域分析:', 'info');
            log(`   - 当前页面路径: ${location.pathname}`, 'info');
            log(`   - 登录API路径: /stu/login`, 'info');
            log(`   - 数据提交API路径: /stu/submitPageMarkData`, 'info');
            
            // 测试不同路径的请求
            const testPaths = [
                '/stu/login',
                '/stu/submitPageMarkData',
                '/stu/',
                '/stu'
            ];
            
            for (const path of testPaths) {
                try {
                    log(`🧪 测试路径: ${path}`, 'info');
                    
                    const response = await fetch(`${path}?test=scope`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    log(`   状态: ${response.status}`, response.status === 200 ? 'success' : 'warning');
                    
                } catch (error) {
                    log(`   错误: ${error.message}`, 'warning');
                }
            }
            
            log('💡 Cookie作用域建议:', 'info');
            log('   - 如果某些路径无法访问，可能是Cookie作用域问题', 'info');
            log('   - JSESSIONID可能只对特定路径有效', 'info');
        }

        // 测试额外认证参数
        async function testWithExtraAuthParams() {
            log('🔐 测试额外认证参数...', 'info');
            
            const batchCode = document.getElementById('batchCode').value;
            const examNo = document.getElementById('examNo').value;

            if (!batchCode || !examNo) {
                log('❌ 请先登录获取批次号和考号', 'error');
                return;
            }

            const basePayload = {
                batchCode: batchCode,
                examNo: examNo,
                mark: {
                    pageNumber: "1",
                    pageDesc: "认证参数测试",
                    operationList: [],
                    answerList: [],
                    beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    imgList: []
                }
            };

            // 测试不同的认证参数组合
            const testCases = [
                {
                    name: '基础请求',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    url: '/stu/submitPageMarkData'
                },
                {
                    name: '携带认证参数的URL',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    url: `/stu/submitPageMarkData?batchCode=${batchCode}&examNo=${examNo}`
                },
                {
                    name: '额外请求头',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Batch-Code': batchCode,
                        'X-Exam-No': examNo,
                        'Authorization': `Bearer ${batchCode}-${examNo}`
                    },
                    url: '/stu/submitPageMarkData'
                },
                {
                    name: '模拟浏览器请求头',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'zh-CN,zh;q=0.9',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Sec-Fetch-Dest': 'empty',
                        'Sec-Fetch-Mode': 'cors',
                        'Sec-Fetch-Site': 'same-origin'
                    },
                    url: '/stu/submitPageMarkData'
                }
            ];

            for (const testCase of testCases) {
                try {
                    log(`🧪 测试: ${testCase.name}`, 'info');
                    
                    const response = await fetch(testCase.url, {
                        method: 'POST',
                        headers: testCase.headers,
                        credentials: 'include',
                        body: JSON.stringify(basePayload)
                    });

                    const responseData = await response.json();
                    log(`   结果: ${JSON.stringify(responseData)}`, 
                        responseData.code === 200 ? 'success' : 'warning');

                    if (responseData.code === 200) {
                        log(`🎉 成功！${testCase.name} 有效！`, 'success');
                        return; // 找到有效方法就停止
                    }

                } catch (error) {
                    log(`   错误: ${error.message}`, 'error');
                }
            }
            
            log('❌ 所有认证参数测试都失败', 'error');
        }

        // 连续调用测试
        async function testSequentialCalls() {
            log('⚡ 执行连续调用测试...', 'info');
            
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('❌ 请输入账号和密码', 'error');
                return;
            }

            try {
                const encryptedPassword = encryptPassword(password);
                
                // 1. 登录
                log('1️⃣ 执行登录...', 'info');
                const loginResponse = await fetch(`/stu/login?accountName=${accountName}&accountPass=${encodeURIComponent(encryptedPassword)}&type=2`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                
                const loginData = await loginResponse.json();
                
                if (loginData.code !== 200) {
                    log(`❌ 登录失败: ${loginData.msg}`, 'error');
                    return;
                }
                
                log('✅ 登录成功', 'success');
                
                // 2. 立即提交（0延迟）
                log('2️⃣ 立即提交数据（0秒延迟）...', 'info');
                
                const payload = {
                    batchCode: loginData.obj.batchCode,
                    examNo: loginData.obj.examNo,
                    mark: {
                        pageNumber: "1",
                        pageDesc: "连续调用测试",
                        operationList: [],
                        answerList: [],
                        beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                        endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                        imgList: []
                    }
                };
                
                const submitResponse = await fetch('/stu/submitPageMarkData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const submitData = await submitResponse.json();
                log(`结果: ${JSON.stringify(submitData)}`, submitData.code === 200 ? 'success' : 'error');
                
                if (submitData.code === 401) {
                    log('🔍 分析：即使0延迟仍然失败', 'warning');
                    log('💡 这说明问题不在时间，而在Session验证逻辑本身', 'warning');
                    
                    // 尝试再次登录后立即使用相同Session
                    log('3️⃣ 测试Session复用...', 'info');
                    
                    const retryResponse = await fetch('/stu/submitPageMarkData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });
                    
                    const retryData = await retryResponse.json();
                    log(`Session复用结果: ${JSON.stringify(retryData)}`, retryData.code === 200 ? 'success' : 'error');
                }
                
            } catch (error) {
                log(`🚫 连续调用测试错误: ${error.message}`, 'error');
            }
        }

        // 测试不同Content-Type
        async function testDifferentContentTypes() {
            log('📝 测试不同Content-Type...', 'info');
            
            const batchCode = document.getElementById('batchCode').value;
            const examNo = document.getElementById('examNo').value;

            if (!batchCode || !examNo) {
                log('❌ 请先登录', 'error');
                return;
            }

            const payload = {
                batchCode: batchCode,
                examNo: examNo,
                mark: {
                    pageNumber: "1",
                    pageDesc: "Content-Type测试",
                    operationList: [],
                    answerList: [],
                    beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    imgList: []
                }
            };

            const contentTypes = [
                'application/json',
                'application/json; charset=utf-8',
                'text/plain',
                'application/x-www-form-urlencoded'
            ];

            for (const contentType of contentTypes) {
                try {
                    log(`🧪 测试Content-Type: ${contentType}`, 'info');
                    
                    let body;
                    if (contentType === 'application/x-www-form-urlencoded') {
                        body = new URLSearchParams({
                            data: JSON.stringify(payload)
                        }).toString();
                    } else {
                        body = JSON.stringify(payload);
                    }
                    
                    const response = await fetch('/stu/submitPageMarkData', {
                        method: 'POST',
                        headers: { 'Content-Type': contentType },
                        credentials: 'include',
                        body: body
                    });

                    const responseData = await response.json();
                    log(`   结果: ${JSON.stringify(responseData)}`, 
                        responseData.code === 200 ? 'success' : 'warning');

                } catch (error) {
                    log(`   错误: ${error.message}`, 'error');
                }
            }
        }

        // 同请求测试两个API
        async function testBothAPIsWithSameRequest() {
            log('🔄 用相同请求测试两个API...', 'info');
            
            const testPayload = { test: 'session-check' };
            
            try {
                // 测试登录API
                log('1️⃣ 测试登录API接受POST请求...', 'info');
                const loginResponse = await fetch('/stu/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testPayload)
                });
                
                log(`   登录API POST状态: ${loginResponse.status}`, 'info');
                
                // 测试数据提交API
                log('2️⃣ 测试数据提交API...', 'info');
                const submitResponse = await fetch('/stu/submitPageMarkData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testPayload)
                });
                
                log(`   数据提交API状态: ${submitResponse.status}`, 'info');
                
                // 分析差异
                if (loginResponse.status !== submitResponse.status) {
                    log('🔍 发现API响应差异！', 'warning');
                    log(`   登录API: ${loginResponse.status} vs 数据提交API: ${submitResponse.status}`, 'warning');
                }
                
            } catch (error) {
                log(`🚫 同请求测试错误: ${error.message}`, 'error');
            }
        }

        // 页面初始化
        window.addEventListener('DOMContentLoaded', function() {
            log('🔬 Session验证失败专家诊断工具已就绪');
            log('💡 关键问题：登录后立即提交仍然401');
            log('🎯 诊断重点：Session存储机制、Cookie作用域、API验证差异');
            log('📝 建议：点击"执行专家级全面诊断"开始深入分析');
        });
    </script>
</body>
</html> 