<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ ä»£ç†é…ç½®ä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input { width: 300px; padding: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a99; }
        .log { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .warning { color: #f57c00; font-weight: bold; }
        .info { color: #1976d2; }
        .fix { background: #e8f5e8; border: 2px solid #4caf50; padding: 15px; margin: 10px 0; }
        .test { background: #fff3e0; border: 1px solid #ff9800; padding: 15px; margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
</head>
<body>
    <h1>ğŸ¯ ä»£ç†é…ç½®ä¿®å¤éªŒè¯</h1>
    
    <div class="fix">
        <h3>âœ… å·²åº”ç”¨çš„ä¿®å¤</h3>
        <p><strong>1. changeOrigin: true</strong> - ç¡®ä¿Hostå¤´æ­£ç¡®å¤„ç†</p>
        <p><strong>2. Content-Typeå¤´è½¬å‘</strong> - ç¡®ä¿application/jsonæ­£ç¡®ä¼ é€’</p>
        <p><strong>3. å¢å¼ºCookieå¤„ç†</strong> - ä¼˜åŒ–Sessionæœºåˆ¶</p>
        <p><strong>4. CORSå‡­æ®æ”¯æŒ</strong> - è®¾ç½®Access-Control-Allow-Credentials</p>
    </div>
    
    <div class="test">
        <h3>ğŸ§ª éªŒè¯æµ‹è¯•</h3>
        <button onclick="performComprehensiveTest()">ğŸ¯ æ‰§è¡Œå®Œæ•´éªŒè¯</button>
        <button onclick="testLoginDataSubmitFlow()">âš¡ æµ‹è¯•ç™»å½•â†’æ•°æ®æäº¤æµç¨‹</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="form-group">
        <label for="accountName">è´¦å·åç§°:</label>
        <input type="text" id="accountName" value="3004">
    </div>
    
    <div class="form-group">
        <label for="password">å¯†ç :</label>
        <input type="password" id="password" value="1234">
    </div>
    
    <div class="log" id="log">
        <div>ğŸ¯ ä»£ç†é…ç½®ä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª</div>
        <div>âœ… åº”ç”¨äº†åç«¯å»ºè®®çš„å…³é”®ä¿®å¤</div>
        <div>ğŸ” é‡ç‚¹éªŒè¯ï¼šchangeOrigin + Content-Typeå¤´å¤„ç†</div>
    </div>

    <script>
        const PUBLIC_KEY = 'MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM5b2W+KjQrLMIJPLaINGAd7KCt5cRq5tLoioe6L3MdyUI9E9wwkZeRD92Aqp4AFR9GrUy1Yw9vuDfShaDcEjbsCAwEAAQ==';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' :
                            type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>ğŸ¯ æ—¥å¿—å·²æ¸…ç©ºï¼Œä¿®å¤éªŒè¯å·¥å…·å°±ç»ª</div>';
        }

        function encryptPassword(password) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(PUBLIC_KEY);
                const encrypted = encrypt.encrypt(password);
                if (!encrypted || encrypted === 'false') {
                    throw new Error('åŠ å¯†å¤±è´¥');
                }
                return encrypted;
            } catch (error) {
                throw new Error('å¯†ç åŠ å¯†å¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œå®Œæ•´éªŒè¯
        async function performComprehensiveTest() {
            log('ğŸ¯ å¼€å§‹å®Œæ•´éªŒè¯æµ‹è¯•...', 'info');
            log('', 'info');
            
            log('ğŸ“‹ éªŒè¯1: åŸºç¡€ç¯å¢ƒæ£€æŸ¥', 'info');
            log(`   - å½“å‰æ—¶é—´: ${new Date().toLocaleString()}`, 'info');
            log(`   - é¡µé¢URL: ${location.href}`, 'info');
            log(`   - ä»£ç†é…ç½®: å·²åº”ç”¨changeOriginå’ŒContent-Typeä¿®å¤`, 'success');
            
            log('ğŸ“‹ éªŒè¯2: è¯·æ±‚å¤´åˆ†æ', 'info');
            
            // æµ‹è¯•è¯·æ±‚å¤´è®¾ç½®
            const testHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            };
            
            log(`   æµ‹è¯•è¯·æ±‚å¤´: ${JSON.stringify(testHeaders, null, 2)}`, 'info');
            
            log('ğŸ“‹ éªŒè¯3: Cookieæœºåˆ¶æ£€æŸ¥', 'info');
            const visibleCookies = document.cookie;
            log(`   JavaScriptå¯è§Cookie: ${visibleCookies || 'æ— '}`, 'info');
            log(`   HttpOnly JSESSIONID: ç¡®è®¤å­˜åœ¨ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æºå¸¦ï¼‰`, 'success');
            
            // æ‰§è¡Œå®Œæ•´çš„ç™»å½•å’Œæ•°æ®æäº¤æµ‹è¯•
            await testLoginDataSubmitFlow();
        }

        // æµ‹è¯•ç™»å½•â†’æ•°æ®æäº¤æµç¨‹
        async function testLoginDataSubmitFlow() {
            log('âš¡ æµ‹è¯•ç™»å½•â†’æ•°æ®æäº¤å®Œæ•´æµç¨‹...', 'info');
            log('', 'info');
            
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('âŒ è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }

            try {
                // æ­¥éª¤1: ç™»å½•
                log('1ï¸âƒ£ æ‰§è¡Œç™»å½•ï¼ˆä¿®å¤åï¼‰...', 'info');
                
                const encryptedPassword = encryptPassword(password);
                
                const loginUrl = `/stu/login?accountName=${accountName}&accountPass=${encodeURIComponent(encryptedPassword)}&type=2`;
                
                const loginResponse = await fetch(loginUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                log(`   ç™»å½•å“åº”çŠ¶æ€: ${loginResponse.status}`, loginResponse.status === 200 ? 'success' : 'error');
                
                // åˆ†æå“åº”å¤´
                log('   å“åº”å¤´åˆ†æ:', 'info');
                for (let [key, value] of loginResponse.headers.entries()) {
                    log(`     ${key}: ${value}`, 'info');
                }

                const loginData = await loginResponse.json();
                
                if (loginData.code === 200) {
                    log('   âœ… ç™»å½•æˆåŠŸï¼', 'success');
                    log(`   ğŸ“‹ æ‰¹æ¬¡å·: ${loginData.obj.batchCode}`, 'info');
                    log(`   ğŸ“ è€ƒå·: ${loginData.obj.examNo}`, 'info');
                    log(`   ğŸ‘¤ å­¦ç”Ÿ: ${loginData.obj.studentName}`, 'info');
                    
                    // æ­¥éª¤2: ç«‹å³æ•°æ®æäº¤ï¼ˆå…³é”®æµ‹è¯•ï¼‰
                    log('', 'info');
                    log('2ï¸âƒ£ ç«‹å³æ•°æ®æäº¤ï¼ˆå…³é”®æµ‹è¯•ï¼‰...', 'info');
                    
                    const payload = {
                        batchCode: loginData.obj.batchCode,
                        examNo: loginData.obj.examNo,
                        mark: {
                            pageNumber: "1",
                            pageDesc: "ä¿®å¤éªŒè¯æµ‹è¯•",
                            operationList: [
                                {
                                    code: 1,
                                    targetElement: "ä¿®å¤éªŒè¯æŒ‰é’®",
                                    value: "æµ‹è¯•ä¿®å¤æ•ˆæœ",
                                    eventType: "click",
                                    time: new Date().toISOString().replace('T', ' ').substring(0, 19)
                                }
                            ],
                            answerList: [
                                {
                                    code: 1,
                                    targetElement: "ä¿®å¤ç¡®è®¤",
                                    value: true
                                }
                            ],
                            beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                            endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                            imgList: []
                        }
                    };
                    
                    log(`   è¯·æ±‚æ•°æ®: ${JSON.stringify(payload, null, 2)}`, 'info');
                    
                    const submitResponse = await fetch('/stu/submitPageMarkData', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // ğŸ”‘ å…³é”®ä¿®å¤
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    log(`   æ•°æ®æäº¤çŠ¶æ€: ${submitResponse.status}`, 'info');
                    
                    // åˆ†æå“åº”å¤´
                    log('   æ•°æ®æäº¤å“åº”å¤´:', 'info');
                    for (let [key, value] of submitResponse.headers.entries()) {
                        log(`     ${key}: ${value}`, 'info');
                    }

                    const submitData = await submitResponse.json();
                    log(`   å“åº”æ•°æ®: ${JSON.stringify(submitData)}`, 'info');

                    if (submitData.code === 200) {
                        log('', 'success');
                        log('ğŸ‰ğŸ‰ğŸ‰ ä¿®å¤æˆåŠŸï¼æ•°æ®æäº¤æ­£å¸¸ï¼ğŸ‰ğŸ‰ğŸ‰', 'success');
                        log('âœ… Sessionæœºåˆ¶å®Œå…¨æ­£å¸¸å·¥ä½œ', 'success');
                        log('âœ… ä»£ç†é…ç½®ä¿®å¤æœ‰æ•ˆ', 'success');
                        log('âœ… é¡¹ç›®é—®é¢˜å½»åº•è§£å†³', 'success');
                        
                    } else if (submitData.code === 401) {
                        log('âŒ ä»ç„¶401é”™è¯¯ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥', 'error');
                        log(`   é”™è¯¯ä¿¡æ¯: ${submitData.msg}`, 'error');
                        
                        // è¿›ä¸€æ­¥è¯Šæ–­
                        log('ğŸ” è¿›ä¸€æ­¥è¯Šæ–­å»ºè®®:', 'warning');
                        log('   1. æ£€æŸ¥åç«¯Sessionå­˜å‚¨æœºåˆ¶', 'warning');
                        log('   2. ç¡®è®¤APIè·¯å¾„æƒé™é…ç½®', 'warning');
                        log('   3. è”ç³»åç«¯å¼€å‘äººå‘˜æ·±å…¥åˆ†æ', 'warning');
                        
                    } else {
                        log(`âŒ å…¶ä»–é”™è¯¯: ${submitData.msg}`, 'error');
                    }

                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${loginData.msg}`, 'error');
                    return;
                }

            } catch (error) {
                log(`ğŸš« æµ‹è¯•è¿‡ç¨‹é”™è¯¯: ${error.message}`, 'error');
                console.error('å®Œæ•´æµ‹è¯•é”™è¯¯:', error);
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸ¯ ä»£ç†é…ç½®ä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª');
            log('âœ… å·²åº”ç”¨åç«¯å»ºè®®çš„å…³é”®ä¿®å¤');
            log('ğŸ“ å»ºè®®ï¼šç‚¹å‡»"æ‰§è¡Œå®Œæ•´éªŒè¯"æµ‹è¯•ä¿®å¤æ•ˆæœ');
        });
    </script>
</body>
</html> 