<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ APIä¿®å¤éªŒè¯å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a99; }
        .log { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 700px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .warning { color: #f57c00; font-weight: bold; }
        .info { color: #1976d2; }
        .critical { background: #ffebee; border: 2px solid #f44336; padding: 15px; margin: 10px 0; }
        .success-box { background: #e8f5e8; border: 2px solid #4caf50; padding: 15px; margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
</head>
<body>
    <h1>ğŸ”§ APIä¿®å¤éªŒè¯å·¥å…·</h1>
    
    <div class="success-box">
        <h3>ğŸ¯ ä¿®å¤å†…å®¹</h3>
        <p><strong>ä¿®å¤1ï¼š</strong>APIç«¯ç‚¹ä» <code>/submitPageMarkData</code> æ”¹ä¸º <code>/saveHcMark</code></p>
        <p><strong>ä¿®å¤2ï¼š</strong>æ•°æ®æ ¼å¼ä»JSONæ”¹ä¸ºFormData</p>
        <p><strong>ä¾æ®ï¼š</strong>å‰ç«¯APIè§„èŒƒæ–‡æ¡£ä¸­å®šä¹‰çš„æ­£ç¡®æ¥å£</p>
    </div>
    
    <div class="form-group">
        <label for="accountName">è´¦å·åç§°:</label>
        <input type="text" id="accountName" value="3004">
    </div>
    
    <div class="form-group">
        <label for="password">å¯†ç :</label>
        <input type="password" id="password" value="1234">
    </div>
    
    <div class="form-group">
        <label for="batchCode">æ‰¹æ¬¡å·:</label>
        <input type="text" id="batchCode" placeholder="ç™»å½•åè‡ªåŠ¨å¡«å……">
    </div>
    
    <div class="form-group">
        <label for="examNo">è€ƒå·:</label>
        <input type="text" id="examNo" placeholder="ç™»å½•åè‡ªåŠ¨å¡«å……">
    </div>
    
    <div class="form-group">
        <button onclick="testCorrectedAPI()">ğŸ”§ æµ‹è¯•ä¿®æ­£åçš„API</button>
        <button onclick="compareAPIs()">ğŸ“Š å¯¹æ¯”æ–°æ—§API</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="log" id="log">
        <div>ğŸ”§ APIä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª</div>
        <div>ğŸ¯ ç›®æ ‡ï¼šéªŒè¯ä½¿ç”¨æ­£ç¡®çš„saveHcMark APIå’ŒFormDataæ ¼å¼</div>
        <div>ğŸ“‹ é¢„æœŸï¼šè§£å†³401 sessionè¿‡æœŸé—®é¢˜</div>
    </div>

    <script>
        const PUBLIC_KEY = 'MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM5b2W+KjQrLMIJPLaINGAd7KCt5cRq5tLoioe6L3MdyUI9E9wwkZeRD92Aqp4AFR9GrUy1Yw9vuDfShaDcEjbsCAwEAAQ==';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' :
                            type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>ğŸ”§ æ—¥å¿—å·²æ¸…ç©ºï¼ŒAPIä¿®å¤éªŒè¯å·¥å…·å°±ç»ª</div>';
        }

        function encryptPassword(password) {
            try {
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(PUBLIC_KEY);
                const encrypted = encrypt.encrypt(password);
                if (!encrypted || encrypted === 'false') {
                    throw new Error('åŠ å¯†å¤±è´¥');
                }
                return encrypted;
            } catch (error) {
                throw new Error('å¯†ç åŠ å¯†å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•ä¿®æ­£åçš„API
        async function testCorrectedAPI() {
            log('ğŸ”§ å¼€å§‹æµ‹è¯•ä¿®æ­£åçš„API...', 'info');
            
            const accountName = document.getElementById('accountName').value;
            const password = document.getElementById('password').value;

            if (!accountName || !password) {
                log('âŒ è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }

            try {
                // 1. ç™»å½•
                log('1ï¸âƒ£ æ‰§è¡Œç™»å½•...', 'info');
                const encryptedPassword = encryptPassword(password);
                
                const loginResponse = await fetch(`/stu/login?accountName=${accountName}&accountPass=${encodeURIComponent(encryptedPassword)}&type=2`, {
                    method: 'GET',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const loginData = await loginResponse.json();
                
                if (loginData.code !== 200) {
                    log(`âŒ ç™»å½•å¤±è´¥: ${loginData.msg}`, 'error');
                    return;
                }
                
                log('âœ… ç™»å½•æˆåŠŸ', 'success');
                log(`ğŸ“‹ æ‰¹æ¬¡å·: ${loginData.obj.batchCode}`, 'info');
                log(`ğŸ“ è€ƒå·: ${loginData.obj.examNo}`, 'info');
                
                // å¡«å……è¡¨å•
                document.getElementById('batchCode').value = loginData.obj.batchCode;
                document.getElementById('examNo').value = loginData.obj.examNo;
                
                // 2. ä½¿ç”¨ä¿®æ­£åçš„APIæäº¤æ•°æ®
                log('2ï¸âƒ£ ä½¿ç”¨ä¿®æ­£åçš„saveHcMark API...', 'info');
                
                // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨FormDataæ ¼å¼
                const formData = new FormData();
                formData.append('batchCode', loginData.obj.batchCode);
                formData.append('examNo', loginData.obj.examNo);
                
                const markData = {
                    pageNumber: "1",
                    pageDesc: "APIä¿®å¤éªŒè¯æµ‹è¯•",
                    operationList: [
                        {
                            code: 1,
                            targetElement: "ä¿®å¤éªŒè¯æŒ‰é’®",
                            value: "æµ‹è¯•ä¿®å¤æ•ˆæœ",
                            eventType: "click",
                            time: new Date().toISOString().replace('T', ' ').substring(0, 19)
                        }
                    ],
                    answerList: [
                        {
                            code: 1,
                            targetElement: "ä¿®å¤ç¡®è®¤",
                            value: true
                        }
                    ],
                    beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    imgList: []
                };
                
                formData.append('mark', JSON.stringify(markData));
                
                log('ğŸ“¤ FormDataå†…å®¹:', 'info');
                log(`   - batchCode: ${loginData.obj.batchCode}`, 'info');
                log(`   - examNo: ${loginData.obj.examNo}`, 'info');
                log(`   - mark: ${JSON.stringify(markData)}`, 'info');
                
                // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                const submitResponse = await fetch('/stu/saveHcMark', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData // ğŸ”‘ ä½¿ç”¨FormDataè€Œä¸æ˜¯JSON
                });
                
                log(`æ•°æ®æäº¤çŠ¶æ€: ${submitResponse.status}`, 'info');
                
                const submitData = await submitResponse.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(submitData)}`, 
                    submitData.code === 200 ? 'success' : 'error');
                
                if (submitData.code === 200) {
                    log('ğŸ‰ ä¿®å¤æˆåŠŸï¼ä½¿ç”¨saveHcMark APIå’ŒFormDataæ ¼å¼å·¥ä½œæ­£å¸¸ï¼', 'success');
                } else {
                    log(`âŒ ä»ç„¶å¤±è´¥: ${submitData.msg}`, 'error');
                }
                
            } catch (error) {
                log(`ğŸš« æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // å¯¹æ¯”æ–°æ—§API
        async function compareAPIs() {
            log('ğŸ“Š å¼€å§‹å¯¹æ¯”æ–°æ—§API...', 'info');
            
            const batchCode = document.getElementById('batchCode').value;
            const examNo = document.getElementById('examNo').value;

            if (!batchCode || !examNo) {
                log('âŒ è¯·å…ˆç™»å½•è·å–æ‰¹æ¬¡å·å’Œè€ƒå·', 'error');
                return;
            }

            const testData = {
                batchCode: batchCode,
                examNo: examNo,
                mark: {
                    pageNumber: "1",
                    pageDesc: "APIå¯¹æ¯”æµ‹è¯•",
                    operationList: [],
                    answerList: [],
                    beginTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    endTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    imgList: []
                }
            };

            try {
                // æµ‹è¯•æ—§API (submitPageMarkData + JSON)
                log('ğŸ” æµ‹è¯•æ—§API: submitPageMarkData + JSON', 'warning');
                const oldResponse = await fetch('/stu/submitPageMarkData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                
                const oldData = await oldResponse.json();
                log(`   æ—§APIç»“æœ: ${JSON.stringify(oldData)}`, oldData.code === 200 ? 'success' : 'warning');
                
                // æµ‹è¯•æ–°API (saveHcMark + FormData)
                log('ğŸ”§ æµ‹è¯•æ–°API: saveHcMark + FormData', 'info');
                const formData = new FormData();
                formData.append('batchCode', testData.batchCode);
                formData.append('examNo', testData.examNo);
                formData.append('mark', JSON.stringify(testData.mark));
                
                const newResponse = await fetch('/stu/saveHcMark', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const newData = await newResponse.json();
                log(`   æ–°APIç»“æœ: ${JSON.stringify(newData)}`, newData.code === 200 ? 'success' : 'warning');
                
                // å¯¹æ¯”ç»“æœ
                log('ğŸ“Š å¯¹æ¯”ç»“æœ:', 'info');
                if (oldData.code === 200 && newData.code === 200) {
                    log('   ğŸ‰ ä¸¤ä¸ªAPIéƒ½æˆåŠŸï¼', 'success');
                } else if (oldData.code !== 200 && newData.code === 200) {
                    log('   âœ… æ–°APIä¿®å¤äº†é—®é¢˜ï¼', 'success');
                } else if (oldData.code === 200 && newData.code !== 200) {
                    log('   âš ï¸ æ—§APIæœ‰æ•ˆï¼Œæ–°APIéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•', 'warning');
                } else {
                    log('   âŒ ä¸¤ä¸ªAPIéƒ½å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ†æ', 'error');
                }
                
            } catch (error) {
                log(`ğŸš« å¯¹æ¯”æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ APIä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª');
            log('ğŸ’¡ å…³é”®ä¿®å¤ï¼šä½¿ç”¨saveHcMark API + FormDataæ ¼å¼');
            log('ğŸ“ å»ºè®®ï¼šç‚¹å‡»"æµ‹è¯•ä¿®æ­£åçš„API"éªŒè¯ä¿®å¤æ•ˆæœ');
        });
    </script>
</body>
</html>