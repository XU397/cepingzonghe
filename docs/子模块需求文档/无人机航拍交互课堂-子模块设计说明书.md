# 无人机航拍交互课堂 - 子模块设计说明书

> 基于《子模块设计说明书模板》v1.0 编制
> 创建日期：2025-11-19
> 修订日期：2025-11-19
> 版本：1.0.2
> 修订说明：
> - v1.0.1：根据QA审查意见修复事件枚举、时间格式、技术栈等规范对齐问题
> - v1.0.2：对齐现有 EventTypes 枚举，修正 formatTimestamp 路径，明确需扩展事件落地任务

---

## 1. 基本信息（Basic Info）

- **子模块名称（中文）**：无人机航拍交互课堂

- **子模块标识 `submoduleId`（唯一，kebab-case）**：`g8-drone-imaging`
  - 命名说明：g8 表示8年级，drone-imaging 表示无人机成像实验

- **显示名称 `displayName`**：`8年级无人机航拍-交互实验`

- **版本号 `version`**：`1.0.0`

- **适用年级 / 学科 / 场景**：八年级 / 物理 / 探究实验：无人机成像与地面采样距离

- **业务目标（简要描述）**：
  - 评估学生在信息理解、变量控制、实验操作、数据分析和综合总结等方面的科学探究能力
  - 作为前置测试模块，快速检测学生的基础实验素养

- **所属 Flow 类型**：前置实验步骤
  - 说明：本子模块作为 Flow 的前置实验步骤，后续将衔接7年级蒸馒头模块
  - 总时长：20分钟

---

## 2. 运行环境与全局约束（Runtime & Global Constraints）

- **运行容器**：
  - 子模块 **必须** 运行在统一页面框架中：
    - 外壳：`AssessmentPageFrame`（导航 + 计时 + 主体 + 下一页按钮 + 错误托盘）
    - 左侧导航：`LeftStepperNav`
  - 子模块 **不得** 自行实现：全局导航、计时器、错误托盘、顶栏布局等

- **技术栈约束**：
  - 前端框架：React 18 + TypeScript（优先使用 TS，如有特殊原因才用 JS）
  - 构建工具：Vite 4（由项目统一配置）
  - 风格规范：遵守项目现有 ESLint + Prettier 配置
  - 样式方案：CSS Modules（`*.module.css`）
  - 类型定义：遵循 `src/shared/types/flow.ts` 中的 `SubmoduleDefinition`

- **禁止直接操作的能力（必须通过统一封装）**：
  - 路由跳转：**必须** 使用容器提供的 `onNext` 等回调
  - 本地存储：**必须** 使用 `module.g8-drone-imaging.*` 命名空间
  - 会话处理：**必须** 交由统一的 `handleSessionExpired`
  - API调用：通过统一 `apiService` 层

- **支持环境假设**：
  - 子模块可以假定：
    - 已存在 `userContext`（含 `examNo`、`batchCode`、`flowId` 等）
    - Flow 容器会传入 `initialPageId`，无需自行解析 URL
    - 全局错误捕获与日志系统已启用

---

## 3. CMI 接口定义与导出规范（CMI Definition）

### 3.1 TypeScript 接口示意

```ts
// 参考 src/shared/types/flow.ts 中的 SubmoduleDefinition
export interface G8DroneImagingSubmodule extends SubmoduleDefinition {
  submoduleId: 'g8-drone-imaging';
  displayName: '8年级无人机航拍-交互实验';
  version: '1.0.0';

  Component: (props: SubmoduleComponentProps) => React.ReactNode;

  getInitialPage(subPageNum: string): string; // 返回 pageId
  getTotalSteps(): number; // 返回 6（不含封面页）
  getNavigationMode(pageId: string): 'experiment' | 'questionnaire' | 'hidden';

  getDefaultTimers: () => ({
    task: 20 * 60, // 20分钟
  });

  onInitialize?: () => void;
  onDestroy?: () => void;
}
```

### 3.2 导出位置与命名

- **实际导出文件路径**：`src/submodules/g8-drone-imaging/index.tsx`
- **导出对象名称**：
  ```typescript
  export const G8DroneImagingSubmodule: SubmoduleDefinition = {
    submoduleId: 'g8-drone-imaging',
    displayName: '8年级无人机航拍-交互实验',
    version: '1.0.0',
    // ... 其他字段
  };
  ```
- **命名规范**：遵循现有模式（如 `G7ExperimentSubmodule`），大写开头

### 3.3 目录结构

```text
src/submodules/g8-drone-imaging/
  index.tsx               # 导出 SubmoduleDefinition
  Component.tsx           # 子模块主组件 (props: SubmoduleProps)
  mapping.ts              # subPageNum <-> pageId 映射 & getNavigationMode
  context/
    DroneImagingContext.tsx  # 子模块状态管理
  pages/
    Page01_Cover.tsx           # 任务封面
    Page02_Background.tsx      # 背景知识介绍
    Page03_Hypothesis.tsx      # 实验步骤与假设思考
    Page04_Experiment.tsx      # 无人机航拍模拟实验
    Page05_FocalAnalysis.tsx   # 实验数据分析-焦距影响
    Page06_HeightAnalysis.tsx  # 实验数据分析-高度影响
    Page07_Conclusion.tsx      # 综合结论与应用
  components/
    DroneSimulator.tsx        # 无人机航拍模拟器组件
    GSDDisplay.tsx            # GSD数值显示组件
    HeightSelector.tsx        # 高度选择器
    FocalLengthSelector.tsx   # 焦距选择器
    BlurredImage.tsx          # 模糊度可控的图片组件
  utils/
    gsdLookup.ts              # GSD数据查找表
  styles/
    Page01_Cover.module.css
    Page02_Background.module.css
    Page03_Hypothesis.module.css
    Page04_Experiment.module.css
    Page05_FocalAnalysis.module.css
    Page06_HeightAnalysis.module.css
    Page07_Conclusion.module.css
    DroneSimulator.module.css
  assets/
    images/                   # 无人机图片、航拍示例图等
```

---

## 4. 页面模型与导航设计（Pages & Navigation）

### 4.1 页面列表

| subPageNum | pageId | 类型（type） | 导航模式（navigationMode） | 说明（业务含义） |
|-----------:|--------|-------------|---------------------------|-----------------|
| 1 | `cover` | `notice` | `hidden` | 任务封面页（导航隐藏） |
| 2 | `background` | `experiment` | `experiment` | 背景知识介绍 |
| 3 | `hypothesis` | `experiment` | `experiment` | 实验步骤与假设思考（含文本输入） |
| 4 | `experiment_free` | `experiment` | `experiment` | 无人机航拍模拟实验（自由探究） |
| 5 | `focal_analysis` | `experiment` | `experiment` | 实验数据分析-焦距影响（含选择题） |
| 6 | `height_analysis` | `experiment` | `experiment` | 实验数据分析-高度影响（含选择题） |
| 7 | `conclusion` | `experiment` | `experiment` | 综合结论与应用（混合输入） |

### 4.1.1 页面级交互细节

**Page 1 - 任务封面（注意事项确认）**

- 页面用途：在正式进入答题前，让学生阅读并确认本科学探究的注意事项。
- 文案内容：
  - 标题：`注意事项`
  - 标题下方显示醒目的提示文案：`请仔细阅读`
  - 注意事项内容以列表形式展示，文案为：
    - 本科学探究共20分钟，时间结束后，系统将自动退出答题界面。
    - 请按顺序回答每页问题，上一页题目未完成作答，将无法点击进入下一页。
    - 答题时，不要提前点击"下一页"查看后面的内容，否则将无法返回上一页。
    - 遇到系统故障、死机、死循环等特殊情况时，请举手示意老师。
- 确认区布局（参考设计稿截图）：
  - 页面下方使用浅蓝色背景的确认区域，上方为注意事项卡片，下方为确认区域。
  - 确认区域左侧为复选框，文案为：`我已阅读并理解上述注意事项`。
  - 复选框右侧为提示按钮/标签，文案为：`请仔细阅读注意事项，38秒后可勾选确认。`，并承载 30 秒倒计时（从进入本页起计时）。
- 交互与限制：
  - 页面加载时，复选框处于禁用状态；倒计时 30 秒结束后复选框才变为可点击。
  - `"下一页"` 按钮在复选框勾选前保持禁用，只有在 **倒计时结束且学生勾选复选框** 后才允许点击进入下一页。
  - 本页不采集答题数据，仅记录 Page Enter / Page Exit 等基础事件和必要的阅读/确认事件。


**Page 3 - 实验步骤与假设思考**

| 控件类型 | questionId | targetElement | 必填规则 | 说明 |
|---------|-----------|---------------|---------|------|
| Textarea | Q3_1 | `P3_控制变量理由` | 长度 > 5 字符 | 问题1：为什么需要确保参数一致 |

**Page 4 - 无人机航拍模拟实验（自由探究）**

| 控件类型 | 控件ID | targetElement | 说明 |
|---------|--------|---------------|------|
| ButtonGroup | height_selector | `height_selector` | 高度选择：100/200/300米 |
| ButtonGroup | focal_selector | `focal_selector` | 焦距选择：8/24/50mm |
| Button | start_btn | `experiment_panel` | 开始拍照 |
| Button | reset_btn | `reset_button` | 重置实验 |
| Display | gsd_display | `gsd_display` | GSD数值显示 |

**Page 5 - 实验数据分析-焦距影响**

| 控件类型 | questionId | targetElement | 必填规则 | 选项 | 正确答案 |
|---------|-----------|---------------|---------|------|---------|
| RadioGroup | Q5_1 | `P5_最小GSD焦距` | 必选 | A. 8毫米 / B. 24毫米 / C. 50毫米 | C |

**Page 6 - 实验数据分析-高度影响**

| 控件类型 | questionId | targetElement | 必填规则 | 选项 | 正确答案 |
|---------|-----------|---------------|---------|------|---------|
| RadioGroup | Q6_1 | `P6_GSD变化趋势` | 必选 | A. 逐渐升高 / B. 逐渐降低 / C. 保持不变 | A |

**Page 7 - 综合结论与应用**

| 控件类型 | questionId | targetElement | 必填规则 | 选项/说明 |
|---------|-----------|---------------|---------|----------|
| RadioGroup | Q7_1 | `P7_优先调整因素` | 必选 | 飞行高度 / 镜头焦距 |
| Textarea | Q7_2 | `P7_理由说明` | 长度 > 5 字符 | 结合图中数据说明理由 |

### 4.2 页码映射规则（subPageNum ↔ pageId）

**`getInitialPage(subPageNum)` 实现规则**：

```javascript
const PAGE_MAPPING = {
  '1': 'cover',
  '2': 'background',
  '3': 'hypothesis',
  '4': 'experiment_free',
  '5': 'focal_analysis',
  '6': 'height_analysis',
  '7': 'conclusion'
};

export function getInitialPage(subPageNum) {
  const pageId = PAGE_MAPPING[subPageNum];
  if (!pageId) {
    console.error(`[g8-drone-imaging] Invalid subPageNum: ${subPageNum}, falling back to cover`);
    return 'cover';
  }
  return pageId;
}
```

**逆向映射（pageId → stepIndex）**：

```javascript
const STEP_MAPPING = {
  'cover': 0,           // hidden，不占步数
  'background': 1,
  'hypothesis': 2,
  'experiment_free': 3,
  'focal_analysis': 4,
  'height_analysis': 5,
  'conclusion': 6
};
```

- 封面页为 `hidden` 模式，不显示左侧导航
- 从第 2 页（background）开始显示导航，共 6 步

### 4.3 导航规则（前进/返回/跳转）

- **返回限制**：不允许用户返回上一页（评估模式，单向前进）

- **点击"下一页"前的前置条件**：
- - Page 1（cover）：倒计时 30 秒结束且勾选“我已阅读并理解上述注意事项”复选框
  - Page 2（background）：强制阅读 5 秒后才可点击下一页
  - Page 3（hypothesis）：文本输入框内容不为空且长度 > 5 个字符
  - Page 5（focal_analysis）：必须选择一个选项
  - Page 6（height_analysis）：必须选择一个选项
  - Page 7（conclusion）：必须完成单选并填写理由（理由长度 > 5）

- **特殊跳转规则**：无条件分支，全部为线性顺序

- **步数与页面关系**：
  - `getTotalSteps()` 返回 6
  - Page 1（cover）为 `hidden` 模式，作为"第 0 步"引导页
  - 从 Page 2 开始显示共 6 步导航

---

## 5. 计时策略（Timing Strategy）

### 5.1 默认计时配置

```typescript
getDefaultTimers: () => ({
  task: 20 * 60,  // 任务总时长：20 分钟（1200 秒）
});
```

**计时范围说明**：
- **任务计时范围**：Page 1 - Page 7（全部页面）
- 本模块不包含独立问卷，所有页面使用统一的 task 计时

**Timer Scope 命名约定**：
- `timerScope = 'module.g8-drone-imaging.task'`
- 由容器或包装器配置，子模块不直接操作

### 5.2 Flow 覆盖与优先级

- 当 `FlowDefinition` 中存在 `overrides.timers` 时，以 Flow 配置为准
- 否则使用 `getDefaultTimers` 中的默认值（20 分钟 / 1200 秒）

### 5.3 到期行为

**任务计时到期时**：
- 自动提交当前页数据
- 未答题目填充 `"超时未回答"`
- 自动导航至下一个 Flow 步骤（7年级蒸馒头模块）
- 不允许用户继续浏览

---

## 6. 数据提交与事件设计（Data & Events）

### 6.1 数据格式与工具

**必须使用统一工具**：
- `createMarkObject` / `validateMarkObject`
- 事件枚举：`src/shared/services/submission/eventTypes.js` 中的 `EventTypes`
- 时间格式化：通过 `src/shared/services/dataLogger.js` 导出的 `formatTimestamp`
- 字段定义以 `openspec/specs/data-format/spec.md` 为准

**重要约束**：
- `eventType` 一律使用 `EventTypes.*` 枚举，禁止手写字符串
- 所有时间字段统一使用本地时间格式 `YYYY-MM-DD HH:mm:ss`，由 `formatTimestamp` 生成
- `Operation.code` 字段必须存在且连续递增，由 `createMarkObject` 自动填充

**MarkObject 关键字段**：

```typescript
{
  pageNumber: "M1:3",  // stepIndex:subPageNum（stepIndex 取自实际 FlowDefinition，此处 1 为示例）
  pageDesc: "[flowId/g8-drone-imaging/1] 实验步骤与假设思考",
  operationList: [
    {
      code: 1,
      targetElement: '页面',
      eventType: EventTypes.PAGE_ENTER,  // 使用枚举
      value: 'hypothesis',
      time: '2025-11-19 10:30:00'  // 由 formatTimestamp 生成
    },
    // ... 其他操作，code 连续递增
  ],
  answerList: [
    {
      code: 1,
      targetElement: 'P3_控制变量理由',
      value: '学生填写的文本内容'
    }
  ],
  beginTime: "2025-11-19 10:30:00",
  endTime: "2025-11-19 10:32:30",
  imgList: []
}
```

> **说明**：`pageNumber` 中的 `stepIndex` 取自实际 `FlowDefinition` 配置，此处的 `1` 仅为示例。

### 6.2 事件类型与命名规范

> **重要**：`eventType` 一律使用 `EventTypes.*` 枚举，下表为语义说明。优先复用已有的实验类事件（如 `SIMULATION_OPERATION`），若确需新增事件类型，需同步更新 `EventTypes` 枚举与 Data Format Spec。

**现有可用事件类型**：
| EventTypes 枚举 | 触发时机 | 备注 |
|----------------|---------|------|
| `EventTypes.PAGE_ENTER` | 页面组件首次挂载 | 必须 |
| `EventTypes.PAGE_EXIT` | 离开当前页面（切换前/提交后） | 必须 |
| `EventTypes.INPUT_CHANGE` | 文本输入框内容变化 | 用于 Textarea 答题 |
| `EventTypes.RADIO_SELECT` | 单选按钮选择 | 用于选择题 |
| `EventTypes.CLICK` | 点击普通按钮（实验控制按钮等） | 包含按钮 id |
| `EventTypes.SIMULATION_OPERATION` | 实验操作（拍照/参数调整） | 复用已有实验事件 |
| `EventTypes.TIMER_STOP` | 计时器停止 | 可用于强制阅读结束 |

**需扩展的事件类型**（实现前需更新 `eventTypes.js` 与 Data Format Spec）：
| 拟新增枚举 | 触发时机 | 备注 |
|-----------|---------|------|
| `EventTypes.CLICK_BLOCKED` | 点击"下一步"但校验未通过 | 标记阻断原因 |
| `EventTypes.AUTO_SUBMIT` | 计时器到期触发自动提交 | 便于排查 |
| `EventTypes.READING_COMPLETE` | 强制阅读时间结束 | Page 2 特有，或复用 `TIMER_STOP` |

**页面级事件使用说明（与 Page 1 相关）**
- Page 1（cover）使用的核心事件：
  - 进入/离开页面：`EventTypes.PAGE_ENTER` / `EventTypes.PAGE_EXIT`
  - 30 秒倒计时结束：`EventTypes.READING_COMPLETE`（或按实现复用 `EventTypes.TIMER_STOP`），`targetElement = 'P1_notice'`
  - 倒计时未结束或未勾选复选框时点击“下一页”被拦截：`EventTypes.CLICK_BLOCKED`，`targetElement = 'next_button'`，`value = "notice_not_confirmed"`
  - 勾选/取消勾选“我已阅读并理解上述注意事项”：`EventTypes.CLICK`，`targetElement = 'P1_notice_confirm'`，`value = 'checked'` / `'unchecked'`

> **落地任务**：在子模块实现前，需更新 `src/shared/services/submission/eventTypes.js` 和 `openspec/specs/data-format/spec.md`，将上述新增事件纳入标准集合。

**实验操作事件详细格式**：

```typescript
// 参数调整事件（复用 SIMULATION_OPERATION）
{
  code: 2,
  targetElement: 'height_selector',
  eventType: EventTypes.SIMULATION_OPERATION,
  value: JSON.stringify({ action: 'param_change', height: 200 }),
  time: '2025-11-19 10:31:00'  // 由 formatTimestamp 生成
}

// 拍照实验事件（复用 SIMULATION_OPERATION）
{
  code: 3,
  targetElement: 'experiment_panel',
  eventType: EventTypes.SIMULATION_OPERATION,
  value: JSON.stringify({ action: 'capture', height: 200, focalLength: 24, gsd: 2.01 }),
  time: '2025-11-19 10:31:30'
}
```

### 6.3 提交时机与失败处理

**提交实现方式**：
- 提交统一通过 `AssessmentPageFrame` 的 `submission` 配置 + `defaultSubmit` 实现
- 业务页面 **不要** 直接调用 `usePageSubmission.submit()`，而是通过 `onNext` / `defaultSubmit` 触发提交+导航

**提交触发点**：
- 点击"下一页/提交"时：
  - `AssessmentPageFrame` 调用 `defaultSubmit`
  - 收集当前页全部答案 → 补齐未答占位 → 构造 `MarkObject` → 自动调用提交
  - 提交成功后才允许导航到下一页
- 计时器到期自动提交时：
  - 框架自动触发提交
  - 未答填 `"超时未回答"` → 提交并自动导航

**提交失败处理**：
- 网络错误或服务端错误：
  - 显示统一错误托盘，阻断导航
  - 使用 `usePageSubmission` 内部的重试机制（指数退避，最多3次）
  - UI 提示："正在重试..."或"提交失败，请点击重试"
- 401/会话过期：调用 `handleSessionExpired`，清理状态并回登录

---

## 7. Flow 集成与进度恢复（Flow Integration）

- **从进度到页面的映射**：
  - 后端/容器提供：`stepIndex` 与 `modulePageNum`
  - FlowModule 调用：`getInitialPage(modulePageNum)` → 得到 `initialPageId`
  - 子模块在内部据此渲染对应页面

- **完成判定逻辑**：
  - 本子模块在 Page 7（conclusion）成功提交后算"完成"
  - 完成后通知 Flow 容器进入过渡页，容器推进到下一 `stepIndex`（7年级蒸馒头模块）

- **Flow 覆盖配置的支持**：
  - 支持 `options.timers` 覆盖默认计时
  - 当前未使用 `options.variant` 等字段

---

## 8. 本地存储与状态管理（Local State & Persistence）

- **状态管理方式**：
  - 使用 React Context（`DroneImagingContext`）管理模块内状态

- **存储命名空间约束**：
  - **必须** 使用 `module.g8-drone-imaging.*` 命名空间
  - **不得** 写入 `flow.*` 或 `core.*` 命名空间（这些由 Flow 容器/平台管理）
  - **不得** 手动添加 `flow_context` 事件（由 Flow 容器统一打点）

- **可持久化的状态项**：
  - `module.g8-drone-imaging.answers`：已作答答案草稿
  - `module.g8-drone-imaging.experimentHistory`：实验操作历史（参数组合记录）
  - `module.g8-drone-imaging.lastPageId`：最后访问的页面

- **刷新恢复策略**：
  - 从持久化状态中读取答案草稿并回填 UI
  - `initialPageId` 以 Flow 容器为准，子模块不自行跳页
  - 实验历史可用于恢复 Page 4 的操作状态

---

## 9. 错误处理与边界情况（Error Handling & Edge Cases）

- **初始化失败**：
  - 显示统一错误 UI，提供"重试"按钮
  - 提示文案：`"加载失败，请点击重试"`

- **非法页码 / 配置错误**：
  - `subPageNum` 超出范围（1-7）：记录错误日志，回退到首页 `cover`
  - `pageId` 找不到：回退到 `cover`

- **401/会话过期**：
  - 一律交给统一 `handleSessionExpired`
  - 子模块不得覆盖该行为

- **网络波动与重试**：
  - 使用 `usePageSubmission` 内部的重试机制（指数退避，最多3次）
  - 子模块在 UI 上指示"正在重试 / 请稍后重试"

- **实验组件错误**：
  - SVG/Canvas 渲染失败时显示降级 UI
  - GSD 查找表未找到对应值时使用默认值并记录警告

- **校验未通过阻断下一页的提示文案**：
  | 校验场景 | 提示文案 |
  |---------|---------|
  | Page 1 未完成注意事项确认 | `"请先阅读注意事项并勾选确认后再继续"` |
  | Page 2 强制阅读未完成 | `"请先阅读完页面内容"` |
  | Page 3 文本输入为空或过短 | `"请输入至少 5 个字符的思考内容"` |
  | Page 5/6 未选择选项 | `"请选择一个答案后再继续"` |
  | Page 7 未完成单选 | `"请选择优先调整的因素"` |
  | Page 7 理由未填写或过短 | `"请输入至少 5 个字符的理由说明"` |

---

## 10. 视觉与交互规范（UI & UX Constraints）

### 10.1 统一部分（不可覆盖）

- 页面外壳布局（左右结构 + 顶部计时 + 底部下一页按钮）
- 左侧导航（圆点 + 步数显示）样式与逻辑
- 计时器位置与基本样式
- 全局错误托盘组件

### 10.2 可自定义部分

- 主体区域的内容布局与控件
- 无人机航拍模拟实验的交互组件
- SVG/Canvas 动画效果

### 10.3 页面布局规范

**Page 1（任务封面）**：单栏居中布局
```css
.coverContent {
  max-width: 800px;
  margin: 0 auto;
  text-align: center;
}
```

**Page 2（背景知识）**：上图下文布局
```css
.backgroundLayout {
  display: flex;
  flex-direction: column;
  gap: 24px;
}
```

**Page 3-7（实验/答题页）**：左右分栏布局
```css
.splitLayout {
  display: flex;
  gap: 24px;
  height: 100%;
}

.leftPanel {
  flex: 1;
  overflow-y: auto;
}

.rightPanel {
  flex: 1;
  display: flex;
  flex-direction: column;
}
```

### 10.4 实验模拟器组件规范

**无人机航拍模拟器（DroneSimulator）**：

```css
.simulatorContainer {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding: 24px;
  background: var(--card-background);
  border: 2px solid var(--cartoon-border);
  border-radius: 12px;
}

.controlPanel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.parameterRow {
  display: flex;
  align-items: center;
  gap: 12px;
}

.parameterLabel {
  font-weight: 600;
  min-width: 80px;
}

.buttonGroup {
  display: flex;
  gap: 8px;
}

.paramButton {
  padding: 8px 16px;
  border: 2px solid var(--cartoon-border);
  border-radius: 8px;
  background: var(--card-background);
  cursor: pointer;
  transition: all 0.2s ease;
}

.paramButton:hover {
  border-color: var(--cartoon-primary);
}

.paramButton.active {
  background: var(--cartoon-primary);
  border-color: var(--cartoon-primary);
  color: white;
}

.actionButtons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

.startButton {
  flex: 1;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--cartoon-primary), #4aa3d6);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.resetButton {
  padding: 12px 24px;
  background: var(--card-background);
  border: 2px solid var(--cartoon-border);
  border-radius: 8px;
  cursor: pointer;
}

.imagePreview {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 8px;
  background: #f0f0f0;
}

.aerialImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: filter 0.3s ease;
}

.gsdDisplay {
  padding: 16px;
  background: rgba(89, 193, 255, 0.1);
  border-radius: 8px;
  text-align: center;
}

.gsdValue {
  font-size: 32px;
  font-weight: 700;
  color: var(--cartoon-primary);
}

.gsdUnit {
  font-size: 14px;
  color: var(--text-secondary);
}
```

### 10.5 GSD 查找表实现

```javascript
// src/submodules/g8-drone-imaging/utils/gsdLookup.js

export const GSD_LOOKUP_TABLE = {
  '100-8': 3.01,
  '100-24': 1.00,
  '100-50': 0.48,
  '200-8': 6.03,
  '200-24': 2.01,
  '200-50': 0.96,
  '300-8': 9.04,
  '300-24': 3.01,
  '300-50': 1.45
};

export function lookupGSD(height, focalLength) {
  const key = `${height}-${focalLength}`;
  const gsd = GSD_LOOKUP_TABLE[key];

  if (gsd === undefined) {
    console.warn(`[GSD Lookup] Unknown combination: H=${height}, F=${focalLength}`);
    return 0;
  }

  return gsd;
}

export function calculateBlurAmount(gsd, coefficient = 0.8) {
  // GSD 值越大，图片越模糊
  // 例如：GSD=9.04 -> blur(7.2px) [很糊]; GSD=0.48 -> blur(0.38px) [清晰]
  return gsd * coefficient;
}
```

### 10.6 颜色与排版

遵循全局 CSS 变量规范（见模板第10节），关键使用：
- 主色 `--cartoon-primary: #59c1ff`：实验控制按钮、选中状态
- 边框色 `--cartoon-border: #ffd99e`：卡片边框、输入框边框
- 正文色 `--text-color: #333333`：问题描述、说明文字

### 10.7 响应式适配

```css
/* 中等屏幕 */
@media (max-height: 800px) {
  .simulatorContainer {
    padding: 16px;
  }

  .gsdValue {
    font-size: 28px;
  }
}

/* 紧凑屏幕 */
@media (max-height: 720px) {
  .simulatorContainer {
    padding: 12px;
    gap: 8px;
  }

  .paramButton {
    padding: 6px 12px;
  }

  .gsdValue {
    font-size: 24px;
  }
}
```

---

## 11. 配置项与扩展性（Options & Extensibility）

| 配置项名 | 类型 | 默认值 | 说明 |
|---------|------|--------|------|
| `timers.task` | `number` | `1200` | 任务总时长：20 分钟（1200 秒） |

当前版本暂无其他可配置项。所有配置项有合理默认值，保证在 `options` 为空时模块可正常运行。

---

## 12. 日志与埋点要求（Logging & Telemetry）

### 12.1 必需埋点

- **`flow_context`**：由 Flow 容器统一打点，子模块无需手动上报
- **进入子模块**：`page_enter` 事件
- **完成子模块**：Page 7 提交成功时记录 `module_complete` 事件
- **异常中断**：提交连续失败超过3次时记录 `submission_failed` 事件

### 12.2 业务埋点

| 埋点名称 | 触发时机 | 字段 |
|---------|---------|------|
| `experiment_operation` | 每次完成拍照实验 | `height`, `focalLength`, `gsd`, `operationCount` |
| `reading_time` | Page 2 阅读完成 | `duration` |
| `answer_change` | 答案修改 | `questionId`, `oldValue`, `newValue` |

### 12.3 字段要求

所有关键埋点包含：
- `flowId`、`submoduleId`、`stepIndex`、`pageNumber`
- `examNo`、`batchCode`（从 `userContext` 获取）

---

## 13. 性能与安全要求（Performance & Safety）

### 13.1 性能目标

- **首屏渲染时间**：< 3 秒
- **单页渲染**：切换页面时主要内容渲染 < 500ms
- **实验动画**：保持 60 FPS
- **图片资源**：
  - 无人机产品图：压缩至 < 200KB
  - 航拍示例图：压缩至 < 300KB
  - 使用懒加载策略

### 13.2 优化建议

- 实验模拟器使用 CSS `filter: blur()` 而非 Canvas 重绘
- 使用 `will-change: filter` 提示浏览器优化
- 图片预加载：在 Page 3 预加载 Page 4 的航拍图片

### 13.3 安全与隐私

- 禁止在本地持久化敏感信息明文
- 不得向外域发送任何数据
- 所有网络请求通过统一 API 域名

---

## 14. 验收标准与测试清单（Acceptance & Test Plan）

### 14.1 功能用例

#### 用例0：任务封面页注意事项确认
- **前置**：登录并进入绑定了本子模块的 Flow，当前处于 Page 1（cover）
- **步骤**：
  1. 进入 Page 1 后立即尝试点击“下一页”
  2. 在倒计时未结束前多次尝试勾选“我已阅读并理解上述注意事项”复选框
  3. 等待 38 秒倒计时结束
  4. 勾选复选框后再次点击“下一页”
- **验证**：
  - [ ] 倒计时未结束前，复选框处于不可勾选状态
  - [ ] 倒计时未结束前，“下一页”按钮被禁用或点击时被拦截，并出现提示：`"请先阅读注意事项并勾选确认后再继续"`
  - [ ] 38 秒结束后，复选框变为可勾选
  - [ ] 勾选复选框后，“下一页”按钮可用，点击后成功进入 Page 2（background）
  - [ ] Mark 数据中存在对应的 `PAGE_ENTER` / `PAGE_EXIT`、`READING_COMPLETE`（或 `TIMER_STOP`）、`CLICK_BLOCKED`、`CLICK` 事件记录

#### 用例1：正常完成流程
- **前置**：登录后进入绑定了本子模块所在 Flow
- **步骤**：按页面顺序完成所有题目并点击下一页
- **验证**：
  - [ ] 所有页面均可正常访问
  - [ ] Page 2 强制阅读 5 秒后才可点击下一页
  - [ ] Page 3 文本输入校验正常（> 5 字符）
  - [ ] Page 4 实验操作正常（参数切换、拍照、GSD显示、图片模糊度）
  - [ ] Page 5/6 选择题可正常选择
  - [ ] Page 7 混合输入校验正常
  - [ ] 提交数据格式符合规范
  - [ ] Flow 能顺利进入下一个步骤

#### 用例2：实验数据验证
- **步骤**：在 Page 4/5/6 测试所有参数组合
- **验证**：
  - [ ] 高度 100m + 焦距 8mm → GSD = 3.01
  - [ ] 高度 100m + 焦距 50mm → GSD = 0.48
  - [ ] 高度 300m + 焦距 8mm → GSD = 9.04
  - [ ] 模糊度视觉效果正确（GSD 越大越模糊）

#### 用例3：中途刷新恢复
- **前置**：在 Page 5 作答部分问题
- **步骤**：刷新浏览器，再次进入同一 Flow
- **验证**：
  - [ ] 恢复到正确的页面
  - [ ] 已保存答案被正确回填
  - [ ] 实验操作历史可恢复

#### 用例4：计时器到期
- **前置**：接近 20 分钟结束
- **步骤**：等待计时器到期
- **验证**：
  - [ ] 自动提交当前页数据
  - [ ] 未答题目写入 `"超时未回答"`
  - [ ] Flow 正确进入下一步骤（7年级蒸馒头模块）

#### 用例5：网络错误与重试
- **步骤**：模拟提交失败（网络超时/服务端 500）
- **验证**：
  - [ ] 显示错误提示
  - [ ] 重试逻辑正常（最多3次）
  - [ ] 阻断导航直到提交成功

#### 用例6：Flow 级上下文埋点
- **步骤**：完成页面加载与提交
- **验证**：
  - [ ] Mark 数据的 `operationList` 中存在 `eventType = 'flow_context'` 记录
  - [ ] 子模块业务事件不会覆盖 `flow_context` 记录

### 14.2 统一规范对齐检查项

- [ ] CMI 接口字段全部实现
- [ ] 使用 `usePageSubmission` 进行数据提交
- [ ] 使用统一计时器引擎，未自行实现倒计时逻辑
- [ ] 通过容器进行导航，未直接操控路由或 URL
- [ ] 所有文件使用 UTF-8 编码
- [ ] 样式使用 CSS Modules
- [ ] 颜色使用 CSS 变量

---

## 15. 代码与文档交付物清单（Deliverables）

### 15.1 代码交付

- [ ] `src/submodules/g8-drone-imaging/index.tsx`：导出 `SubmoduleDefinition`
- [ ] `src/submodules/g8-drone-imaging/Component.tsx`：子模块主组件
- [ ] `src/submodules/g8-drone-imaging/mapping.ts`：页码映射
- [ ] `src/submodules/g8-drone-imaging/context/DroneImagingContext.tsx`：状态管理
- [ ] `src/submodules/g8-drone-imaging/pages/*.tsx`：7 个页面组件
- [ ] `src/submodules/g8-drone-imaging/components/*.tsx`：实验相关组件
- [ ] `src/submodules/g8-drone-imaging/utils/gsdLookup.ts`：GSD 查找表
- [ ] `src/submodules/g8-drone-imaging/styles/*.module.css`：CSS Modules 样式文件
- [ ] `src/submodules/g8-drone-imaging/assets/images/*`：图片资源

### 15.2 文档交付

- [ ] 本设计说明书（已完成）
- [ ] 页面列表表格（4.1 节）
- [ ] 页码映射规则（4.2 节）
- [ ] 事件与埋点清单（6.2、12 节）
- [ ] 计时策略说明（5 节）
- [ ] 验收用例与测试记录（14 节）

---

## 附录 A：SVG 动画实验参考实现

### A.1 参考文档位置

**参考文件**：[docs/SVG动画参考/无人机交互动画.html](../SVG动画参考/无人机交互动画.html)

> **重要说明**：在实现 Page 4/5/6 的无人机航拍模拟实验时，****直接复制参考文档中的代码生成可复用组件****进行复用，确保视觉效果和交互逻辑与设计稿一致。

### A.2 参考实现核心结构

#### CSS 变量定义

```css
:root {
    --primary-blue: linear-gradient(180deg, #6ecfff 0%, #38a4ff 100%);
    --primary-blue-hover: linear-gradient(180deg, #89d9ff 0%, #5bb5ff 100%);
    --height-btn-bg: #ffe0b2;      /* 高度按钮浅橙色 */
    --height-btn-active: #ffb74d;  /* 高度按钮深橙色 */
    --gsd-green: #c8e6c9;          /* GSD背景绿 */
    --gsd-text: #2e7d32;           /* GSD文字绿 */
}
```

#### SVG 实验舞台结构

```html
<svg viewBox="0 0 900 480" preserveAspectRatio="xMidYMid slice">
    <defs>
        <!-- 模糊滤镜 -->
        <filter id="groundBlur">
            <feGaussianBlur id="blurKernel" stdDeviation="0" />
        </filter>
        <!-- 无人机图标定义 -->
        <g id="droneIcon">...</g>
    </defs>

    <!-- 地面层 (应用模糊) -->
    <g class="ground-layer" style="filter: url(#groundBlur)">...</g>

    <!-- 视锥 (拍照时的光束) -->
    <path id="fovCone" .../>

    <!-- 无人机 (悬停层，不模糊) -->
    <g id="droneGroup" class="drone-group">...</g>
</svg>
```

#### JavaScript 核心逻辑

```javascript
// GSD 查找表（与设计说明书 4.1.1 节一致）
const GSD_LOOKUP = {
    100: { 8: 3.01, 24: 1.00, 50: 0.48 },
    200: { 8: 6.03, 24: 2.01, 50: 0.96 },
    300: { 8: 9.04, 24: 3.01, 50: 1.45 }
};

// 焦距档位
const FOCAL_STEPS = [8, 24, 50];

// 状态变量
let currentHeight = 100;
let focalIndex = 0;

// 模糊度计算
function startExperiment() {
    const focalVal = FOCAL_STEPS[focalIndex];
    const gsd = GSD_LOOKUP[currentHeight][focalVal];
    const blurVal = gsd * 0.8;  // 模糊系数
    elBlur.setAttribute('stdDeviation', blurVal);
}

// 无人机位置映射: 100m -> Y=250, 200m -> Y=150, 300m -> Y=50
function updateDronePosition() {
    const yPos = 350 - currentHeight;
    elDrone.setAttribute('transform', `translate(450, ${yPos}) scale(0.8)`);
}
```

### A.3 需要迁移到 React 组件的部分

| 参考文件元素 | 对应 React 组件 | 迁移说明 |
|-------------|----------------|---------|
| `.control-height` | `HeightSelector.tsx` | 左上角高度按钮组 |
| `.display-gsd` + `.gsd-box` | `GSDDisplay.tsx` | 右上角 GSD 显示 |
| `.stage-area` + `<svg>` | `DroneSimulator.tsx` | SVG 实验舞台主体 |
| `.focal-control-wrapper` | `FocalLengthSelector.tsx` | 底部焦距调节器 |
| `.big-btn` (开始/重置) | 集成到 `DroneSimulator.tsx` | 底部控制按钮 |
| `<script>` 逻辑 | `DroneImagingContext.tsx` + Hooks | 状态管理和交互逻辑 |

### A.4 关键动画效果

1. **无人机升降动画**
   ```css
   .drone-group {
       transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
   }
   ```

2. **螺旋桨旋转**
   ```css
   .propeller {
       transform-box: fill-box;
       transform-origin: center;
       animation: spin 0.08s linear infinite;
   }
   @keyframes spin { 100% { transform: rotate(360deg); } }
   ```

3. **地面模糊过渡**
   ```css
   .ground-layer {
       transition: filter 0.6s ease-out;
   }
   ```

4. **拍照闪光效果**
   ```javascript
   elFlash.style.opacity = 0.8;
   setTimeout(() => elFlash.style.opacity = 0, 150);
   ```

### A.5 视锥宽度映射

```javascript
// 焦距越小，视野越宽
function showFovCone(focal) {
    let widthHalf = 150;        // 8mm
    if(focal === 24) widthHalf = 80;
    if(focal === 50) widthHalf = 40;
    // 绘制三角形视锥
}
```

### A.6 React 迁移注意事项

1. **状态管理**：将 `currentHeight`、`focalIndex`、`currentGSD` 迁移到 `DroneImagingContext`
2. **DOM 操作**：使用 `useRef` 替代 `document.getElementById`
3. **SVG 属性**：React 中使用 `camelCase`（如 `strokeWidth` 而非 `stroke-width`）
4. **事件处理**：`onclick` 改为 `onClick`
5. **样式隔离**：CSS 迁移到对应的 `*.module.css` 文件
6. **事件记录**：在关键操作处调用 `logOperation` 记录埋点

---

## 附录 B：答案数据格式参考

> **说明**：`answerList` 中的 `code` 字段从 1 开始连续递增，每个答案项一个 code。

### Page 3 - 实验步骤与假设思考

```typescript
{
  code: 1,
  targetElement: 'P3_控制变量理由',
  value: '学生填写的文本内容'  // 若超时未答则为 "超时未回答"
}
```

### Page 5 - 实验数据分析-焦距影响

```typescript
{
  code: 1,  // 每页答案 code 从 1 开始
  targetElement: 'P5_最小GSD焦距',
  value: 'C. 50毫米'  // 正确答案；若未选择则为 "未回答" 或 "超时未回答"
}
```

### Page 6 - 实验数据分析-高度影响

```typescript
{
  code: 1,
  targetElement: 'P6_GSD变化趋势',
  value: 'A. 逐渐升高'  // 正确答案
}
```

### Page 7 - 综合结论与应用

```typescript
// 单选答案
{
  code: 1,
  targetElement: 'P7_优先调整因素',
  value: '镜头焦距'  // 或 '飞行高度'
}

// 文本答案
{
  code: 2,
  targetElement: 'P7_理由说明',
  value: '学生填写的理由内容'
}
```

---

## 附录 C：实验操作数据格式参考

```typescript
// 完整的实验操作记录（使用 EventTypes 枚举）
{
  code: 5,  // 由 createMarkObject 自动填充，连续递增
  targetElement: 'experiment_panel',
  eventType: EventTypes.SIMULATION_OPERATION,  // 使用枚举
  value: JSON.stringify({
    action: 'capture',
    height: 200,
    focalLength: 24,
    gsd: 2.01,
    blurAmount: 1.61
  }),
  time: '2025-11-19 10:31:30'  // 由 formatTimestamp 生成，格式 YYYY-MM-DD HH:mm:ss
}
```

---

> **使用建议**：
> - 对于 AI 交互工程师：在开始编码前，务必逐项阅读并理解本说明书；编码过程中，如遇不在说明书范围内的决策，应先在说明书中补充分节，再实施
> - 对于评审者：可将本说明书作为 Code Review 与验收 checklist，逐项检查是否满足
> - 对于后续维护者：本说明书应随代码版本更新而维护，确保版本号、页面列表、计时与数据格式等信息始终最新

---

## 附录 D：任务封面页注意事项 UI 说明

> 说明：本附录补充 Page 1（`cover`，任务封面页）的详细文案与交互规则，布局参考产品提供的“注意事项”截图。

### D.1 注意事项文案

- 页面标题：`注意事项`
- 标题下方显示醒目的提示文案：`请仔细阅读`
- 注意事项内容以列表形式展示，文案为：
  - 本科学探究共20分钟，时间结束后，系统将自动退出答题界面。
  - 请按顺序回答每页问题，上一页题目未完成作答，将无法点击进入下一页。
  - 答题时，不要提前点击"下一页"查看后面的内容，否则将无法返回上一页。
  - 遇到系统故障、死机、死循环等特殊情况时，请举手示意老师。

### D.2 复选框与倒计时区域

- 页面下方使用浅蓝色确认区域，整体为单栏居中布局，参考示意截图（上方为注意事项卡片，下方为确认区域）。
- 确认区域左侧为复选框，文案为：`我已阅读并理解上述注意事项`。
- 复选框右侧为提示按钮/标签，默认文案为：`请仔细阅读注意事项，38秒后可勾选确认。`。
- 从学生进入 Page 1 起启动 38 秒倒计时：
  - 倒计时未结束前，复选框处于禁用状态，学生无法勾选。
  - 倒计时结束后，复选框变为可用状态，提示文案可保持不变或根据需要更新为“请勾选确认后继续答题”等同义文案。

### D.3 与“下一页”按钮的联动

- 本页不出现任何答题控件，仅作为任务说明与规则确认页。
- `"下一页"`按钮由外层 `AssessmentPageFrame` 提供，本子模块需要通过校验逻辑约束其可点击状态：
  - 初始进入页面时，`"下一页"`按钮保持禁用，不允许学生直接跳转。
  - 仅当 **倒计时 38 秒结束且学生勾选了“我已阅读并理解上述注意事项”复选框** 时，才视为校验通过，允许点击 `"下一页"` 进入 Page 2。
- 若产品需要在违规操作时给出反馈（例如学生尝试绕过校验），可在拦截 `"下一页"` 行为时弹出提示：`"请先阅读注意事项并勾选确认后再继续"`。

### D.4 事件记录与埋点扩展（对应 6.2）

- Page 1 进入时必须记录 `EventTypes.PAGE_ENTER`，离开时记录 `EventTypes.PAGE_EXIT`。
- 当 38 秒倒计时结束时，记录一次 `EventTypes.READING_COMPLETE`（或按实现选择复用 `EventTypes.TIMER_STOP`），`targetElement = 'P1_notice'`。
- 当学生在倒计时结束前尝试点击 `"下一页"` 被拦截时，触发 `EventTypes.CLICK_BLOCKED`：
  - `targetElement = 'next_button'`
  - `value` 中写入原因：`"notice_not_confirmed"`。
- 当学生勾选“我已阅读并理解上述注意事项”复选框时，可以记录一次 `EventTypes.CLICK`：
  - `targetElement = 'P1_notice_confirm'`
  - `value = 'checked'` / `'unchecked'`。

### D.5 校验失败提示文案扩展（对应 9 节）

- 在原有“校验未通过阻断下一页的提示文案”表格基础上，为 Page 1 增加一行：
  - 校验场景：`Page 1 未完成注意事项确认`
  - 提示文案：`"请先阅读注意事项并勾选确认后再继续"`。

### D.6 功能用例与测试点扩展（对应 14.1）

- 在 14.1 中新增“用例0：任务封面页注意事项确认”，测试要点如下：
  - **前置**：登录并进入本子模块，对应 Page 1（cover）。
  - **步骤**：
    - 立即尝试点击 `"下一页"`。
    - 在倒计时未结束前尝试勾选复选框。
    - 等待 38 秒后勾选复选框，再点击 `"下一页"`。
  - **验证**：
    - [ ] 倒计时未结束前，复选框处于不可勾选状态。
    - [ ] 倒计时未结束前，`"下一页"`按钮被禁用或点击时被拦截，并出现文案提示：`"请先阅读注意事项并勾选确认后再继续"`。
    - [ ] 38 秒结束后，复选框变为可勾选。
    - [ ] 勾选复选框后，`"下一页"`按钮可用，点击后成功进入 Page 2。
    - [ ] Mark 数据中存在对应的 `PAGE_ENTER`/`PAGE_EXIT`、`READING_COMPLETE`（或 `TIMER_STOP`）、`CLICK_BLOCKED` 事件记录。
