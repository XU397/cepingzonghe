# 薇甘菊防治实验子模块设计说明书

> 适用对象：人机交互前端（考试端）的 **Flow 子模块** 开发场景。
> 文档版本：1.1.0
> 创建日期：2025-11-19
> 更新日期：2025-11-19
> 相关参考：
> - `docs/需求-交互前端改造方案.md`
> - `docs/三端改造方案与职责边界.md`
> - `docs/模块化开发规范与扩展指引.md`
> - `docs/SUBMODULE_REGISTRATION_GUIDE.md`
> - `openspec/specs/assessment-core/spec.md`
> - `openspec/specs/data-format/spec.md`
> - `docs/薇甘菊防治实验开发需求文档.md`
> - `src/shared/types/flow.ts`

---

## 1. 基本信息（Basic Info）

- **子模块名称（中文）**：薇甘菊防治实验

- **子模块标识 `submoduleId`（唯一，kebab-case）**：`g8-mikania-experiment`
  - 命名说明：`g8`（8年级）+ `mikania`（薇甘菊学名 Mikania micrantha 缩写）+ `experiment`（实验类型）

- **显示名称 `displayName`**：8年级薇甘菊防治-交互实验

- **版本号 `version`**：1.1.0

- **适用年级 / 学科 / 场景**：八年级 / 生物（注：原需求标注物理，但内容为生物实验）/ 探究实验：薇甘菊防治

- **业务目标（简要描述）**：
  - 评估学生在阅读实验背景后的问题洞察能力
  - 评估学生对模拟实验的操作能力和变量控制理解
  - 评估学生获得实验数据后的分析和总结能力
  - 作为测试模块，验证系统多类型交互功能

- **所属 Flow 类型**：标准 Flow 步骤（实验类型）
  - 说明：本子模块可作为任意 Flow 中的一个步骤运行，具体位置由 Flow 配置决定
  - **Flow 无关原则**：子模块不假设自己在 Flow 中的位置，不指定前置或后继模块

---

## 2. 运行环境与全局约束（Runtime & Global Constraints）

- **运行容器**：
  - 子模块 **必须** 运行在统一页面框架中：
    - 外壳：`AssessmentPageFrame`（导航 + 计时 + 主体 + 下一页按钮 + 错误托盘）；
    - 左侧导航：`LeftStepperNav`。
  - 子模块 **不得** 自行实现：全局导航、计时器、错误托盘、顶栏布局等。

- **技术栈约束**：
  - 前端框架：React 18 + JSX（与项目整体保持一致）。
  - 构建工具：Vite 4（由项目统一配置）。
  - 风格规范：遵守项目现有 ESLint + Prettier 配置。
  - 不得依赖浏览器不兼容特性（建议保持 ES2019 及以上语法）。

- **禁止直接操作的能力（必须通过统一封装）**：
  - 路由跳转：不得直接使用 `window.location`/`history.pushState` 或 Router API；**改用** 容器提供的 `flowContext.onComplete()` 等回调。
  - 本地存储：不得随意读写 `localStorage/sessionStorage`；**必须** 使用 `module.g8-mikania-experiment.*` 命名空间。
  - 会话处理：不得自行处理 401 / session 过期；**必须** 交由统一的 `handleSessionExpired`。
  - 直接调用后端 API：通过统一 API 层（如 `apiService`），并遵循数据格式规范。

- **支持环境假设**：
  - 子模块可以假定：
    - 已存在 `userContext`（含 `examNo`、`batchCode`、`flowId` 等）；
    - Flow 容器会传入 `initialPageId` 和 `flowContext`，无需自行解析 URL；
    - 全局错误捕获与日志系统已启用。

---

## 3. CMI 接口定义与导出规范（CMI Definition）

### 3.1 TypeScript 接口示意

```ts
// 参考 src/shared/types/flow.ts
export interface SubmoduleComponentProps {
  userContext: UserContext;
  initialPageId: string;
  options?: {
    timers?: {
      task?: number;
      questionnaire?: number;
    };
  };
  flowContext?: {
    flowId: string;
    stepIndex: number;
    submoduleId: string;
    modulePageNum?: string | null;
    onComplete?: () => void;
    onTimeout?: () => void;
    updateModuleProgress?: (modulePageNum: string) => void;
  };
}

export type NavigationMode = 'experiment' | 'questionnaire' | 'hidden';

export interface SubmoduleDefinition {
  submoduleId: 'g8-mikania-experiment';
  displayName: '8年级薇甘菊防治-交互实验';
  version: '1.1.0';  // 与基本信息中的版本号保持一致

  Component: (props: SubmoduleComponentProps) => React.ReactNode;
  getInitialPage(subPageNum: string): string;
  getTotalSteps(): number; // 返回 5（不含 hidden 引导页，含注意事项页和任务背景页）
  getNavigationMode(pageId: string): NavigationMode;

  getDefaultTimers?: () => {
    task: 1200; // 20分钟 = 1200秒
  };

  onInitialize?: () => void;
  onDestroy?: () => void;
}
```

### 3.2 导出位置与命名

- **实际导出文件路径**：`src/submodules/g8-mikania-experiment/index.jsx`
- **导出对象名称**：`export const g8MikaniaExperimentSubmodule`

### 3.3 目录结构

```text
src/submodules/g8-mikania-experiment/
  index.jsx              # 导出 SubmoduleDefinition
  Component.jsx          # 子模块主组件
  mapping.js             # subPageNum <-> pageId 映射 & getNavigationMode
  pages/                 # 具体业务页面组件
    Page00_Notice.jsx    # 注意事项页（任务封面）
    Page01_Intro.jsx
    Page02_Step_Q1.jsx
    Page03_Sim_Exp.jsx
    Page04_Q2_Data.jsx
    Page05_Q3_Trend.jsx
    Page06_Q4_Conc.jsx
  components/            # 子模块内通用组件
    ExperimentPanel/     # 模拟实验面板（含滴管动画、培养皿）
      index.jsx
      PetriDish.jsx      # 培养皿 SVG 组件
      Dropper.jsx        # 滴管动画组件
      SeedDisplay.jsx    # 种子显示组件
    ChartPanel/          # 折线图展示组件
      index.jsx
  styles/                # 样式文件
    Page00_Notice.module.css
    Page01_Intro.module.css
    Page02_Step_Q1.module.css
    Page03_Sim_Exp.module.css
    Page04_Q2_Data.module.css
    Page05_Q3_Trend.module.css
    Page06_Q4_Conc.module.css
    ExperimentPanel.module.css
  assets/                # 静态资源
    data/
      germination-data.json  # 发芽率数据表
    images/
      img_mik_weed.jpg
      img_cuscuta.jpg
      img_exp_steps.jpg
      chart_germination_curve.png
  utils/
    experimentData.js    # 实验数据查询函数
```

---

## 4. 页面模型与导航设计（Pages & Navigation）

### 4.1 页面列表

| subPageNum | pageId | 类型（type） | 导航模式（navigationMode） | 说明（业务含义） |
|-----------:|--------|-------------|---------------------------|-----------------|
| 1 | `page_00_notice` | `notice` | `hidden` | 注意事项页（任务封面，38秒后可勾选确认） |
| 2 | `page_01_intro` | `notice` | `hidden` | 任务背景介绍页（引导页，不占导航步数） |
| 3 | `page_02_step_q1` | `experiment` | `experiment` | 实验步骤展示 + 填空题Q1 |
| 4 | `page_03_sim_exp` | `experiment` | `experiment` | 变量控制模拟实验（可操作） |
| 5 | `page_04_q2_data` | `experiment` | `experiment` | 交互实验 + 单选题Q2 |
| 6 | `page_05_q3_trend` | `experiment` | `experiment` | 交互实验 + 单选题Q3 |
| 7 | `page_06_q4_conc` | `experiment` | `experiment` | 综合结论：判断题 + 填空题Q4 |

> **说明**：
> - 本模块共 7 个页面，其中第 1、2 页为 `hidden` 引导页
> - 左侧导航显示 5 个步骤（从第 3 页开始计数）
> - `getTotalSteps()` 返回 `5`
> - 当 `getNavigationMode(pageId) === 'hidden'` 时，`AssessmentPageFrame` 隐藏左侧导航栏

### 4.2 页码映射规则（subPageNum ↔ pageId）

**`getInitialPage(subPageNum)` 实现规则**：

```javascript
const PAGE_MAP = {
  '1': 'page_00_notice',
  '2': 'page_01_intro',
  '3': 'page_02_step_q1',
  '4': 'page_03_sim_exp',
  '5': 'page_04_q2_data',
  '6': 'page_05_q3_trend',
  '7': 'page_06_q4_conc',
};

function getInitialPage(subPageNum) {
  if (!subPageNum || !PAGE_MAP[subPageNum]) {
    console.warn(`[g8-mikania-experiment] Invalid subPageNum: ${subPageNum}, fallback to page_00_notice`);
    return 'page_00_notice';
  }
  return PAGE_MAP[subPageNum];
}

function getNavigationMode(pageId) {
  if (pageId === 'page_00_notice' || pageId === 'page_01_intro') {
    return 'hidden';  // 注意事项页和引导页不显示导航
  }
  return 'experiment';
}
```

**逆向映射（pageId → stepIndex）**：

```javascript
// stepIndex 用于左侧导航显示，hidden 页面不计入
const PAGE_TO_STEP = {
  'page_00_notice': 0,     // hidden，不占步数（注意事项页）
  'page_01_intro': 0,      // hidden，不占步数（任务背景页）
  'page_02_step_q1': 1,    // 导航第 1 步
  'page_03_sim_exp': 2,    // 导航第 2 步
  'page_04_q2_data': 3,    // 导航第 3 步
  'page_05_q3_trend': 4,   // 导航第 4 步
  'page_06_q4_conc': 5,    // 导航第 5 步
};
```

### 4.3 导航规则

- **返回上一页**：不允许。用户只能前进，不能后退。

- **点击"下一页"前的前置条件**：
  - Page 00（注意事项）：必须等待 38 秒倒计时结束，然后勾选"我已阅读并理解上述注意事项"复选框
  - Page 01（任务背景）：无条件，点击即可进入下一页
  - Page 02（Q1）：必须填写文本答案，最少 5 个字符
  - Page 03：无强制条件，但建议至少操作一次实验
  - Page 04（Q2）：必须选择一个选项
  - Page 05（Q3）：必须选择一个选项
  - Page 06（Q4）：必须完成判断题选择 + 文本答案最少 10 个字符
  - 若不满足：阻断并显示错误提示，记录 `click_blocked` 事件

- **特殊跳转规则**：无条件分支，线性顺序推进

- **步数与页面关系总结**：
  - Page 00（`page_00_notice`）为 `hidden` 注意事项页，不显示左侧导航
  - Page 01（`page_01_intro`）为 `hidden` 任务背景页，不显示左侧导航
  - 从 Page 02 开始显示共 5 步导航
  - `getTotalSteps()` 返回 `5`

### 4.4 Page 00 注意事项页详细设计

**页面内容**：

```text
注意事项
请仔细阅读

• 本科学探究共20分钟，时间结束后，系统将自动退出答题界面。
• 请按顺序回答每页问题，上一页题目未完成作答，将无法点击进入下一页
• 答题时，不要提前点击"下一页"查看后面的内容，否则将无法返回上一页
• 遇到系统故障、死机、死循环等特殊情况时，请举手示意老师。

☐ 我已阅读并理解上述注意事项

请仔细阅读注意事项，38秒后可勾选确认。
```

**交互逻辑**：

1. **阅读倒计时**：
   - 页面加载后开始 38 秒倒计时
   - 倒计时期间复选框禁用（disabled）
   - 显示剩余秒数提示："请仔细阅读注意事项，{N}秒后可勾选确认。"

2. **复选框启用**：
   - 倒计时结束后复选框变为可用
   - 提示文字变为："请勾选确认后点击下一页。"

3. **确认勾选**：
   - 用户必须勾选复选框才能点击"下一页"
   - 勾选时记录 `change` 事件：
     ```javascript
     {
       targetElement: 'P1_注意事项确认',
       eventType: 'change',
       value: 'checked',
       time: new Date().toISOString()
     }
     ```

4. **导航前置条件**：
   - 必须满足：倒计时结束 AND 复选框已勾选
   - 未满足时点击"下一页"：阻断导航，记录 `click_blocked` 事件

**状态管理**：

```javascript
// 新增状态字段
{
  noticeConfirmed: false,    // 复选框是否已勾选
  noticeCountdown: 38,       // 剩余倒计时秒数
}

// Reducer actions
case 'TICK_NOTICE_COUNTDOWN':
  return { ...state, noticeCountdown: state.noticeCountdown - 1 };
case 'CONFIRM_NOTICE':
  return { ...state, noticeConfirmed: true };
```

**样式要求**：
- 标题"注意事项"使用 H1 样式（36px / 700）
- "请仔细阅读"使用副标题样式
- 注意事项列表使用圆点符号，行距 1.8
- 复选框和标签居中显示
- 禁用状态下复选框显示灰色，鼠标显示 not-allowed

---

## 5. 计时策略（Timing Strategy）

### 5.1 默认计时配置

```javascript
getDefaultTimers: () => ({
  task: 20 * 60,  // 20分钟 = 1200秒
});
```

**计时范围说明**：
- 全部 7 个页面均属于"任务计时范围"
- 本模块不包含独立的问卷计时
- 计时从进入 Page 00（注意事项页）开始，持续到 Page 06 完成
- 注意：Page 00 的 38 秒阅读等待时间计入总计时

### 5.2 Flow 覆盖与优先级

- 当 FlowDefinition 中存在 `overrides.timers` 时，以 Flow 配置为准
- 否则使用 `getDefaultTimers` 中的默认值（20 分钟）

### 5.3 到期行为

**任务计时到期时**：
1. 自动提交当前页数据
2. 所有未回答的必填项填充 `"超时未回答"`
3. 调用 `flowContext.onTimeout()` 通知容器
4. 容器决定后续行为（进入过渡页或下一步骤）
5. 不允许用户继续浏览

> **重要**：子模块不直接决定超时后进入哪个模块，而是通过 `flowContext.onTimeout()` 回调让容器处理过渡逻辑。

---

## 6. 数据提交与事件设计（Data & Events）

### 6.1 数据格式与工具

**必须使用统一工具**：
- `createMarkObject` / `validateMarkObject`
- `encodeCompositePageNum(stepIndex, subPageNum)` 生成复合页码
- 事件枚举与字段定义以 `openspec/specs/data-format/spec.md` 为准

**MarkObject 关键字段要求**：

- **pageNumber**：使用复合编码，格式为 `M<stepIndex>:<subPageNum>`
  - 示例：`encodeCompositePageNum(flowContext.stepIndex, '2')` → `"M0:2"` 或 `"M1:2"`（取决于 Flow 配置）
  - **注意**：`stepIndex` 来自 `flowContext.stepIndex`，子模块不应硬编码

- **pageDesc**：格式为 `"[flowId/submoduleId/stepIndex] 页面描述"`
  - 示例：`"[${flowContext.flowId}/g8-mikania-experiment/${flowContext.stepIndex}] 薇甘菊防治-实验步骤"`

**复合页码生成示例**：

```javascript
import { encodeCompositePageNum } from '@/shared/types/flow';

// 在页面提交时
const pageNumber = encodeCompositePageNum(
  flowContext.stepIndex,  // 从 flowContext 获取，不要硬编码
  currentSubPageNum       // 当前子模块内页码，如 '2'
);
// 结果示例: "M0:2" 或 "M1:2"
```

**answerList 设计**：

| 页面 | code | targetElement | 预期 value 类型 |
|------|------|---------------|----------------|
| P02 | 1 | `P${pageNumber}_Q1_控制变量原因` | 文本（最少5字符） |
| P04 | 2 | `P${pageNumber}_Q2_抑制作用浓度` | 选项标签（A/B/C） |
| P05 | 3 | `P${pageNumber}_Q3_发芽率趋势` | 选项标签（A/B/C） |
| P06 | 4 | `P${pageNumber}_Q4a_菟丝子有效性` | 选项标签（是/否） |
| P06 | 5 | `P${pageNumber}_Q4b_结论理由` | 文本（最少10字符） |

> **targetElement 命名规则**：使用 `P${pageNumber}_` 前缀，其中 `pageNumber` 为复合页码。
> 示例：`P${encodeCompositePageNum(stepIndex, '2')}_Q1_控制变量原因` → `"PM0:2_Q1_控制变量原因"`

### 6.2 operationList 事件类型与字段结构

**通用字段结构**：

```typescript
interface Operation {
  targetElement: string;  // 目标元素标识
  eventType: string;      // 事件类型
  value: string;          // 事件值（复杂数据使用 JSON.stringify）
  time: string;           // ISO 8601 时间戳
}
```

**必需事件**：

| 事件名 | targetElement | value 格式 | 触发时机 |
|--------|--------------|------------|---------|
| `page_enter` | `'页面'` | `pageId` 字符串 | 页面组件首次挂载 |
| `page_exit` | `'页面'` | `pageId` 字符串 | 离开当前页面 |

**答题事件**：

| 事件名 | targetElement | value 格式 | 触发时机 |
|--------|--------------|------------|---------|
| `change` | 题目标识，如 `'Q1_控制变量原因'` | 用户输入/选择的值 | 学生修改答案 |
| `click_blocked` | `'下一页按钮'` | JSON: `{"reason": "必填项未完成", "missing": ["Q1"]}` | 点击"下一步"但校验未通过 |

**实验操作事件**：

| 事件名 | targetElement | value 格式 | 触发时机 |
|--------|--------------|------------|---------|
| `exp_start` | `'实验面板-开始按钮'` | JSON: `{"concentration": "10mg/ml", "days": 5}` | 点击【开始】按钮 |
| `exp_reset` | `'实验面板-重置按钮'` | JSON: `{"previousConcentration": "10mg/ml", "previousDays": 5}` | 点击【重置】按钮 |
| `exp_param_change` | `'实验面板-浓度选择'` 或 `'实验面板-天数调整'` | JSON: `{"param": "concentration", "oldValue": "0mg/ml", "newValue": "5mg/ml"}` | 修改实验参数 |
| `click` | 按钮业务标识 | 按钮名称或动作描述 | 点击普通按钮 |

**实验操作事件代码示例**：

```javascript
// 开始实验
logOperation({
  targetElement: '实验面板-开始按钮',
  eventType: 'exp_start',
  value: JSON.stringify({
    concentration: '10mg/ml',
    days: 5,
    expectedRate: 45  // 预期发芽率
  }),
  time: new Date().toISOString()
});

// 修改浓度参数
logOperation({
  targetElement: '实验面板-浓度选择',
  eventType: 'exp_param_change',
  value: JSON.stringify({
    param: 'concentration',
    oldValue: '0mg/ml',
    newValue: '5mg/ml'
  }),
  time: new Date().toISOString()
});

// 修改天数参数
logOperation({
  targetElement: '实验面板-天数调整',
  eventType: 'exp_param_change',
  value: JSON.stringify({
    param: 'days',
    oldValue: 1,
    newValue: 5
  }),
  time: new Date().toISOString()
});

// 重置实验
logOperation({
  targetElement: '实验面板-重置按钮',
  eventType: 'exp_reset',
  value: JSON.stringify({
    previousConcentration: '10mg/ml',
    previousDays: 5
  }),
  time: new Date().toISOString()
});

// 答案变更
logOperation({
  targetElement: 'Q2_抑制作用浓度',
  eventType: 'change',
  value: 'C',  // 选项标签
  time: new Date().toISOString()
});

// 点击被阻断
logOperation({
  targetElement: '下一页按钮',
  eventType: 'click_blocked',
  value: JSON.stringify({
    reason: '必填项未完成',
    missing: ['Q1_控制变量原因']
  }),
  time: new Date().toISOString()
});
```

### 6.3 提交时机与失败处理

**提交触发点**：
1. **点击"下一页"时**：
   - 收集当前页全部答案
   - 补齐未答占位（手动翻页未答：`"未回答"`）
   - 使用 `encodeCompositePageNum(flowContext.stepIndex, subPageNum)` 生成 `pageNumber`
   - 构造 `MarkObject`（必须包含完整的 `operationList` 和 `answerList`）
   - 调用 `usePageSubmission.submit()`
   - 提交成功后：
     - **非最后一页**：调用 `flowContext.updateModuleProgress(nextSubPageNum)` 更新进度，然后导航到下一页
     - **最后一页**：直接调用 `flowContext.onComplete()`，不更新进度

2. **计时器到期自动提交时**：
   - 收集当前页答案
   - 未答填 `"超时未回答"`
   - 构造完整的 `MarkObject`
   - 提交后调用 `flowContext.onTimeout()` 通知容器

**完整提交参数结构**：

```javascript
// 题目固定编码映射（必须与 6.1 节 answerList 设计表一致）
const QUESTION_CODE_MAP = {
  'Q1_控制变量原因': 1,
  'Q2_抑制作用浓度': 2,
  'Q3_发芽率趋势': 3,
  'Q4a_菟丝子有效性': 4,
  'Q4b_结论理由': 5,
};

// submitPageData 完整调用示例
const submitPageData = async ({ isTimeout = false } = {}) => {
  const currentSubPageNum = getPageNumByPageId(currentPageId);
  const stepIndex = flowContext?.stepIndex ?? 0;
  const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);

  // 构造 MarkObject
  const markObject = {
    pageNumber,
    pageDesc: flowContext
      ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] ${getPageTitle(currentPageId)}`
      : getPageTitle(currentPageId),
    operationList: [
      // 必须包含 page_enter 和 page_exit
      ...pageOperations,
      // 用户交互事件（change, click, exp_start 等）
      ...userInteractionEvents
    ],
    answerList: [
      // 当前页的所有答案
      // 每个答案包含 code, targetElement, value
      // 注意：code 必须使用固定映射，不能用页内序号
      ...pageAnswers.map((answer) => ({
        code: QUESTION_CODE_MAP[answer.questionId],  // 使用固定映射: Q1→1, Q2→2, Q3→3, Q4a→4, Q4b→5
        targetElement: `P${pageNumber}_${answer.questionId}`,
        value: answer.value || (isTimeout ? '超时未回答' : '未回答')
      }))
    ],
    beginTime: formatDateTime(pageEnterTime),
    endTime: formatDateTime(new Date()),
    imgList: []
  };

  // 调用提交 Hook
  await usePageSubmission.submit({
    batchCode: userContext.user.batchCode,
    examNo: userContext.user.examNo,
    mark: JSON.stringify(markObject)
  });
};
```

**提交失败处理**：
- 网络错误/服务端错误：使用统一错误托盘显示，阻断导航，允许重试
- 401/会话过期：调用 `handleSessionExpired`，清理状态并回登录

---

## 7. Flow 集成与进度恢复（Flow Integration）

### 7.1 flowContext API 说明

子模块通过 `props.flowContext` 与 Flow 容器交互，包含以下接口：

| API | 类型 | 说明 |
|-----|------|-----|
| `flowId` | `string` | 当前 Flow 的唯一标识 |
| `stepIndex` | `number` | 当前步骤在 Flow 中的索引（从 0 开始） |
| `submoduleId` | `string` | 当前子模块 ID |
| `modulePageNum` | `string \| null` | 恢复时的子模块内页码 |
| `onComplete()` | `() => void` | 子模块完成时调用，通知容器进入过渡页或下一步骤 |
| `onTimeout()` | `() => void` | 计时器到期时调用，通知容器处理超时逻辑 |
| `updateModuleProgress(modulePageNum)` | `(string) => void` | 更新子模块内进度，用于页面切换时持久化 |

### 7.2 从进度到页面的映射

**恢复流程**：
1. Flow 容器提供：`flowContext.stepIndex` 和 `flowContext.modulePageNum`
2. FlowModule 调用：`getInitialPage(modulePageNum)` → 得到 `initialPageId`
3. 子模块使用 `initialPageId` 渲染对应页面

**代码示例**：

```javascript
const MikaniaExperimentComponent = ({ userContext, initialPageId, flowContext }) => {
  const [currentPageId, setCurrentPageId] = useState(initialPageId);

  // 页面切换时更新进度
  const navigateToPage = (nextPageId) => {
    const nextSubPageNum = getSubPageNum(nextPageId);  // pageId → subPageNum

    // 通知 Flow 容器更新进度（用于刷新恢复）
    flowContext?.updateModuleProgress?.(nextSubPageNum);

    setCurrentPageId(nextPageId);
  };

  // ...
};
```

### 7.3 完成判定逻辑

**本子模块何时算"完成"**：
- 到达 Page 06（`page_06_q4_conc`）并成功提交数据

**完成后行为**：

```javascript
const handleLastPageSubmit = async () => {
  // 1. 收集当前页答案并构造完整 MarkObject
  const currentSubPageNum = getPageNumByPageId(currentPageId); // '6'
  const stepIndex = flowContext?.stepIndex ?? 0;
  const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);

  const markObject = {
    pageNumber,
    pageDesc: flowContext
      ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] 薇甘菊防治-结论与验证`
      : '薇甘菊防治-结论与验证',
    operationList: [...pageOperations, ...userInteractionEvents],
    answerList: pageAnswers.map((answer, index) => ({
      code: index + 1,
      targetElement: `P${pageNumber}_${answer.questionId}`,
      value: answer.value || '未回答'
    })),
    beginTime: formatDateTime(pageEnterTime),
    endTime: formatDateTime(new Date()),
    imgList: []
  };

  // 2. 提交数据
  await usePageSubmission.submit({
    batchCode: userContext.user.batchCode,
    examNo: userContext.user.examNo,
    mark: JSON.stringify(markObject)
  });

  // 3. 调用 flowContext.onComplete() 通知容器
  // 重要：最后一页不调用 updateModuleProgress，避免进度回退
  flowContext?.onComplete?.();

  // 4. 容器决定后续行为（进入过渡页或下一步骤）
  // 子模块不直接控制跳转目标
};
```

> **重要说明**：
> - **最后一页提交后不调用 `updateModuleProgress`**：完成后由 Flow 容器接管控制，若在 `onComplete` 之前更新进度可能导致刷新恢复异常
> - **Flow 无关原则**：子模块不假设完成后会进入哪个模块，而是通过 `flowContext.onComplete()` 让容器决定

### 7.4 超时处理

```javascript
const handleTimeout = async () => {
  // 1. 收集当前页答案并构造 MarkObject
  const currentSubPageNum = getPageNumByPageId(currentPageId);
  const stepIndex = flowContext?.stepIndex ?? 0;
  const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);

  const markObject = {
    pageNumber,
    pageDesc: flowContext
      ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] ${getPageTitle(currentPageId)}`
      : getPageTitle(currentPageId),
    operationList: [...pageOperations, ...userInteractionEvents],
    answerList: pageAnswers.map((answer, index) => ({
      code: index + 1,
      targetElement: `P${pageNumber}_${answer.questionId}`,
      value: answer.value || '超时未回答'  // 超时标记
    })),
    beginTime: formatDateTime(pageEnterTime),
    endTime: formatDateTime(new Date()),
    imgList: []
  };

  // 2. 提交数据
  await usePageSubmission.submit({
    batchCode: userContext.user.batchCode,
    examNo: userContext.user.examNo,
    mark: JSON.stringify(markObject)
  });

  // 3. 调用 flowContext.onTimeout() 通知容器
  flowContext?.onTimeout?.();

  // 4. 容器决定后续行为
};
```

### 7.5 Flow 覆盖配置的支持

- 当前实现支持 `options.timers` 覆盖
- 规范上可扩展 `options.variant` 等字段
- 子模块应优先使用 `options` 中的配置，其次使用 `getDefaultTimers()` 默认值

---

## 8. 本地存储与状态管理（Local State & Persistence）

### 8.1 状态管理方式

使用 React Context + Reducer 管理模块内状态：

```javascript
// MikaniaExperimentContext
const initialState = {
  currentPageId: 'page_00_notice',
  answers: {},           // { questionId: value }
  experimentState: {     // 实验面板状态
    concentration: '0mg/ml',
    days: 1,
    hasStarted: false,
    currentResult: null
  },
  noticeConfirmed: false, // 注意事项确认状态
  noticeCountdown: 38,    // 注意事项阅读倒计时（秒）
  operations: []
};
```

### 8.2 存储命名空间

使用的 localStorage key：
- `module.g8-mikania-experiment.answers` - 已作答答案草稿
- `module.g8-mikania-experiment.experimentState` - 实验面板状态
- `module.g8-mikania-experiment.lastPageId` - 最后访问页面（备用）

### 8.3 刷新恢复策略

1. 从持久化状态中读取答案草稿并回填 UI
2. 恢复实验面板的参数状态
3. `initialPageId` 以 Flow 容器传入的为准（基于 `flowContext.modulePageNum`）
4. 子模块不自行从 localStorage 读取页码跳转

---

## 9. 错误处理与边界情况（Error Handling & Edge Cases）

### 9.1 初始化失败

- **行为**：显示统一错误 UI（"加载失败/重试"组件）
- 提供"重试"按钮，再次加载数据

### 9.2 非法页码 / 配置错误

- `subPageNum` 超出范围（1-7）：记录错误日志，回退到 `page_00_notice`
- 未找到 `pageId`：回退到首页（`page_00_notice`）

### 9.3 401/会话过期

- 一律交给统一 `handleSessionExpired`
- 清空状态并回登录
- 子模块不得覆盖该行为

### 9.4 网络波动与重试

- 使用 `usePageSubmission` 内部的重试机制（指数退避，最多 3 次）
- UI 显示"正在重试 / 请稍后重试"

### 9.5 实验数据边界

- 浓度必须为 `0mg/ml`、`5mg/ml`、`10mg/ml` 之一
- 天数必须为 1-7 整数
- 超出范围时使用默认值并记录警告

### 9.6 flowContext 缺失（独立调试模式）

当 `flowContext` 为 `undefined` 时，子模块进入**独立调试模式**，此模式仅用于开发调试，不应在生产环境出现。

**独立调试模式的行为规范**：

1. **pageNumber 生成**：
   - 使用固定 `stepIndex = 0`
   - 格式：`encodeCompositePageNum(0, subPageNum)` → `"M0:1"`、`"M0:2"` 等

2. **pageDesc 生成**：
   - 不使用 Flow 前缀，直接使用页面中文描述
   - 格式：`"薇甘菊防治-任务背景"`（而非 `"[flowId/submoduleId/stepIndex] ..."`）

3. **进度 API 调用**：
   - **不调用** `updateModuleProgress`（因为没有 Flow 容器管理进度）
   - **不调用** `onComplete` 和 `onTimeout`（因为没有回调目标）

4. **导航行为**：
   - 页面间导航仍正常工作
   - 最后一页提交后，子模块保持在当前页面（无法跳转到下一步骤）

5. **数据提交**：
   - 仍然调用 `usePageSubmission.submit()` 提交数据到后端
   - 提交格式与 Flow 模式一致，便于后端统一处理

**代码示例**：

```javascript
// 检查 flowContext 是否存在
const isFlowMode = !!flowContext;

// 生成 pageNumber
const stepIndex = flowContext?.stepIndex ?? 0;
const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);

// 生成 pageDesc
const pageDesc = isFlowMode
  ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] ${pageTitle}`
  : pageTitle;  // 独立模式直接使用页面标题

// 页面切换时
if (isFlowMode && nextPageId) {
  flowContext.updateModuleProgress(getPageNumByPageId(nextPageId));
}
// 独立模式不调用 updateModuleProgress

// 完成时
if (isFlowMode) {
  flowContext.onComplete?.();
}
// 独立模式不调用 onComplete
```

> **注意**：独立调试模式的 `pageNumber` 始终以 `M0:` 开头，后端可据此识别非 Flow 提交数据。验收测试应主要覆盖 Flow 模式，独立模式仅用于开发自测。

---

## 10. 视觉与交互规范（UI & UX Constraints）

### 10.1 统一部分（不可覆盖）

- 页面外壳布局（左右结构 + 顶部计时 + 底部下一页按钮）
- 左侧导航（圆点 + 步数显示）样式与逻辑
- 计时器位置与基本样式
- 全局错误托盘组件

### 10.2 可自定义部分

- 主体区域的内容布局与控件
- 实验面板的交互动画（滴管、培养皿、种子生长）
- 题目区域的样式

### 10.3 关键交互约束

- **"下一页/提交"按钮**：不得自己实现，必须通过容器提供的回调完成
- **键盘快捷键**：暂无特殊快捷键需求

### 10.4 颜色系统

必须使用统一 CSS 变量：
- 主色：`--cartoon-primary: #59c1ff`
- 次色：`--cartoon-secondary: #ffce6b`
- 边框色：`--cartoon-border: #ffd99e`
- 成功绿：`--cartoon-green: #67d5b5`
- 警告红：`--cartoon-red: #ff8a80`

### 10.5 内容区域布局

子模块内容渲染在 Flow 框架右侧内容区域：
- 标准宽度：1200px
- 标准高度：800px
- 内边距：40px
- 可用内容宽度：1120px
- 可用内容高度：720px

**常用布局模式**：
- Page 00（注意事项）：单栏居中布局（任务封面页）
- Page 01（背景介绍）：单栏居中布局（引导页）
- Page 02-06：左右分栏（实验/资料 + 答题区）

### 10.6 排版规范

- 字体：系统默认字体栈
- H1 标题：36px / 700 / 1.4
- 正文：16px / 400 / 1.6
- 中文段落：两端对齐，首行缩进 2em

### 10.7 实验面板特殊设计

**培养皿动画要求**：
- 单个培养皿 SVG 容器
- 种子显示根据发芽率数据动态变化
- 发芽/未发芽种子使用不同图标

**滴管动画要求**：
- 点击【开始】后播放滴管移动到培养皿上方
- 显示液滴落下动作
- 动画时长：标准 0.3s ease

**视觉反馈**：
- 浓度越高，发芽种子越少
- 天数增加，发芽数量增多
- 实时显示发芽率百分比数值

> **参考实现**：完整的 SVG 动画实验代码请参考 `docs/SVG动画参考/薇甘菊实验.html`，该文件包含：
> - 完整的布局结构（三栏式：浓度选择 + 实验区 + 结果显示）
> - SVG 培养皿和滴管动画实现
> - 种子发芽动画逻辑
> - 数据模型和控制逻辑
>
> 开发时应直接复用该参考文件的代码结构，转换为 React 组件实现。

---

## 附录 D：SVG 实验面板参考实现

> **重要**：以下代码直接来源于 `docs/SVG动画参考/薇甘菊实验.html`，开发时应**完整复制**此结构进行 React 组件化改造。

### D.1 核心数据模型

```javascript
// 发芽率数据模型（必须严格遵循）
const germinationData = {
    1: { 0: 0, 5: 0, 10: 0 },
    2: { 0: 45, 5: 15, 10: 10 },
    3: { 0: 68, 5: 30, 10: 22 },
    4: { 0: 72, 5: 40, 10: 35 },
    5: { 0: 75, 5: 50, 10: 45 },
    6: { 0: 78, 5: 55, 10: 50 },
    7: { 0: 78, 5: 60, 10: 55 }
};
```

### D.2 完整 HTML 布局结构

```html
<div class="main-container">

    <!-- 左侧面板：标题 + 按钮组 (垂直紧凑排列) -->
    <div class="sidebar-panel" style="grid-column: 1/2; grid-row: 1/2;">
        <div class="panel-title">菟丝子水浸液浓度</div>
        <div class="controls-conc-group">
            <input type="radio" id="conc-0" name="concentration" value="0" class="radio-btn">
            <label for="conc-0" class="conc-label">0mg/ml</label>

            <input type="radio" id="conc-5" name="concentration" value="5" class="radio-btn">
            <label for="conc-5" class="conc-label">5mg/ml</label>

            <input type="radio" id="conc-10" name="concentration" value="10" class="radio-btn">
            <label for="conc-10" class="conc-label">10mg/ml</label>
        </div>
    </div>

    <!-- 中间：SVG 实验区 -->
    <div class="experiment-area">
        <svg id="experiment-svg" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
            <!-- SVG 内容见 D.3 节 -->
        </svg>
    </div>

    <!-- 右侧面板：标题 + 结果 -->
    <div class="sidebar-panel" style="grid-column: 3/4; grid-row: 1/2;">
        <div class="panel-title">薇甘菊发芽率</div>
        <div class="result-box" id="result-rate">--%</div>
    </div>

    <!-- 底部：控制栏 -->
    <div class="controls-bottom">
        <button class="btn-action btn-reset" onclick="resetExperiment()">重置</button>

        <div class="days-control">
            <div class="days-panel">
                <div class="days-btns">
                    <button class="btn-tiny" onclick="changeDays(1)">▲</button>
                    <button class="btn-tiny" onclick="changeDays(-1)">▼</button>
                </div>
                <div class="days-display"><span id="day-display">1</span>h</div>
            </div>
            <div style="margin-top:5px; font-weight:bold; font-size: 14px;">天数</div>
        </div>

        <button class="btn-action btn-start" id="btn-start" onclick="startExperiment()">开始</button>
    </div>

</div>
```

### D.3 完整 CSS 样式

```css
/* 16.1 视觉色彩系统标准 */
:root {
    --cartoon-primary: #59c1ff;
    --cartoon-secondary: #ffce6b;
    --cartoon-border: #ffd99e;
    --cartoon-green: #67d5b5;
    --cartoon-red: #ff8a80;
    --text-color: #333333;
    --text-secondary: #666666;
    --background-color: #f5f5f5;
    --card-background: #ffffff;
    --cartoon-shadow: rgba(0, 0, 0, 0.1);
}

body {
    font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
}

/* 主容器 - 布局重构 */
.main-container {
    position: relative;
    width: 760px;
    height: 500px;
    background-color: var(--card-background);
    border: 8px solid #bdc3c7;
    border-radius: 30px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: grid;
    grid-template-columns: 170px 1fr 170px;
    grid-template-rows: 1fr 70px;
    gap: 10px;
    align-items: center;
    justify-items: center;
}

/* 通用侧边栏容器 */
.sidebar-panel {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

/* 标题样式 */
.panel-title {
    font-size: 18px;
    font-weight: bold;
    color: #000;
    text-shadow: 0 1px 0 rgba(255,255,255,0.8);
    white-space: nowrap;
    text-align: center;
}

/* 左侧：浓度选择组 */
.controls-conc-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    align-items: center;
}

.radio-btn { display: none; }

.conc-label {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 40px;
    background: linear-gradient(to bottom, #ffe0b2, #ffcc80);
    border-radius: 8px;
    color: #5d4037;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.2s;
    border: 2px solid #fff;
}

.radio-btn:checked + .conc-label {
    border-color: #e65100;
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(230, 81, 0, 0.2);
    background: linear-gradient(to bottom, #ffcc80, #ffb74d);
}

/* 右侧：结果显示 */
.result-box {
    width: 120px;
    padding: 20px 0;
    background: linear-gradient(to bottom, #c8e6c9, #a5d6a7);
    border-radius: 12px;
    text-align: center;
    font-size: 32px;
    font-weight: 900;
    color: #1b5e20;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border: 3px solid #fff;
    text-shadow: 0 1px 0 rgba(255,255,255,0.5);
}

/* 中间：实验区 */
.experiment-area {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: visible;
}

#experiment-svg {
    width: 100%;
    height: 100%;
    max-width: 420px;
    max-height: 420px;
}

/* 底部：操作栏 */
.controls-bottom {
    grid-column: 1 / 4;
    grid-row: 2 / 3;
    display: flex;
    gap: 50px;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding-top: 10px;
    border-top: 2px dashed #e0e0e0;
}

.btn-action {
    width: 120px;
    height: 44px;
    border: none;
    border-radius: 22px;
    font-size: 18px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 0 #0277bd;
    transition: transform 0.1s, box-shadow 0.1s;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to bottom, #4fc3f7, #039be5);
}

.btn-action:active {
    transform: translateY(4px);
    box-shadow: none;
}

.btn-reset { filter: hue-rotate(180deg); box-shadow: 0 4px 0 #c62828; }
.btn-start:disabled { background: #cfd8dc; box-shadow: none; cursor: not-allowed; color: #90a4ae; }

/* 天数控制器 */
.days-control {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.days-panel {
    background: #37474f;
    padding: 5px 15px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
    border: 2px solid #546e7a;
}

.days-display {
    background: #fff;
    color: #000;
    font-size: 22px;
    font-weight: bold;
    padding: 2px 15px;
    border-radius: 4px;
    min-width: 30px;
    text-align: center;
}

.days-btns {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.btn-tiny {
    width: 24px;
    height: 18px;
    background: #b0bec5;
    border: none;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 2px;
}
.btn-tiny:hover { background: #fff; }
```

### D.4 SVG 结构

```html
<svg id="experiment-svg" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
            <feOffset dx="2" dy="2" result="offsetblur"/>
            <feComponentTransfer>
                <feFuncA type="linear" slope="0.3"/>
            </feComponentTransfer>
            <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
    </defs>

    <!-- 培养皿容器 -->
    <g transform="translate(200, 310)">
        <ellipse cx="0" cy="10" rx="145" ry="65" fill="rgba(0,0,0,0.15)" />
        <ellipse cx="0" cy="0" rx="150" ry="70" fill="#f5f5f5" stroke="#cfd8dc" stroke-width="3" />
        <ellipse cx="0" cy="5" rx="140" ry="60" fill="#5d4037" />
        <circle cx="-50" cy="-20" r="2" fill="#3e2723" opacity="0.4"/>
        <circle cx="60" cy="30" r="3" fill="#3e2723" opacity="0.4"/>
        <circle cx="20" cy="-40" r="2" fill="#3e2723" opacity="0.4"/>
    </g>

    <!-- 种子层 -->
    <g id="seeds-layer" transform="translate(200, 310)"></g>

    <!-- 水滴 -->
    <circle id="water-drop" cx="0" cy="0" r="0" class="drop" />

    <!-- 滴管组 -->
    <g id="dropper-group">
        <!-- 胶头 -->
        <g id="dropper-bulb">
            <path d="M-16,-80 Q-25,-100 0,-120 Q25,-100 16,-80 Z" fill="#d32f2f" />
            <rect x="-16" y="-80" width="32" height="10" rx="2" fill="#d32f2f" />
        </g>
        <!-- 玻璃管 -->
        <g id="dropper-body">
            <rect x="-8" y="-70" width="16" height="100" fill="rgba(255,255,255,0.9)" stroke="#90a4ae" stroke-width="1.5"/>
            <line x1="-4" y1="-50" x2="4" y2="-50" stroke="#90a4ae" stroke-width="1"/>
            <line x1="-4" y1="-30" x2="4" y2="-30" stroke="#90a4ae" stroke-width="1"/>
            <line x1="-4" y1="-10" x2="4" y2="-10" stroke="#90a4ae" stroke-width="1"/>
            <rect x="-6" y="-20" width="12" height="60" fill="#ef5350" opacity="0.8" />
            <path d="M-8,30 L-2,50 L2,50 L8,30 Z" fill="rgba(255,255,255,0.9)" stroke="#90a4ae" stroke-width="1.5"/>
            <path d="M-6,30 L-1,48 L1,48 L6,30 Z" fill="#ef5350" opacity="0.8" />
        </g>
    </g>
</svg>
```

### D.5 CSS 动画定义

```css
/* 滴管组初始状态与移动动画 */
#dropper-group {
    transform: translate(200px, 140px) scale(1.4);
    transform-box: fill-box;
    transform-origin: center center;
    transition: transform 0.5s ease;
}

.dropper-move-action {
    animation: dropperMove 2.5s forwards;
}

@keyframes dropperMove {
    0% { transform: translate(200px, 140px) scale(1.4); }
    30% { transform: translate(200px, 220px) scale(1.4); }
    70% { transform: translate(200px, 220px) scale(1.4); }
    100% { transform: translate(200px, 140px) scale(1.4); }
}

/* 胶头挤压动画 */
#dropper-bulb {
    transform-origin: 0px -70px;
}

.bulb-squeeze-action {
    animation: bulbSqueeze 0.6s ease-in-out 0.8s forwards;
}

@keyframes bulbSqueeze {
    0% { transform: scale(1, 1); }
    50% { transform: scale(1.1, 0.85); }
    100% { transform: scale(1, 1); }
}

/* 水滴动画 */
.drop { opacity: 0; fill: #ef5350; }

.drop-falling-action {
    animation: dropFullProcess 1.2s linear 0.8s forwards;
}

@keyframes dropFullProcess {
    0% {
        opacity: 1;
        transform: translate(200px, 270px);
        r: 0;
    }
    15% { r: 8; }
    80% {
        opacity: 1;
        transform: translate(200px, 305px);
        r: 8;
    }
    100% {
        opacity: 0;
        transform: translate(200px, 315px);
        r: 12;
    }
}

/* 种子与发芽样式 */
.seed-base { fill: #795548; }

.sprout-group {
    transform-origin: 0px 0px;
    transform: scale(0);
    opacity: 0;
    transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 1s;
}

.sprout-stem { fill: none; stroke: #8bc34a; stroke-width: 2; stroke-linecap: round; }
.sprout-leaf { fill: #4caf50; }
```

### D.6 核心 JavaScript 逻辑

```javascript
let currentDays = 1;
let currentConc = null;
let isAnimating = false;
const totalSeeds = 60;
const seedsArray = [];

// 初始化种子
function initSeeds() {
    const container = document.getElementById('seeds-layer');
    container.innerHTML = '';
    seedsArray.length = 0;
    const rx = 120; const ry = 50;
    const positions = [];
    for (let i = 0; i < totalSeeds; i++) {
        const angle = Math.random() * Math.PI * 2;
        const r = Math.sqrt(Math.random());
        const x = r * rx * Math.cos(angle);
        const y = r * ry * Math.sin(angle);
        positions.push({x, y});
    }
    positions.sort((a, b) => a.y - b.y);
    positions.forEach(pos => { createSeedElement(container, pos.x, pos.y); });
}

// 创建单个种子元素
function createSeedElement(container, x, y) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("transform", `translate(${x}, ${y})`);

    const seed = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
    seed.setAttribute("cx", 0); seed.setAttribute("cy", 0);
    seed.setAttribute("rx", 4); seed.setAttribute("ry", 2.5);
    seed.setAttribute("class", "seed-base");
    seed.setAttribute("transform", `rotate(${Math.random() * 180})`);

    const sproutGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
    sproutGroup.setAttribute("class", "sprout-group");

    const stem = document.createElementNS("http://www.w3.org/2000/svg", "path");
    stem.setAttribute("d", "M0,0 Q-2,-10 0,-20");
    stem.setAttribute("class", "sprout-stem");

    const leafL = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
    leafL.setAttribute("cx", -5); leafL.setAttribute("cy", -20);
    leafL.setAttribute("rx", 5); leafL.setAttribute("ry", 2.5);
    leafL.setAttribute("transform", "rotate(-30 -5 -20)");
    leafL.setAttribute("class", "sprout-leaf");

    const leafR = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
    leafR.setAttribute("cx", 5); leafR.setAttribute("cy", -20);
    leafR.setAttribute("rx", 5); leafR.setAttribute("ry", 2.5);
    leafR.setAttribute("transform", "rotate(30 5 -20)");
    leafR.setAttribute("class", "sprout-leaf");

    sproutGroup.appendChild(stem);
    sproutGroup.appendChild(leafL);
    sproutGroup.appendChild(leafR);
    g.appendChild(seed);
    g.appendChild(sproutGroup);
    container.appendChild(g);
    seedsArray.push({ group: g, sprout: sproutGroup });
}

// 开始实验
function startExperiment() {
    if (isAnimating || currentConc === null) return;
    isAnimating = true;
    disableControls(true);
    resetExperimentVisuals();

    const targetRate = germinationData[currentDays][currentConc];
    const seedsToSproutCount = Math.round((targetRate / 100) * totalSeeds);

    const dropper = document.getElementById('dropper-group');
    const bulb = document.getElementById('dropper-bulb');
    const drop = document.getElementById('water-drop');

    void dropper.offsetWidth; // 强制重排

    dropper.classList.add('dropper-move-action');
    bulb.classList.add('bulb-squeeze-action');
    drop.classList.add('drop-falling-action');

    setTimeout(() => { animateSprouting(seedsToSproutCount); }, 2200);

    setTimeout(() => {
        document.getElementById('result-rate').textContent = targetRate + "%";
        isAnimating = false;
        disableControls(false);
    }, 3500);
}

// 发芽动画
function animateSprouting(count) {
    const shuffledIndices = Array.from({length: totalSeeds}, (_, i) => i)
        .sort(() => 0.5 - Math.random());
    const activeIndices = shuffledIndices.slice(0, count);
    activeIndices.forEach(idx => {
        const sprout = seedsArray[idx].sprout;
        sprout.style.opacity = "1";
        const randomScale = 0.8 + Math.random() * 0.5;
        sprout.style.transform = `scale(${randomScale})`;
    });
}

// 重置实验
function resetExperiment() {
    if (isAnimating) return;

    resetExperimentVisuals();
    currentDays = 1;
    currentConc = null;

    document.getElementById('day-display').textContent = currentDays;
    document.getElementById('result-rate').textContent = "--%";
    document.querySelectorAll('input[name="concentration"]').forEach(r => r.checked = false);

    updateUIState();
}

// 重置视觉效果
function resetExperimentVisuals() {
    seedsArray.forEach(obj => {
        obj.sprout.style.opacity = "0";
        obj.sprout.style.transform = "scale(0)";
    });
    document.getElementById('dropper-group').classList.remove('dropper-move-action');
    document.getElementById('dropper-bulb').classList.remove('bulb-squeeze-action');
    document.getElementById('water-drop').classList.remove('drop-falling-action');
    document.getElementById('result-rate').textContent = "--%";
}
```

### D.7 React 组件化建议

将上述代码转换为 React 组件时，建议：

1. **状态管理**：使用 `useState` 管理 `currentDays`、`currentConc`、`isAnimating`
2. **副作用**：使用 `useEffect` 进行种子初始化
3. **Ref**：使用 `useRef` 获取 SVG DOM 元素引用
4. **CSS-in-JS**：将 CSS 动画转换为 CSS Modules
5. **事件处理**：将 `onclick` 转换为 React 事件处理函数

**组件结构示例**：

```jsx
// src/submodules/g8-mikania-experiment/components/ExperimentPanel/index.jsx

import React, { useState, useEffect, useRef } from 'react';
import styles from './ExperimentPanel.module.css';
import { germinationData } from '../../utils/experimentData';

const ExperimentPanel = ({ onExperimentStart, onExperimentReset, onParamChange }) => {
  const [currentDays, setCurrentDays] = useState(1);
  const [currentConc, setCurrentConc] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [resultRate, setResultRate] = useState(null);

  const seedsLayerRef = useRef(null);
  const dropperRef = useRef(null);
  const bulbRef = useRef(null);
  const dropRef = useRef(null);
  const seedsArrayRef = useRef([]);

  useEffect(() => {
    initSeeds();
  }, []);

  // ... 其余逻辑参考上述 JavaScript 代码

  return (
    <div className={styles.mainContainer}>
      {/* 左侧浓度选择 */}
      <div className={styles.sidebarPanel}>
        {/* ... */}
      </div>

      {/* 中间 SVG 实验区 */}
      <div className={styles.experimentArea}>
        <svg viewBox="0 0 400 400">
          {/* ... SVG 内容 */}
        </svg>
      </div>

      {/* 右侧结果显示 */}
      <div className={styles.sidebarPanel}>
        {/* ... */}
      </div>

      {/* 底部控制栏 */}
      <div className={styles.controlsBottom}>
        {/* ... */}
      </div>
    </div>
  );
};

export default ExperimentPanel;
```

---

## 11. 配置项与扩展性（Options & Extensibility）

### 11.1 配置项列表

| 配置项名 | 类型 | 默认值 | 说明 |
|---------|------|--------|-----|
| `timers.task` | `number` | `1200` | 任务总时长（秒） |

### 11.2 约束与说明

- 所有配置项有合理默认值，保证在 `options` 为空时模块仍可正常运行
- 本模块暂不支持题目变体（variant）

---

## 12. 日志与埋点要求（Logging & Telemetry）

### 12.1 必需埋点

**flow_context 埋点职责说明**：

`flow_context` 事件由 **`usePageSubmission` Hook 自动注入**，具体机制如下：

1. **注入时机**：当子模块调用 `usePageSubmission.submit()` 时，Hook 内部会检查是否为当前 step 的首次提交
2. **注入方式**：Hook 自动将 `flow_context` 事件追加到 `operationList` 中
3. **子模块职责**：
   - **无需**手动创建 `flow_context` 事件
   - **无需**在 `operationList` 中预留位置
   - **需要**确保不覆盖或删除已有的 `operationList` 内容
4. **验收检查**：验收时检查 `operationList` 中是否存在 `eventType = 'flow_context'` 的记录，用于验证 Hook 注入机制正常工作

**子模块必须记录的业务事件**：

- **进入页面**：`page_enter` - 页面组件首次挂载时记录
- **离开页面**：`page_exit` - 离开当前页面时记录
- **用户交互**：`change`、`click`、`exp_start` 等业务事件
- **点击阻断**：`click_blocked` - 校验未通过时记录
- **异常中断**：提交连续失败时记录异常事件

**容器记录的事件**：

- **完成子模块**：最后一页提交成功后，由 Flow 容器在过渡页记录完成事件

### 12.2 字段要求

所有关键埋点包含：
- `flowId`（来自 `flowContext.flowId`，独立模式时为空或 `'standalone'`）
- `submoduleId`: `g8-mikania-experiment`
- `stepIndex`（来自 `flowContext.stepIndex`，独立模式时为 `0`）
- `pageNumber`（使用 `encodeCompositePageNum` 生成）
- `examNo`（来自 userContext）
- `batchCode`（来自 userContext）

### 12.3 flow_context 事件结构

由 `usePageSubmission` 自动注入的 `flow_context` 事件结构如下：

```javascript
{
  targetElement: '页面',
  eventType: 'flow_context',
  value: {
    flowId: 'flow-xxx',
    stepIndex: 1,
    submoduleId: 'g8-mikania-experiment',
    moduleName: '8年级薇甘菊防治-交互实验'
  },
  time: '2025-11-19T10:30:00.000Z'
}
```

> **重要**：此事件由 Hook 自动管理，子模块代码中不应手动创建或修改此事件。

---

## 13. 性能与安全要求（Performance & Safety）

### 13.1 性能目标

- 首屏渲染时间：≤ 3 秒
- 单页渲染：≤ 500ms
- SVG 动画：60 FPS 目标
- 图片资源：使用懒加载，压缩后图片 ≤ 200KB

### 13.2 安全与隐私

- 禁止在本地持久化敏感信息明文
- 不得向外域发送任何数据
- 所有网络请求通过统一 API 域名

---

## 14. 验收标准与测试清单（Acceptance & Test Plan）

### 14.1 功能用例

**1. 正常完成流程**
- 前置：登录后进入绑定了本子模块所在 Flow
- 步骤：按页面顺序完成所有题目并点击下一页
- 验证：
  - 所有 7 页均可正常访问
  - Page 00 和 Page 01 不显示左侧导航（`hidden` 模式）
  - 从 Page 02 开始显示 5 步导航
  - Page 00 需等待 38 秒后勾选确认才能进入下一页
  - 提交数据格式符合规范，`pageNumber` 使用复合编码
  - 最后一页提交后调用 `flowContext.onComplete()`
  - Flow 能顺利进入下一个步骤

**2. 中途刷新恢复**
- 前置：在第 3 页操作实验后
- 步骤：刷新浏览器
- 验证：
  - 恢复到正确的页面（基于 `flowContext.modulePageNum`）
  - 实验参数状态被恢复

**3. 计时器到期**
- 前置：等待 20 分钟计时到期
- 步骤：不操作，等待自动提交
- 验证：
  - 自动提交当前页数据
  - 未答题目写入 `"超时未回答"`
  - 调用 `flowContext.onTimeout()`
  - Flow 正确处理后续逻辑

**4. 网络错误与重试**
- 模拟提交失败
- 验证：错误提示、重试逻辑、阻断导航

**5. 实验面板功能**
- 验证：
  - 浓度切换正确
  - 天数调整正确
  - 滴管动画播放正常
  - 发芽率数据与数据表一致
  - 种子视觉变化符合预期

**6. 必填项校验**
- 验证：
  - Page 02：文本 < 5 字符时阻断
  - Page 04/05：未选择时阻断
  - Page 06：判断未选或文本 < 10 字符时阻断
  - 阻断时记录 `click_blocked` 事件，包含 `missing` 字段

**7. flowContext API 使用**
- 验证：
  - 中间页面切换时调用 `updateModuleProgress(nextSubPageNum)`
  - **最后一页提交后不调用 `updateModuleProgress`**，直接调用 `onComplete()`
  - 超时时调用 `onTimeout()`
  - `pageNumber` 使用 `encodeCompositePageNum(flowContext.stepIndex, subPageNum)` 生成

**8. Flow 级上下文埋点**
- 步骤：首次进入每个 step 时，完成一次页面加载与一次提交
- 验证：
  - 对应 Mark 数据的 `operationList` 中存在一条 `eventType = 'flow_context'` 的记录
  - 此记录由 `usePageSubmission` Hook 自动注入（参见第 12.1 节）
  - 子模块业务事件不会覆盖或破坏这条记录

**9. 最后一页完成后刷新恢复**
- 前置：在最后一页（Page 06）提交成功后、Flow 容器跳转前
- 步骤：立即刷新浏览器
- 验证：
  - 恢复到 Page 06（而非错误回退到 Page 00）
  - 说明：因为最后一页提交后不调用 `updateModuleProgress`，进度保持在 '7'

**10. 独立调试模式（可选）**
- 前置：子模块在无 Flow 容器环境下运行（`flowContext` 为 `undefined`）
- 步骤：完成全部页面流程
- 验证：
  - `pageNumber` 格式为 `"M0:1"`、`"M0:2"` 等（stepIndex 固定为 0）
  - `pageDesc` 不含 Flow 前缀，直接使用页面中文描述
  - 不调用 `updateModuleProgress`、`onComplete`、`onTimeout`
  - 数据仍正常提交到后端
  - 最后一页提交后保持在当前页面

> **说明**：独立调试模式仅用于开发自测，生产环境验收主要覆盖 Flow 模式（用例 1-9）。

### 14.2 与统一规范对齐检查项

- [ ] CMI 接口字段全部实现
- [ ] 使用 `usePageSubmission` 进行数据提交
- [ ] 使用统一计时器引擎
- [ ] 通过 `flowContext` 回调进行导航和完成通知，未直接操控路由
- [ ] 使用 CSS 变量而非硬编码颜色
- [ ] localStorage key 使用正确命名空间
- [ ] `pageNumber` 使用 `encodeCompositePageNum()` 生成
- [ ] `targetElement` 命名遵循 `P${pageNumber}_` 规则
- [ ] 引导页使用 `hidden` 导航模式
- [ ] 完成/超时通过 `flowContext.onComplete()`/`onTimeout()` 通知容器
- [ ] **最后一页提交后不调用 `updateModuleProgress`**，避免进度回退
- [ ] 提交参数包含完整的 `operationList` 和 `answerList` 结构
- [ ] 独立调试模式下不调用 Flow 进度 API

---

## 15. 代码与文档交付物清单（Deliverables）

### 15.1 代码交付

- `src/submodules/g8-mikania-experiment/index.jsx` - 导出 SubmoduleDefinition
- `src/submodules/g8-mikania-experiment/Component.jsx` - 主组件
- `src/submodules/g8-mikania-experiment/mapping.js` - 页面映射
- `src/submodules/g8-mikania-experiment/pages/*.jsx` - 7 个页面组件
- `src/submodules/g8-mikania-experiment/components/*` - 实验面板、图表组件
- `src/submodules/g8-mikania-experiment/styles/*.module.css` - 样式文件
- `src/submodules/g8-mikania-experiment/assets/*` - 图片和数据资源
- `src/submodules/g8-mikania-experiment/utils/experimentData.js` - 数据查询

### 15.2 文档交付

- 本设计说明书（已完成）
- 页面列表表格（第 4.1 节）
- 页码映射规则（第 4.2 节）
- operationList 事件字段结构（第 6.2 节）
- flowContext API 说明（第 7.1 节）
- 计时策略说明（第 5 节）
- 验收用例与测试记录（第 14 节）

---

## 附录 A：实验数据模型

**发芽率数据表**（必须严格遵循，不得随机生成）：

| 处理时间/天 | 0mg/ml (发芽率%) | 5mg/ml (发芽率%) | 10mg/ml (发芽率%) |
|------------|-----------------|-----------------|------------------|
| 1 | 0 | 0 | 0 |
| 2 | 45 | 15 | 10 |
| 3 | 68 | 30 | 22 |
| 4 | 72 | 40 | 35 |
| 5 | 75 | 50 | 45 |
| 6 | 78 | 55 | 50 |
| 7 | 78 | 60 | 55 |

**数据访问函数示例**：

```javascript
// src/submodules/g8-mikania-experiment/utils/experimentData.js
export const GERMINATION_DATA = {
  '0mg/ml': [0, 45, 68, 72, 75, 78, 78],
  '5mg/ml': [0, 15, 30, 40, 50, 55, 60],
  '10mg/ml': [0, 10, 22, 35, 45, 50, 55]
};

export function getGerminationRate(concentration, days) {
  const data = GERMINATION_DATA[concentration];
  if (!data || days < 1 || days > 7) {
    console.warn('Invalid experiment parameters');
    return 0;
  }
  return data[days - 1];
}
```

---

## 附录 B：资源清单

| 文件名 | 描述 | 用途 |
|--------|-----|-----|
| img_mik_weed.jpg | 薇甘菊生态照片 | P01 左图 |
| img_cuscuta.jpg | 菟丝子特写照片 | P01 右图 |
| img_exp_steps.jpg | 实验器材拼图 | P02 左侧 |
| icon_petri_dish.svg | 矢量培养皿图标 | P03-P05 动画容器 |
| icon_seed_dormant.svg | 未发芽种子图标 | P03-P05 动画元素 |
| icon_seed_sprouted.svg | 已发芽种子图标 | P03-P05 动画元素 |
| icon_dropper.svg | 矢量滴管图标 | P03-P05 过程动画 |
| icon_water_drop.svg | 矢量水滴图标 | P03-P05 过程动画 |
| chart_germination_curve.png | 实验数据折线图 | P06 左侧展示 |

---

## 附录 C：flowContext API 使用示例

```javascript
// Component.jsx 完整示例
import { encodeCompositePageNum } from '@/shared/types/flow';

const MikaniaExperimentComponent = ({
  userContext,
  initialPageId,
  options,
  flowContext
}) => {
  const [currentPageId, setCurrentPageId] = useState(initialPageId);

  // 获取当前子模块内页码
  const getCurrentSubPageNum = (pageId) => {
    const map = {
      'page_00_notice': '1',
      'page_01_intro': '2',
      'page_02_step_q1': '3',
      'page_03_sim_exp': '4',
      'page_04_q2_data': '5',
      'page_05_q3_trend': '6',
      'page_06_q4_conc': '7',
    };
    return map[pageId] || null;  // 注意：未找到时返回 null，避免错误回退
  };

  // 页面提交并导航
  const handlePageSubmit = async (nextPageId) => {
    const currentSubPageNum = getCurrentSubPageNum(currentPageId);
    const stepIndex = flowContext?.stepIndex ?? 0;

    // 1. 构建 pageNumber
    const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);

    // 2. 构建 pageDesc
    const pageDesc = flowContext
      ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] 薇甘菊防治-${getPageTitle(currentPageId)}`
      : `薇甘菊防治-${getPageTitle(currentPageId)}`;

    // 3. 提交数据
    await submitPageData({ pageNumber, pageDesc, ... });

    // 4. 更新进度（仅当有下一页时才更新）
    // 重要：最后一页完成时不调用 updateModuleProgress，
    // 避免在 onComplete 之前错误地重置进度
    if (nextPageId) {
      const nextSubPageNum = getCurrentSubPageNum(nextPageId);
      if (nextSubPageNum) {
        flowContext?.updateModuleProgress?.(nextSubPageNum);
      }
    }

    // 5. 导航（仅当有下一页时）
    if (nextPageId) {
      setCurrentPageId(nextPageId);
    }
  };

  // 完成子模块
  const handleComplete = async () => {
    // 1. 提交最后一页数据（不更新进度，因为即将完成）
    const currentSubPageNum = getCurrentSubPageNum(currentPageId);
    const stepIndex = flowContext?.stepIndex ?? 0;
    const pageNumber = encodeCompositePageNum(stepIndex, currentSubPageNum);
    const pageDesc = flowContext
      ? `[${flowContext.flowId}/g8-mikania-experiment/${stepIndex}] 薇甘菊防治-${getPageTitle(currentPageId)}`
      : `薇甘菊防治-${getPageTitle(currentPageId)}`;

    await submitPageData({ pageNumber, pageDesc, ... });

    // 2. 通知容器子模块已完成
    // 注意：不调用 updateModuleProgress，让容器决定后续行为
    flowContext?.onComplete?.();
  };

  // 超时处理
  const handleTimeout = async () => {
    await submitPageData({ isTimeout: true });
    flowContext?.onTimeout?.();
  };

  // ...
};
```

> **重要说明：完成时的进度处理**
>
> 当子模块完成（最后一页提交成功）时，**不应**调用 `updateModuleProgress`。原因如下：
>
> 1. 如果传入无效值（如 `null`），映射函数可能返回默认值 `'1'`，导致进度错误地回退到第一页
> 2. 子模块完成后，Flow 容器会接管控制（通过 `onComplete` 回调），进度由容器管理
> 3. 若在 `onComplete` 调用前刷新页面，学生应恢复到当前页面（第 6 页），而非被重置
>
> **正确做法**：
> - 中间页面跳转时：调用 `updateModuleProgress(nextSubPageNum)`
> - 最后一页完成时：仅调用 `onComplete()`，不更新进度

---

> **使用建议**：
> - AI 交互工程师：在开始编码前，务必逐项阅读并理解本说明书，特别是第 6、7 节的 API 规范
> - 评审者：可将本说明书作为 Code Review 与验收 checklist，重点检查第 14.2 节对齐项
> - 维护者：本说明书应随代码版本更新而维护，特别是 flowContext API 变更时
