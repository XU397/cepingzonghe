# 光伏治沙子模块设计说明书

> 适用对象：人机交互前端（考试端）的 **Flow 子模块** 开发场景。  
> 基于模板：`docs/Task C/子模块设计说明书模板.md`  
> 需求来源：`docs/Task C/光伏治沙需求文档.md`  
> 创建时间：2025年11月19日

---

## 1. 基本信息（Basic Info）[必填]

- **子模块名称（中文）**：  
  `光伏治沙`

- **子模块标识 `submoduleId`（唯一，kebab-case）**：  
  `g8-pv-sand-experiment`

- **显示名称 `displayName`**：  
  `8年级光伏治沙-交互实验`

- **版本号 `version`**：  
  `1.0.0`

- **适用年级 / 学科 / 场景**：  
  `初中8年级 / 物理学科 / 光伏治沙实验`

- **业务目标（简要描述）**：  
  `通过SVG仿真实验，让学生模拟光伏板对地表风速的影响，培养学生对给定信息的洞察能力、实验操作能力以及数据分析总结能力`

- **所属 Flow 类型**：  
  `实验前置模块`（会在其他标准实验子模块之前加载，用于多类型测试）

---

## 2. 运行环境与全局约束（Runtime & Global Constraints）[必填]

- **运行容器**：  
  - 子模块 **必须** 运行在统一页面框架中：  
    - 外壳：`AssessmentPageFrame`（导航 + 计时 + 主体 + 下一页按钮 + 错误托盘）；  
    - 左侧导航：`LeftStepperNav`。  
  - 子模块 **不得** 自行实现：全局导航、计时器、错误托盘、顶栏布局等。

- **技术栈约束**：  
  - 前端框架：React 18 + TypeScript。  
  - 构建工具：Vite 4（由项目统一配置）。  
  - 风格规范：遵守项目现有 ESLint + Prettier 配置。  
  - SVG动画：使用CSS动画和React状态管理实现物理仿真效果。

- **禁止直接操作的能力**：  
  - 路由跳转：使用容器提供的 `onNext` 等回调进行页面切换；  
  - 本地存储：使用 `module.g8-pv-sand-experiment.*` 命名空间；  
  - 会话处理：交由统一的 `handleSessionExpired`；  
  - API调用：通过统一 API 层进行数据提交。

- **支持环境假设**：  
  - 已存在 `userContext`（含 `examNo`、`batchCode`、`flowId` 等）；  
  - Flow 容器传入 `initialPageId`；  
  - 全局错误捕获与日志系统已启用。

---

## 3. CMI 接口定义与导出规范（CMI Definition）[必填]

### 3.1 TypeScript 接口示意

```ts
export interface SubmoduleComponentProps {
  userContext: UserContext;
  initialPageId: string;
  // 当前实现：仅支持计时器配置覆盖（静态传入）
  options?: {
    timers?: {
      task?: number;        // 任务计时器覆盖值（秒）
      questionnaire?: number; // 问卷计时器覆盖值（秒）
    };
    // **注意**：以下字段为规划扩展，当前 SubmoduleComponentProps 类型暂不支持
    // 如需使用，请先在 src/shared/types/flow.ts 中扩展类型定义：
    // experimentData?: typeof WIND_SPEED_DATA;  // 实验数据配置
    // enableTutorial?: boolean;                 // 是否启用操作指引
    // variant?: string;                         // 实验变体标识
  };
  // **计时器到期机制说明**：
  // 当前架构中，Flow容器直接处理计时器到期，无需子模块实现回调：
  // - 实时计时器状态不通过props传入
  // - 到期时，Flow容器自动执行强制提交和模块结束
  // - 子模块不需定义任何计时器回调函数
  // - props 中不包含 onTimerExpired 等回调字段
}

export interface SubmoduleDefinition {
  submoduleId: "g8-pv-sand-experiment";
  displayName: "8年级光伏治沙-交互实验";
  version: "1.0.0";
  
  Component: (props: SubmoduleComponentProps) => React.ReactNode;
  
  getInitialPage(subPageNum: string): string;
  getTotalSteps(): number;  // **关键：返回5（只统计Page 4-8的可见步）**
  getNavigationMode(pageId: string): NavigationMode;
  
  getDefaultTimers: () => {
    task: 20 * 60; // 20分钟
    questionnaire: 0;
  };
  
  // 注意：当前 SubmoduleDefinition 暂未包含 onComplete 字段
  // 如需完成判定，建议扩展接口或通过 flowContext 回调实现
  // isComplete?: (state: unknown) => boolean;
  
  onInitialize?: () => void;
  onDestroy?: () => void;
}
```

### 3.2 导出位置与命名

- **代码文件**：`src/submodules/g8-pv-sand-experiment/index.tsx`
- **导出对象名称**：`export const g8PvSandExperimentSubmodule: SubmoduleDefinition`

### 3.3 目录结构

```text
src/submodules/g8-pv-sand-experiment/
  index.tsx           # 导出 SubmoduleDefinition
  Component.tsx       # 子模块主组件
  mapping.ts          # subPageNum <-> pageId 映射
  pages/              # 8个具体页面组件
    Page01InstructionsCover.tsx    # 详细封面页（注意事项）
    Page02Cover.tsx                # 任务封面
    Page03Background.tsx           # 背景引入
    Page04ExperimentDesign.tsx     # 实验方案设计
    Page05Tutorial.tsx             # 操作指引
    Page06Experiment1.tsx          # 实验探究-1
    Page07Experiment2.tsx          # 实验探究-2
    Page08Analysis.tsx             # 结论分析
  components/         # 子模块内通用组件
    WindSpeedSimulator.tsx     # SVG风速仪组件
    DataVisualization.tsx      # 折线图组件
  styles/             # CSS模块样式
  constants/          # 实验数据配置
    windSpeedData.ts          # 核心数据常量
```

---

## 4. 页面模型与导航设计（Pages & Navigation）[必填]

### 4.1 页面列表

| subPageNum | pageId                    | 类型（type）     | 导航模式（navigationMode） | 导航步序号 | 说明（业务含义）                |
|----------:|---------------------------|-----------------|---------------------------|-----------|--------------------------------|
| 1         | `instructions_cover`      | `notice`        | `hidden`                  | -         | 详细封面页（注意事项+确认）       |
| 2         | `cover_intro`             | `notice`        | `hidden`                  | -         | 任务封面页（导航隐藏）           |
| 3         | `background_notice`       | `notice`        | `hidden`                  | -         | 背景引入说明（5秒倒计时）        |
| 4         | `experiment_design`       | `experiment`    | `experiment`              | 1         | 实验方案设计（文本输入）         |
| 5         | `tutorial_simulation`     | `experiment`    | `experiment`              | 2         | 模拟实验操作指引（试玩）         |
| 6         | `experiment_task1`        | `experiment`    | `experiment`              | 3         | 实验探究-1（50cm高度对比）      |
| 7         | `experiment_task2`        | `experiment`    | `experiment`              | 4         | 实验探究-2（趋势分析）          |
| 8         | `conclusion_analysis`     | `experiment`    | `experiment`              | 5         | 结论分析（数据可视化+综合问答）   |

> **重要说明**：
> - Page 1-3 为 `hidden` 模式，不占用导航步数
> - `getTotalSteps()` 返回 `5`（仅计算 Page 4-8 的实际步数）
> - LeftStepperNav 将显示 1-5 步，对应 Page 4-8

### 4.2 页码映射规则

- **`getInitialPage(subPageNum)` 实现规则**：
  - 合法输入：`"1"` 至 `"8"`
  - 越界处理：返回默认首页 `instructions_cover`
  - 映射表：
    ```ts
    const pageMapping = {
      "1": "instructions_cover",
      "2": "cover_intro",
      "3": "background_notice", 
      "4": "experiment_design",
      "5": "tutorial_simulation",
      "6": "experiment_task1",
      "7": "experiment_task2", 
      "8": "conclusion_analysis"
    };
    ```

- **逆向映射**（仅对可见页面编号，与`getStepIndex`保持一致）：
  ```ts
  const stepIndexMapping = {
    "experiment_design": 1,     // Page 4 -> Step 1  
    "tutorial_simulation": 2,   // Page 5 -> Step 2
    "experiment_task1": 3,      // Page 6 -> Step 3
    "experiment_task2": 4,      // Page 7 -> Step 4
    "conclusion_analysis": 5    // Page 8 -> Step 5
    // 注意：Page 1-3为hidden页面，不在stepIndex映射中
  };
  ```

### 4.3 导航规则

- **返回限制**：不允许用户返回上一页
- **前进条件**：
  - Page 4：输入内容需大于5个字符
  - Page 5：无强制条件（试玩页）
  - Page 6-7：必须完成实验操作和选择题
  - Page 8：必须完成所有问答项
- **步数与页面关系总结**：
  - `getTotalSteps()` 返回 `5`（仅计算显示导航的页面步数）
  - Page 1-3 为 `hidden` 模式，不计入步数，作为引导页面
  - Page 4-8 显示导航，共5步（步序号 1-5）
  - 当 `getNavigationMode(pageId) === 'hidden'` 时，AssessmentPageFrame 隐藏整个左侧导航栏
  
- **页码到步序号的映射**（与stepIndexMapping保持一致）：
  ```ts
  const getStepIndex = (pageId: string): number | null => {
    const stepMapping = {
      "experiment_design": 1,     // Page 4 -> Step 1
      "tutorial_simulation": 2,   // Page 5 -> Step 2
      "experiment_task1": 3,      // Page 6 -> Step 3
      "experiment_task2": 4,      // Page 7 -> Step 4
      "conclusion_analysis": 5    // Page 8 -> Step 5
      // Page 1-3 (instructions_cover, cover_intro, background_notice) 为hidden页面，返回null
    };
    return stepMapping[pageId] || null;
  };
  ```

### 4.4 页面详细规格说明

#### Page 01: 详细封面页（注意事项）

- **页面类型**：Type-A （基础信息展示页）
- **页面元数据**：
  - 标题：“任务C：光伏治沙”
  - 副标题：“科学探究任务”
- **内容结构**：
  - **注意事项标题**：“注意事项 请仔细阅读”
  - **注意事项内容**：
    ```
    本科学探究共20分钟，时间结束后，系统将自动退出答题界面。
    
    请按顺序回答每页问题，上一页题目未完成作答，将无法点击进入下一页。
    
    答题时，不要提前点击“下一页”查看后面的内容，否则将无法返回上一页。
    
    遇到系统故障、死机、死循环等特殊情况时，请举手示意老师。
    ```
  - **确认复选框**：“我已阅读并理解上述注意事项”
  - **倒计时提示**：“请仔细阅读注意事项，38秒后可勾选确认。”
- **交互逻辑**：
  - **38秒倒计时**：页面加载后开始38秒倒计时，倒计时期间复选框禁用
  - **复选框激活**：38秒后复选框可点击，并显示动画效果
  - **下一页按钮激活**：只有勾选“我已阅读并理解上述注意事项”后，“下一页”按钮才可点击
  - **页面验证**：点击下一页时检查复选框状态，未勾选则阻止导航
- **样式要求**：
  - 使用卡通风格设计，温馨亲切
  - 注意事项内容使用清晰的列表格式
  - 复选框使用显眼的主色调设计
  - 倒计时显示使用较小字号，位置在复选框附近

#### Page 02: 任务封面页

- **页面类型**：Type-A （基础信息展示页）
- **页面元数据**：
  - 标题：任务C：光伏治沙
  - 背景图：使用光伏沙漠实景图
- **交互逻辑**：
  - 显示“开始”按钮，点击跳转至 Page 03

#### Page 03: 背景引入

- **页面类型**：Type-A （基础信息展示页）
- **内容结构**：
  - **文本**：“2024年11月，中国库布齐沙漠通过‘光伏项目’成功使6000多平方公里沙漠变为‘能源绿洲’。这一成就引发了同学们的思考：光伏板为何能有效减少水分蒸发，以实现保水治沙？他们推测，改变地表风速可能是关键机制。”
  - **图片**：光伏基地航拍图
- **交互逻辑**：
  - 配置 **5秒** 最小阅读倒计时，倒计时结束后“下一页”按钮高亮

---

## 5. 计时策略（Timing Strategy）[推荐]

### 5.1 默认计时配置

```ts
getDefaultTimers: () => ({
  task: 20 * 60,     // 20分钟总时长
  questionnaire: 0,  // 本模块无独立问卷计时
});
```

### 5.2 计时范围分配

- **任务计时范围**：Page 4-8（共20分钟）
- **说明页面**：Page 1-3 不计入任务时长
- **页面时间建议**：
  - Page 4（设计）：3分钟
  - Page 5（试玩）：2分钟
  - Page 6-7（实验）：各5分钟
  - Page 8（分析）：5分钟

### 5.3 Flow 覆盖与优先级

- **覆盖策略**：
  - 当 FlowDefinition 的 `steps[].overrides.timers` 存在时，以 Flow 配置为准
  - 否则使用子模块的 `getDefaultTimers()` 返回值
  - 具体优先级：`Flow配置 > 子模块默认值`

- **传入方式**：
  ```ts
  // Flow 容器通过 options.timers 传入覆盖值
  <Component 
    userContext={userContext}
    initialPageId={pageId}
    options={{
      timers: {
        task: flowStep.overrides?.timers?.task || submodule.getDefaultTimers().task
      }
    }}
  />
  ```

- **子模块内部处理**：
  ```ts
  const { timers } = props.options || {};
  const taskTime = timers?.task || getDefaultTimers().task;
  ```

### 5.4 到期行为

- **任务计时到期**：
  - 自动提交当前页数据
  - 未答项填入 `"超时未回答"`
  - **强制结束模块**，不等待完成Page 8，直接进入Flow过渡页
  - **模块状态**：标记为`timeout_completed`，与Page 8的`normal_completed`
- **页面级倒计时**：
  - Page 3：5秒阅读倒计时（倒计时结束后"下一页"按钮高亮）

### 5.5 计时器状态管理职责

- **Flow容器职责**：
  - 维护和持久化全局任务计时器状态
  - 处理跨页面、跨模块的计时连续性
  - 在页面刷新或会话恢复时重新初始化计时器
  - 监听计时器到期事件并触发自动提交逻辑
  - 直接执行强制提交和模块结束逻辑（当前架构）

- **子模块职责**：
  - 接收来自Flow容器的计时器配置（`options.timers`）
  - 实现页面级短倒计时（如Page 3的5秒阅读倒计时）
  - **不需处理**计时器到期事件（由Flow容器直接处理）
  - **不得**自行持久化计时器状态到本地存储
  - **不需**获取实时剩余时间，仅响应用户交互

- **接口契约澄清**：
  - props.options.timers：静态配置，仅在组件初始化时传入
  - 实时计时器状态：不通过props，由Flow容器内部管理
  - 到期处理：Flow容器直接执行，子模块无需实现回调

---

## 6. 数据提交与事件设计（Data & Events）[必填]

### 6.1 数据格式与工具

- **必须使用统一工具**：
  - `createMarkObject` / `validateMarkObject`：构建和验证数据格式
  - `usePageSubmission`：统一提交Hook，自动处理重试和错误
  - 事件枚举与字段定义以 `openspec/specs/data-format/spec.md` 为准

- **核心数据配置**（严格使用预定义常量）：
  ```ts
  const WIND_SPEED_DATA = {
    20: { withPanel: 2.09, noPanel: 2.37 },
    50: { withPanel: 2.25, noPanel: 2.62 },
    100: { withPanel: 1.66, noPanel: 2.77 }
  };
  ```

- **MarkObject 关键字段要求**：
  - `pageNumber`：**统一使用点分隔格式** `"stepIndex.subPageNum"`
    - 示例：`"1.3"`（Flow第1步，子模块第3页）
    - **本子模块的具体编码规则**：
      ```ts
      const getPageNumber = (pageId: string): string => {
        const stepIndex = getStepIndex(pageId); // 1-5 或 null
        const subPageNum = getSubPageNum(pageId); // 1-8
        
        if (stepIndex === null) {
          // hidden页面：使用 "H" 前缀 + subPageNum  
          return `H.${subPageNum}`; // "H.1", "H.2"
        } else {
          // 可见页面：使用 stepIndex.subPageNum
          return `${stepIndex}.${subPageNum}`; // "1.3", "2.4", etc.
        }
      };
      ```
  - `pageDesc`：必须附加前缀 `[flowId/submoduleId/stepIndex]`
    - 示例：`"[测试flowId/g8-pv-sand-experiment/1] 实验方案设计"`
    - hidden页面使用：`"[测试flowId/g8-pv-sand-experiment/H] 任务封面"`
    - 示例：`"[flow123/g8-pv-sand-experiment/2] 光伏治沙-实验阶段1"`
  - `operationList`：记录所有用户交互，必须包含：
    - 页面进入：`page_enter`（组件挂载时）
    - 页面退出：`page_exit`（离开页面时）
    - 关键交互：使用统一事件名（`click`、`change`、`click_blocked`）
  - `answerList`：每题一个元素
    - `code`：从1开始自增
    - `targetElement`：命名建议 `P{pageNumber}_{业务语义ID}`，如 `P3_实验设计问题1`
    - `value`：使用可读标签文本（非内部编码），如 `"有板区"` 而不是 `"A"`

- **代码位置参考**：
  - 提交 Hook：`src/shared/services/submission/usePageSubmission.js`
  - Mark 构建工具：`src/shared/services/submission/createMarkObject.js`、`validateMarkObject.js`
  - 事件枚举：`src/shared/services/submission/eventTypes.js`

### 6.2 事件类型与命名规范

**重要说明**：使用模板要求的统一事件名，避免自定义事件类型，确保与系统兼容。

| 事件名（统一）    | 触发时机                     | 携带字段载荷                              | 业务含义                               |
|------------------|------------------------------|------------------------------------------|----------------------------------------|
| `page_enter`     | 页面组件首次挂载               | `targetElement`: "页面", `value`: pageId | 必须记录，用于页面访问统计               |
| `page_exit`      | 离开当前页面（切换前/提交后）   | `targetElement`: "页面", `value`: pageId | 必须记录，用于页面停留时间计算            |
| `change`         | 学生修改答案                   | `targetElement`: 控件ID, `value`: 新值  | 统一的答题交互事件                      |
| `click`          | 点击普通按钮（非阻断）         | `targetElement`: 按钮ID, `value`: 操作类型 | 包含开始、重置、高度调节按钮点击         |
| `click_blocked`  | 点击"下一步/提交"但校验未通过   | `targetElement`: "下一步", `value`: 阻断原因 | 必须标记阻断原因（如"文本长度不足"）     |
| `auto_submit`    | 计时器到期触发自动提交          | `targetElement`: "页面", `value`: "计时到期" | **Flow容器系统事件，子模块无需上报**     |

**业务特定事件详细说明**：

- **实验操作事件**（使用 `click` 事件，通过 value 区分）：
  ```ts
  // 开始实验
  { targetElement: "开始按钮", eventType: "click", value: "开始实验_高度50cm" }
  // 高度调节  
  { targetElement: "高度调节器", eventType: "click", value: "调节高度_从50到100cm" }
  // 重置实验
  { targetElement: "重置按钮", eventType: "click", value: "重置实验" }
  ```

- **答题事件**（使用 `change` 事件）：
  ```ts
  // 文本输入
  { targetElement: "P3_实验设计问题1", eventType: "change", value: "用户输入的文本内容" }
  // 单选题
  { targetElement: "P5_风速对比问题", eventType: "change", value: "有板区" }
  ```

- **验证阻断事件**：
  ```ts
  { targetElement: "下一步", eventType: "click_blocked", value: "文本长度不足5字符" }
  { targetElement: "下一步", eventType: "click_blocked", value: "未完成实验操作" }
  ```

### 6.3 提交时机与失败处理

- **提交触发点**（至少包含）：
  - **点击"下一页/提交"时**：
    - 收集当前页全部答案 → 补齐未答占位 → 构造 `MarkObject` → 调用 `usePageSubmission.submit()`
    - **提交成功后才允许导航到下一页**
    - 示例代码：
      ```ts
      const handleNext = async () => {
        // 1. 收集答案
        const answers = collectCurrentPageAnswers();
        
        // 2. 构建 MarkObject
        const markObject = createMarkObject({
          pageNumber: getPageNumber(pageId), // 使用统一的点分隔格式："1.3" 或 "H.1"
          pageDesc: `[${flowId}/g8-pv-sand-experiment/${stepIndex || 'H'}] 光伏治沙-${pageTitle}`,
          operationList: [...operations, exitOperation],
          answerList: answers,
          beginTime: pageStartTime,
          endTime: formatDateTime(new Date())
        });
        
        // 3. 验证和提交
        validateMarkObject(markObject);
        await usePageSubmission.submit(markObject);
        
        // 4. 成功后清理并导航
        clearOperations();
        onNext();
      };
      ```
  
  - **计时器到期自动提交**：
    - **由Flow容器全权处理**，子模块无需实现相关逻辑
    - Flow容器自动：收集当前状态 → 补全未答项 → 构造MarkObject → 强制提交
    - 子模块只需正常响应用户交互，不需处理超时情况

- **提交失败时**：
  - **网络错误或服务端错误**：
    - 使用统一错误托盘显示错误信息
    - 阻断导航（DEV 环境可配置跳过，但需说明）
    - 允许用户重试提交
    - `usePageSubmission` 内置指数退避重试机制
  
  - **401/会话过期**：
    - 调用 `handleSessionExpired`，清理状态并回登录
    - 子模块 **不得** 自己决定跳转 URL
  
  - **数据验证失败**：
    - `validateMarkObject` 抛出错误时，显示具体验证信息
    - 阻断提交，要求用户修正数据后重试

---

## 7. Flow 集成与进度恢复（Flow Integration）[必填]

- **进度恢复**：
  - 通过 `getInitialPage(modulePageNum)` 恢复到正确页面
  - 从本地存储恢复已填写的答案和实验数据
  - 计时器配置由Flow容器通过props传入（`options.timers`）
  - 实时计时器状态不通过props，由Flow容器内部管理

- **完成判定**：
  - **正常完成**：到达Page 8并成功提交所有数据（`normal_completed`）
  - **超时完成**：计时器到期强制结束，不等待完成所有页面（`timeout_completed`）
  - **注意**：当前 `SubmoduleDefinition` 未暴露 `onComplete` 字段
  - **Flow容器完成判定实现方案**：
    ```ts
    // Flow容器会监听以下事件来判定子模块完成：
    
    // 方案1：监听最后一页提交事件
    onPageSubmitted(pageId: string, isLastPage: boolean) {
      if (pageId === 'conclusion_analysis' && isLastPage) {
        this.markSubmoduleCompleted('normal_completed');
      }
    }
    
    // 方案2：监听计时器到期事件
    onTimerExpired() {
      this.forceSubmitCurrentPage();
      this.markSubmoduleCompleted('timeout_completed');
    }
    ```
  - **子模块职责**：仅需正常执行页面提交，不需实现完成判断逻辑

- **Flow覆盖配置**：
  - 支持 `options.timers.task` 覆盖默认20分钟时长
  - 后续可扩展 `options.variant` 支持A/B测试不同实验参数

---

## 8. 本地存储与状态管理（Local State & Persistence）[推荐]

- **状态管理**：使用React Context + useReducer管理模块状态
- **持久化状态项**：
  - `module.g8-pv-sand-experiment.currentPage`：当前页面（可选，通常由Flow管理）
  - `module.g8-pv-sand-experiment.answers`：用户答案草稿（避免刷新丢失）
  - `module.g8-pv-sand-experiment.experimentData`：实验操作记录
  - **注意**：计时器状态由Flow容器统一管理和持久化，子模块不得自行持久化计时数据

- **刷新恢复策略**：
  - **页面恢复**：`initialPageId` 由 Flow 容器提供，子模块不自行跳页
  - **答案恢复**：从本地存储读取答案草稿并回填 UI
  - **实验状态恢复**：重新初始化SVG组件，必要时恢复高度设置
  - **计时器处理**：Flow容器负责任务计时器的状态管理和持久化，子模块仅响应计时事件

---

## 9. 错误处理与边界情况（Error Handling & Edge Cases）[必填]

- **初始化失败**：显示重试界面，可重新初始化实验数据
- **非法页码**：记录错误日志，回退到首页
- **SVG动画异常**：降级到静态数值显示，确保实验数据正常获取
- **数据提交失败**：使用统一重试机制，最多3次尝试
- **会话过期**：调用 `handleSessionExpired`，清理本地状态

---

## 10. 视觉与交互规范（UI & UX Constraints）[必填]

### 10.1 统一框架约束

- **不可覆盖部分**：
  - 页面外壳布局（左右结构 + 顶部计时 + 底部下一页按钮）
  - 左侧导航（圆点 + 步数显示）样式与逻辑
  - 计时器位置与基本样式
  - 全局错误托盘组件

- **可自定义部分**：
  - 主体区域的内容布局与控件
  - 控件样式，可通过 CSS 变量或局部样式覆盖
  - 业务特有的交互（SVG动画、实验仿真等）

### 10.2 颜色系统（Color System）

基于全局CSS变量（src/styles/global.css），**必须使用统一色板**：

| 用途      | CSS变量               | 色值        | 使用场景                  |
|-----------|----------------------|-------------|---------------------------|
| 主色      | `--cartoon-primary`  | `#59c1ff`   | 主要按钮、强调元素、选中状态 |
| 次色      | `--cartoon-secondary`| `#ffce6b`   | 次要按钮、提示信息          |
| 边框色    | `--cartoon-border`   | `#ffd99e`   | 卡片边框、分割线           |
| 成功绿    | `--cartoon-green`    | `#67d5b5`   | 完成状态、正确提示         |
| 警告红    | `--cartoon-red`      | `#ff8a80`   | 错误提示、警告信息         |
| 正文色    | `--text-color`       | `#333333`   | 正文段落、标签            |
| 次要文本  | `--text-secondary`   | `#666666`   | 说明文字、辅助信息         |
| 背景色    | `--background-color` | `#f5f5f5`   | 内容区背景               |
| 卡片背景  | `--card-background`  | `#ffffff`   | 内容卡片、模态框          |
| 阴影      | `--cartoon-shadow`   | `rgba(0,0,0,0.1)` | 卡片阴影、按钮阴影    |
| **天空渐变上** | `--sky-gradient-top` | `#87ceeb` | SVG实验环境背景渐变上部 |
| **天空渐变下** | `--sky-gradient-bottom` | `#e0f6ff` | SVG实验环境背景渐变下部 |

**使用约束**：
- ✅ 必须使用CSS变量，不得硬编码色值
- ✅ 新增颜色需在 global.css 中声明
- ❌ 禁止使用纯黑 #000 或低对比度文本

**本子模块需要在 global.css 中新增的颜色变量**：
```css
:root {
  /* 实验仿真环境背景 */
  --sky-gradient-top: #87ceeb;    /* 天空蓝上部 */
  --sky-gradient-bottom: #e0f6ff; /* 淞蓝下部 */
}
```

### 10.3 内容区域布局（Content Area Layout）

**子模块渲染区域标准尺寸**：

| 属性        | 值      | 说明               |
|-------------|---------|-------------------|
| 标准宽度    | 1200px  | 内容区域最大宽度    |
| 标准高度    | 800px   | 内容区域最大高度    |
| 内边距      | 40px    | 四周padding        |
| 可用内容宽度 | 1120px  | 扣除padding后      |
| 可用内容高度 | 720px   | 扣除padding后      |

**页面容器模板**：
```css
.pageContainer {
  width: 100%;
  height: 100%;
  padding: 40px;
  box-sizing: border-box;
  overflow-y: auto;
}
```

**常见布局模式**：

1. **单栏居中布局**（适用于：通知页、说明页）：
```css
.centeredContent {
  max-width: 800px;
  margin: 0 auto;
  text-align: center;
}
```

2. **左右分栏布局**（适用于：材料阅读+问答）：
```css
.splitLayout {
  display: flex;
  gap: 24px;
  height: 100%;
}

.leftPanel {
  flex: 1;
  overflow-y: auto;
}

.rightPanel {
  flex: 1;
  display: flex;
  flex-direction: column;
}
```

3. **SVG实验界面**（适用于：Page 5-7）：
```css
.experimentContainer {
  display: flex;
  flex-direction: column;
  height: 100%;
  gap: 16px;
}

.svgStage {
  flex: 1;
  min-height: 400px;
  background: linear-gradient(to bottom, var(--sky-gradient-top), var(--sky-gradient-bottom));
  border-radius: 12px;
  overflow: hidden;
}

.controlPanel {
  background: var(--card-background);
  border: 2px solid var(--cartoon-border);
  border-radius: 12px;
  padding: 24px;
}
```

### 10.4 组件设计标准（Component Standards）

**表单控件**：

```css
/* TextArea */
.textarea {
  width: 100%;
  min-height: 100px;
  padding: 12px 16px;
  border: 2px solid var(--cartoon-border);
  border-radius: 8px;
  font-size: 16px;
  font-family: inherit;
  line-height: 1.6;
  resize: vertical;
  transition: border-color 0.3s ease;
}

.textarea:focus {
  border-color: var(--cartoon-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(89, 193, 255, 0.1);
}

/* Radio Button */
.radioWrapper {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
}

.radio {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--cartoon-border);
  appearance: none;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
}

.radio:checked {
  border-color: var(--cartoon-primary);
  background: var(--cartoon-primary);
}

.radio:checked::after {
  content: '';
  position: absolute;
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
```

**实验控制按钮**：
```css
.experimentButton {
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  border: 2px solid var(--cartoon-border);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.experimentButton.primary {
  background: var(--cartoon-primary);
  color: white;
  border-color: var(--cartoon-primary);
}

.experimentButton.primary:hover {
  background: #4aa3d6;
}

.experimentButton.secondary {
  background: var(--card-background);
  color: var(--text-color);
}

.experimentButton:active {
  transform: scale(0.95);
}
```

### 10.5 SVG动画规范

**基于提供的代码实现**（来自 `docs/Task C/SVG光伏治沙` 文档）：

```ts
// 颜色配置（与全局变量保持一致）
const COLORS = {
  primary: '#59c1ff',       // --cartoon-primary
  secondary: '#ffce6b',     // --cartoon-secondary
  border: '#ffd99e',        // --cartoon-border
  green: '#67d5b5',         // --cartoon-green
  text: '#333333',          // --text-color
  cardBg: '#ffffff',        // --card-background
  // 仿真元素固有色
  panelSurface: '#2c5282',  // 光伏板深蓝
  anemometerBlack: '#1a202c' // 风速仪黑色
};

// 动画性能优化
.spinningElement {
  animation: spin 2s linear infinite;
  transform-origin: center;
  will-change: transform;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
```

### 10.6 响应式适配（Responsive Adaptation）

**关键原则**：高度优先于宽度（教育测评场景下屏幕高度是主要约束）

| 断点    | 条件       | 内容padding | 字号缩放 | 适用设备           |
|---------|------------|-------------|----------|-------------------|
| 默认    | ≥900px     | 40px        | 100%     | 1920×1080 标准桌面 |
| 中等    | ≤800px     | 30px        | 95%      | 1280×800 常见笔记本 |
| 紧凑    | ≤720px     | 25px        | 90%      | 1366×768 低分辨率  |

```css
.pageContainer {
  padding: 40px;
}

/* 中等屏幕 */
@media (max-height: 800px) {
  .pageContainer {
    padding: 30px;
  }
  
  .title {
    font-size: 32px;  /* 原36px × 0.95 */
  }
}

/* 紧凑屏幕 */
@media (max-height: 720px) {
  .pageContainer {
    padding: 25px;
  }
  
  .title {
    font-size: 28px;  /* 原36px × 0.9 */
  }
  
  .paragraph {
    font-size: 14px;  /* 原16px × 0.9 */
  }
}
```

### 10.7 排版规范（Typography）

**字体家族**：
```css
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 
            'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 
             sans-serif;
```

**字号层级**：
| 级别     | 尺寸  | 字重 | 行高 | 使用场景           |
|----------|-------|------|------|-----------------|
| H1 标题  | 36px  | 700  | 1.4  | 页面主标题         |
| H2 标题  | 28px  | 700  | 1.4  | 章节标题          |
| H3 标题  | 24px  | 600  | 1.4  | 子章节标题        |
| 正文     | 16px  | 400  | 1.6  | 段落内容、问题描述 |
| 小号文本 | 14px  | 400  | 1.5  | 标签、说明文字     |
| 辅助文本 | 12px  | 400  | 1.4  | 提示信息、脚注     |

**中文排版特殊处理**：
```css
.paragraph {
  font-size: 16px;
  line-height: 1.6;
  color: var(--text-color);
  text-align: justify;        /* 两端对齐 */
  text-indent: 2em;           /* 首行缩进2字符 */
  word-break: break-all;      /* 中英文混排 */
  margin-bottom: 16px;
}
```

### 10.8 动画与交互（Animation & Interaction）

**动画时长标准**：
| 类型 | 时长  | 缓动函数   | 使用场景                 |
|------|-------|------------|------------------------|
| 快速 | 0.2s  | ease       | hover状态、点击反馈      |
| 标准 | 0.3s  | ease       | 状态切换、展开收起       |
| 慢速 | 0.5s  | ease-in-out| 复杂动画、特殊效果       |

**常见动画效果**：
```css
/* 元素上浮 */
.hoverable:hover {
  transform: translateY(-3px);
  transition: transform 0.3s ease;
}

/* 选中反馈 */
.selectFeedback {
  animation: selectPop 0.2s ease;
}

@keyframes selectPop {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* 淡入显示 */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}
```

### 10.9 卡通风格特征（Cartoon Style Features）

**基于目标用户（12-15岁）的审美偏好**：
| 特征     | 实现方式                                        | 效果           |
|----------|-----------------------------------------------|----------------|
| 圆角     | border-radius: 12px (大组件), 8px (小组件)    | 柔和、亲和     |
| 渐变     | linear-gradient(135deg, color1, color2)       | 活泼、立体     |
| 柔和阴影 | box-shadow: 0 4px 8px rgba(0,0,0,0.1)        | 浮起感         |
| 亮色系   | 蓝色 #59c1ff、黄色 #ffce6b                    | 活力、正面     |
| 微交互   | hover上浮、选中缩放                           | 趣味性、即时反馈|

### 10.10 交互约束与导航

- **关键交互约束**：
  - "下一页/提交"按钮：**不得**自己实现独立按钮进行导航
  - 必须通过容器提供的 `onNext()` 完成导航，调用前确保提交成功
  - SVG动画时长控制在2秒内，确保用户体验流畅
  - 所有按钮点击提供即时视觉反馈（0.2s transition）

- **数据可视化要求**：
  - 折线图需清晰标注数值和图例
  - 使用 `--cartoon-primary` （蓝色）表示有板数据
  - 使用 `--cartoon-secondary` （橙色）表示无板数据
  - 数据点标注使用 `--text-color` 确保可读性

---

## 11. 配置项与扩展性（Options & Extensibility）[可选]

**当前支持的配置项**：

| 配置项名 | 类型     | 默认值 | 说明                      | 状态     |
|----------|----------|--------|---------------------------|----------|
| `timers` | `object` | 见5.1节 | 计时覆盖配置             | ✅ 已实现 |

**规划中的扩展配置项**（需先扩展 `SubmoduleComponentProps.options` 类型）：

| 配置项名           | 类型      | 默认值            | 说明                                | 实现要求 |
|-------------------|-----------|-------------------|-------------------------------------|----------|
| `experimentData`  | `object`  | `WIND_SPEED_DATA` | 实验数据配置，支持A/B测试不同数值   | 需扩展类型 |
| `enableTutorial`  | `boolean` | `true`           | 是否启用Page 4操作指引页面          | 需扩展类型 |
| `variant`         | `string`  | `"default"`      | 实验变体（A/B测试）                 | 需扩展类型 |

**实现约束**：
- 所有配置项必须有合理默认值，确保在 `options` 为空时模块正常运行
- 新增配置项前，必须先在 `src/shared/types/flow.ts` 中扩展类型定义
- 配置项不应影响 `getTotalSteps()` 返回值，保持导航一致性

---

## 12. 日志与埋点要求（Logging & Telemetry）[推荐]

- **必需埋点**：
  - Flow容器统一打点（无需子模块重复上报）
  - 实验操作埋点：高度调节、开始实验、数据收集
  - 模块完成埋点：记录完成时间和答题情况
  - 异常埋点：SVG动画失败、数据加载异常

- **字段要求**：
  - 包含 `flowId`、`submoduleId`、`stepIndex`、`pageNumber`
  - 实验相关埋点需包含 `height`、`windSpeedData` 等业务字段

---

## 13. 性能与安全要求（Performance & Safety）[推荐]

- **性能目标**：
  - 首屏渲染时间 < 2秒
  - SVG动画保持60FPS
  - 页面切换响应时间 < 300ms

- **安全要求**：
  - 不在本地存储敏感数据明文
  - 所有网络请求通过统一API域名
  - 实验数据使用预定义常量，不接受外部输入

---

## 14. 验收标准与测试清单（Acceptance & Test Plan）[必填]

### 功能测试用例

1. **正常完成流程**
   - 从Page 1按顺序完成到Page 8
   - 验证所有页面正常渲染和数据提交
   - 确认实验数据使用预定义的 `WIND_SPEED_DATA`

2. **实验操作测试**
   - Page 5-7：测试SVG动画和数据收集
   - 验证高度调节（20/50/100cm）功能正常
   - 确认风速数值与预定义数据一致

3. **数据提交验证**
   - 检查MarkObject格式符合规范
   - 验证事件记录完整性
   - 测试网络异常时的重试机制

4. **计时器测试**
   - 验证20分钟计时正常运行
   - 测试计时到期的自动提交功能
   - 确认Page 3的5秒倒计时正常

5. **刷新恢复测试**
   - 在任意页面刷新，验证状态恢复
   - 检查答案和实验数据持久化
   - 确认计时器状态正确恢复

6. **Flow 级上下文埋点测试**
   - **测试目标**：确认每次页面提交的 `operationList` 中包含正确的 `flow_context` 事件
   - **测试步骤**：
     1. 首次进入任一 step 时，完成一次页面加载
     2. 在该页面进行至少一次用户交互（点击、输入等）
     3. 点击"下一页"提交数据
     4. 检查提交的 MarkObject 数据
   - **验证点**：
     - `operationList` 中存在一条 `eventType = 'flow_context'` 的记录
     - 该记录由 Flow 容器与 `usePageSubmission` 统一注入
     - 子模块的业务事件（如 `change`、`click`）不会覆盖或破坏 `flow_context` 记录
     - `flow_context` 事件包含正确的 `flowId`、`submoduleId`、`stepIndex` 信息
   - **具体验证样例**（光伏治沙Page 4的提交数据）：
     ```json
     {
       "pageNumber": "1.4",
       "pageDesc": "[测试flowId/g8-pv-sand-experiment/1] 实验方案设计",
       "operationList": [
         {
           "targetElement": "页面",
           "eventType": "page_enter",
           "value": "experiment_design",
           "time": "2024-11-19T10:00:00.000Z"
         },
         {
           "targetElement": "flowContext",
           "eventType": "flow_context",
           "value": JSON.stringify({
             "flowId": "测试flowId",
             "submoduleId": "g8-pv-sand-experiment",
             "stepIndex": 1,
             "timestamp": "2024-11-19T10:00:05.000Z"
           }),
           "time": "2024-11-19T10:00:05.000Z"
         },
         {
           "targetElement": "答案输入框",
           "eventType": "change",
           "value": "用户输入的答案内容...",
           "time": "2024-11-19T10:02:30.000Z"
         },
         {
           "targetElement": "页面",
           "eventType": "page_exit",
           "value": "experiment_design",
           "time": "2024-11-19T10:03:15.000Z"
         }
       ],
       "answerList": [
         {
           "code": 1,
           "targetElement": "P1.4_设计原因问题",
           "value": "用户的答案内容"
         }
       ],
       "beginTime": "2024-11-19 10:00:00",
       "endTime": "2024-11-19 10:03:15"
     }
     ```
   - **回归测试**：
     - 确保子模块代码不会意外清空或修改 `flow_context` 事件
     - 验证多页面提交时，每页都有独立的 `flow_context` 记录
     - 验证在页面刷新后重新提交时，`flow_context` 事件仍然正确注入

### 兼容性测试

- 主流浏览器兼容性（Chrome, Firefox, Safari, Edge）
- 不同分辨率屏幕适配
- SVG动画在低性能设备上的降级处理

---

## 15. 代码与文档交付物清单（Deliverables）[必填]

### 代码交付

- `src/submodules/g8-pv-sand-experiment/index.tsx`：SubmoduleDefinition导出
- `src/submodules/g8-pv-sand-experiment/Component.tsx`：主组件
- `src/submodules/g8-pv-sand-experiment/pages/*`：8个页面组件
- `src/submodules/g8-pv-sand-experiment/components/*`：SVG动画和图表组件
- `src/submodules/g8-pv-sand-experiment/styles/*`：CSS模块样式文件
- `src/submodules/g8-pv-sand-experiment/constants/windSpeedData.ts`：实验数据配置

### 文档交付

- 本设计说明书（完整版）
- 页面流程图和交互说明
- SVG动画实现技术文档（基于 `docs/Task C/SVG光伏治沙` 完整代码）
- 实验数据配置说明
- 验收测试报告

### SVG动画核心代码实现

**来源**：`docs/Task C/SVG光伏治沙` 文档提供的完整React组件代码

**关键特性**：
- 稳健型风速仪组件（`RobustAnemometer`）解决散架和位置异常问题
- 基于预定义 `WIND_SPEED_DATA` 的精确数值显示
- 2秒动画时长的平滑旋转效果
- GPU优化的CSS动画（`will-change: transform`）
- 响应式布局适配不同屏幕尺寸

**实现要点**：
```ts
// 关键组件导入
import { RobustAnemometer } from './components/RobustAnemometer';
import { WIND_SPEED_DATA, HEIGHT_LEVELS } from './constants/windSpeedData';

// 动画控制逻辑
const handleStart = () => {
  setIsPlaying(true);
  // 2秒数据采集动画
  setTimeout(() => {
    setDisplayValues({
      left: targetValues.withPanel,
      right: targetValues.noPanel
    });
  }, 2000);
};
```

**集成说明**：
- 直接复制 `docs/Task C/SVG光伏治沙` 中的完整代码
- 适配到子模块的 Page 5-7 页面组件中
- 保持原有的颜色系统和动画逻辑
- 确保事件埋点（开始、重置、高度调节）符合数据规范

---

> **开发提醒**：
> - 严格使用预定义的 `WIND_SPEED_DATA`，禁止使用随机数
> - SVG动画实现需考虑性能优化和降级方案
> - 所有用户交互都需要记录到 `operationList` 中
> - 数据可视化需要清晰标注数值和图例，便于学生分析

> **后续维护**：
> - 本说明书需随代码版本同步更新
> - 实验数据配置变更需要同步更新文档
> - 新增页面或功能需要更新页面映射表