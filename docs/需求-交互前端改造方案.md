需求文档：人机交互前端（考试端）改造方案

背景与目标
- 背景：现有系统包含 4 年级交互、7 年级交互、7 年级追踪三类模块，规则上要求刷新不重置、登录直达、下一页自动提交、超时自动跳转、401 统一回登录。后续将支持“拼装式测评（Flow）”，按子模块序列组合生成新的评测流，并与批次绑定。
- 目标：
  - 统一数据提交格式与错误路径，降低新模块接入成本；
  - 统一计时与页面框架，提升一致性与可观测性；
  - 建立子模块接口（CMI）与 Flow 编排运行时，支持拼装流；
  - 保持对既有模块最小侵入（包装器适配），风险可控地迁移。
- 参考规范：`openspec/specs/assessment-core/spec.md`、`openspec/specs/data-format/spec.md`

范围与不做
- 做：统一提交、计时、页面框架、导航、Flow 运行时、CMI、键名约定、401 流程、跨刷新恢复。
- 不做：重写业务页面内容（各模块交互题内容沿用现有）；更改后端存储协议（保持 `/saveHcMark` 接口与 FormData 提交）。

总体设计
- 统一数据提交（usePageSubmission + 工具）
  - 工具：`createMarkObject/validateMarkObject` 与标准事件枚举（参见 Data Format Spec）。
  - Hook：`usePageSubmission({ onBefore?, onAfter?, onError? })` → `submit({ markOverride? }) : Promise<boolean>`；
  - 特性：指数退避重试；401 统一 `handleSessionExpired`；成功后清理操作缓存；DEV 下可跳过失败阻断。
- 统一计时器（TimerService + 显示组件）
  - 能力：主任务/问卷/注意事项计时；跨刷新恢复（离线扣减）；并发保护（只触发一次）；到期自动跳转。
  - API：`startTask(duration?)`、`startQuestionnaire(duration?)`、`startNotice(duration?)`、`pause/resume/reset`；
  - UI：`<TimerDisplay variant="task|questionnaire|notice" remainingSeconds warningThreshold criticalThreshold />`。
- 统一页面框架（AssessmentPageFrame）
  - 布局：左（导航）+ 顶（计时）+ 主体（children）+ 底部（下一页按钮）。
  - Props：`navigationMode`、`showTimer`、`nextEnabled`、`onNext`（默认包含“提交→导航”流程）。
  - 行为：进入/退出自动打点；onNext 内部调用 `usePageSubmission`；错误托盘统一展示。
- 统一导航（LeftStepperNav）
  - Props：`mode`（experiment|questionnaire）`currentStep` `totalSteps`；只读数字圆点；默认不可点击跳转。
- 子模块接口规范（CMI）与包装器
  - CMI：
    - `submoduleId: string`、`displayName: string`、`version: string`
    - `Component({ userContext, initialPageId, options })`
    - `getInitialPage(subPageNum)`、`getTotalSteps()`、`getNavigationMode(pageId)`、`getDefaultTimers()`、`onInitialize/onDestroy`
  - 拆分与包装：
    - 7年级蒸馒头 → `g7-experiment`(P02–P19) + `g7-questionnaire`(P20–P28)
    - 7年级追踪 → `g7-tracking-experiment`(1–13) + `g7-tracking-questionnaire`(14–21)
    - 4年级 → `g4-experiment`
- Flow 编排运行时（FlowModule）
  - 入口 URL：`/flow/<flowId>`；在 `ModuleRegistry` 注册。
  - 启动：拉取 FlowDefinition 与 progress，定位 `stepIndex` 与 `modulePageNum`；动态加载 `submoduleId → Component`；
  - 运行：注入统一计时/提交；子模块完成/计时到期 → 过渡页 → 下一步；本地持久化 `flow.<id>`；可选心跳回写。
- 本地持久化与键名约定
  - `core.*`（平台）、`module.<id>.*`（子模块）、`flow.<id>.*`（流）；兼容旧键读取、新键写入。
- 错误处理（401）
  - 统一 `handleSessionExpired`：清空状态与缓存 → 回登录；DEV 浮标提示。

详细需求与任务拆分
- 统一提交
  - 实现 shared：事件枚举、`createMarkObject/validateMarkObject`；
  - 实现 Hook：`usePageSubmission`；
  - 替换：grade-7-tracking/useDataLogger 内部委托；grade-7、grade-4 的提交路径切换至 Hook。
- 统一计时器
  - 引擎与显示，接入 App/Tracking/Grade4；四年级补齐跨刷新与超时跳转；
  - 并发保护开关（避免双重跳转/重复提交）。
- 统一页面框架与导航
  - AssessmentPageFrame、LeftStepperNav；
  - 逐页替换容器（不改具体题页）。
- CMI 与包装器
  - 拆分 `g7-*` 与 `g7-tracking-*`、`g4-experiment`；
  - 实现 `getInitialPage/getTotalSteps/getNavigationMode`；
  - 接入统一计时/提交。
- FlowModule
  - 新增模块定义，处理拉取 FlowDefinition 与 progress、过渡页与前进。
- 键名迁移与清理
  - 兼容期双写；`handleLogout/handleSessionExpired` 统一清理。

对现有模块的适配计划
- Grade-4：
  - 增加跨刷新计时恢复与到期跳转、401 回登录；
  - 使用统一提交 Hook；
  - 接入 AssessmentPageFrame 与 LeftStepperNav。
- Grade-7：
  - 提交切换到 Hook；
  - UI 计时显示统一；
  - 包装器导出 `g7-experiment/g7-questionnaire`。
- Grade-7-Tracking：
  - useDataLogger 内部委托 Hook；
  - PageLayout 中计时来源与阈值对齐；
  - 包装器导出 `g7-tracking-experiment/g7-tracking-questionnaire`。

验收标准
- 刷新恢复：当前页不变、剩余时间正确；
- 导航提交流：切页前提交；失败阻断（DEV 可放行）、401 回登录；
- 计时超时：自动跳子模块总结/问卷完成，且只触发一次；
- 数据结构：符合 Data Format Spec（Operation/Answer/code 时间格式等）；
- Flow：可通过 `/flow/<id>` 进入，按 steps 执行到末尾，过渡页逻辑正确。

风险与兼容策略
- 双重计时冲突：统一引擎与“只触发一次”保护；
- 本地键名冲突：命名空间与统一清理；
- 旧模块路径：逐步切换，保留开关；
 - DEV/PROD 差异：DEV 允许失败放行，PROD 阻断并提示。

兼容与灰度控制
- 四年级、七年级与追踪模块的统一页面框架均以“隐藏默认下一页按钮”方式接入，可随时切换回原有页面级按钮逻辑（无侵入点）。
- 统一计时器使用独立 scope：`module.grade-4.task`、`module.grade-7.{task,questionnaire}`、`module.g7-tracking.{task,questionnaire}`，通过 `TimerService.resetAll()` 可一次性回滚至传统实现。
- `usePageSubmission` 在 DEV 环境默认 `allowProceedOnFailureInDev=true`，生产环境保持严格阻断；401 走统一 `handleSessionExpired`，避免多入口不一致。
- 计时与导航变更都通过 `logOperation` 写入 `timer_start/timer_complete/page_enter/page_exit`，可在埋点面板追踪；若灰度失败，可依据这些操作码快速定位与回滚。

里程碑
- M1：统一提交规范与工具；修复四年级计时与 401；
- M2：统一计时/框架与导航；
 - M3：CMI 包装与 FlowModule 最小版；
- M4：全面迁移、灰度到全量。

迁移与兼容：原有导航/下一页/计时器如何处理
- 思路：逐步替换、双轨过渡，避免一次性大改。
- 容器托管策略
  - 在统一页面框架（AssessmentPageFrame）中托管“导航/计时/下一页”，并通过包装器将原页面“主体内容”嵌入；
  - 对于原模块内的导航/下一页/计时器组件，采用以下策略之一：
    1) 配置开关禁用（优先）：为原组件加开关 `enabled=false` 或条件渲染；
    2) 包装器兜底隐藏：在包装器中对旧选择器加样式隐藏（仅过渡期）；
    3) 渐进迁移：先隐藏“下一页/计时器”，最后替换导航，确保最小风险。
- 事件链不变
  - “下一页”统一由框架触发：框架先构建 MarkObject → 调用 usePageSubmission → 成功后导航；原页面若有“下一页”按钮，改为触发框架暴露的 `onNext()`。
  - 计时器：统一引擎驱动；原有页面若自带倒计时，关闭或转为仅展示态（不驱动逻辑）。

统一组件来源与样式规则
- 采用 7 年级的导航与计时器样式（像素级一致）
  - 导航：抽取 `StepNavigation` 视觉规范为 shared 组件 `LeftStepperNav`，保留圆点尺寸、间距、配色、完成/激活态样式。
  - 计时器：抽取 7 年级计时器 UI 为 `TimerDisplay`，一致的字体、色板、警告/严重阈值动效。
  - 文件建议：
    - 组件：`src/shared/ui/LeftStepperNav`、`src/shared/ui/TimerDisplay`
    - 样式：`src/shared/styles/nav-tokens.css`、`timer-tokens.css`（CSS 变量）
  - 依赖剥离：去除模块私有依赖（如上下文），所有输入由 props 提供；避免直接引用模块路径。
- 样式规范（摘要，建议加入 tokens）
  - 导航：
    - 圆点直径：24px；间距：16px；连接线：2px；
    - 颜色：默认 `--nav-dot`，完成 `--nav-dot-completed`，激活 `--nav-dot-active`；
    - 文字/计数：字号 14px，色值 `--nav-text`；
  - 计时器：
    - 位置：右上固定；字号 14px/16px；
    - 警告阈值：<300s；严重阈值：<60s；
    - 颜色：默认 `--timer-fg`，警告 `--timer-warning`，严重 `--timer-critical`；
  - 布局：
    - 左侧导航栏宽度：240px；主内容最小宽度：960px；
    - 过渡页层级：`z-index: 1000`；
  - 以上以 7 年级视觉为基线，可通过 CSS 变量在子模块覆写。

子模块命名与注册规范（与管理后台/后端协同）
- 命名规范
  - `submoduleId`：kebab-case，年级+类型，可加后缀区分系列：
    - `g7-experiment`、`g7-questionnaire`、`g7-tracking-experiment`、`g7-tracking-questionnaire`、`g4-experiment`
  - `moduleId`（Flow 步骤展示名）：沿用 `submoduleId` 或加语义别名（displayName）。
- 前端与后端的来源与存储
  - 前端：由工程确定并在 ModuleRegistry/CMI 包装器中导出；
  - 后端：管理后台录入“子模块注册表”，保存 `submoduleId/displayName/version/status`；
  - 管理端拼装时从注册表选择 `submoduleId`，保存到 FlowDefinition；
  - 登录：后端根据批次返回 `/flow/<flowId>` 与 `progress`；交互端据 `steps[].submoduleId` 通过前端映射加载包装器。
- 数据提交的模块标识
  - 复合页码：`pageNumber = 'M<stepIndex>:<subPageNum>'` 或 `'stepIndex.subPageNum'`；
  - 描述增强：在 `pageDesc` 附加 `[flowId/submoduleId/stepIndex]`；
  - 上报 `flow_context`：子模块首个页面记录一次，写入 flowId/submoduleId/stepIndex，便于后端检索。
