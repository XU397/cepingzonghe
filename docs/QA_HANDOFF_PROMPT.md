# 测试交接提示词

**交接日期**: 2025-11-16
**变更 ID**: `improve-flow-strictmode-and-tracking`
**测试类型**: 功能 + 性能验证
**优先级**: P0（阻塞发布）

---

## 一、测试背景

### 1.1 实施内容摘要
我们完成了以下 7 项核心优化：
1. ✅ **FlowContext 架构设计** - 新增独立 Flow 上下文系统
2. ✅ **g7-tracking 渲染优化** - 目标减少 50%+ 渲染次数（159 → ≤80 / 15s）
3. ✅ **Solution D: 路由级 StrictMode 切换** - `/flow/*` 路径禁用 StrictMode，传统模块启用
4. ✅ **DEV 渲染计数器** - 实时监控组件渲染性能
5. ✅ **FlowProvider Phase 0-1** - 新增 FlowProvider，稳定上下文传递
6. ✅ **FlowModule Hooks 修复** - 修复 React Hooks 顺序错误

### 1.2 测试目标
验证以下 5 项关键指标：
- **P0-1**: Hooks 错误消失（控制台无 "React has detected a change in the order of Hooks" 警告）
- **P0-2**: StrictMode 行为正确（`/flow/*` 禁用，传统模块启用）
- **P0-3**: 渲染计数器日志格式正确
- **P0-4**: g7-tracking 渲染性能达标（15s ≤ 80 次）
- **P0-5**: 页面功能正常（无白屏、无崩溃）

### 1.3 实施文档
- **实施记录**: `docs/IMPLEMENTATION_RECORD.md`
- **验证指南**: `docs/verification/hooks-fix-manual-test.md`

---

## 二、环境准备

### 2.1 代码分支
```bash
# 当前分支（确认代码已拉取最新）
git status
git pull origin main

# 确认修改文件
git log --oneline -5
```

### 2.2 启动开发服务器
```bash
# 进入项目目录
cd /path/to/project

# 安装依赖（如果需要）
npm install

# 启动开发服务器
npm run dev

# 预期输出
# VITE v4.5.14  ready in XXX ms
# ➜  Local:   http://localhost:3000/
```

### 2.3 浏览器要求
- **推荐**: Chrome 最新版（建议 120+）
- **必须**: 打开 DevTools（F12）
- **建议**: 清除浏览器缓存（Ctrl+Shift+Del）

---

## 三、测试步骤

### Test 1: Hooks 错误验证 ⭐ P0 阻塞
**目标**: 确认控制台无 React Hooks 顺序错误

#### 步骤
1. **清除缓存并打开页面**
   - 硬刷新（Ctrl+Shift+R）清除缓存
   - 访问：`http://localhost:3000/flow/test-flow-1`

2. **打开 DevTools Console**
   - 按 F12 打开 DevTools
   - 切换到 Console 标签

3. **执行压力测试**
   - 刷新页面 **3 次**（每次硬刷新 Ctrl+Shift+R）
   - 等待每次页面完全加载（约 2-3 秒）

4. **检查控制台**
   - ✅ **通过**: 无以下警告/错误
     ```
     Warning: React has detected a change in the order of Hooks called by FlowModule.
     ```
   - ❌ **失败**: 出现上述警告

#### 反馈格式
```markdown
### Test 1: Hooks 错误验证
- **状态**: [ ] 通过 / [ ] 失败
- **浏览器**: Chrome XXX
- **刷新次数**: 3 次
- **观察到的警告**:
  - [ ] 无警告（通过）
  - [ ] 有警告（失败）- 请粘贴完整错误日志
- **截图**: [如有错误，请提供截图]
```

---

### Test 2: StrictMode 行为验证 ⭐ P0 阻塞
**目标**: 确认 `/flow/*` 路径禁用 StrictMode，传统模块启用

#### 步骤
1. **测试 Flow 路径（应禁用 StrictMode）**
   - 访问：`http://localhost:3000/flow/test-flow-1`
   - 打开 Console，在控制台执行：
     ```javascript
     console.log('[TEST-FLOW] 单次日志 - 应只出现一次');
     ```
   - ✅ **通过**: 日志只出现 **1 次**
   - ❌ **失败**: 日志出现 **2 次**（说明 StrictMode 仍启用）

2. **测试传统模块路径（应启用 StrictMode）**
   - 访问：`http://localhost:3000/four-grade`（或 `/seven-grade`）
   - 打开 Console，在控制台执行：
     ```javascript
     console.log('[TEST-TRADITIONAL] 双次日志 - 应出现两次');
     ```
   - ✅ **通过**: 日志出现 **2 次**
   - ❌ **失败**: 日志只出现 **1 次**（说明 StrictMode 未启用）

#### 反馈格式
```markdown
### Test 2: StrictMode 行为验证
- **状态**: [ ] 通过 / [ ] 失败

#### 2.1 Flow 路径测试
- **URL**: http://localhost:3000/flow/test-flow-1
- **日志出现次数**: ___ 次
- **预期**: 1 次
- **结果**: [ ] 通过 / [ ] 失败

#### 2.2 传统模块测试
- **URL**: http://localhost:3000/four-grade
- **日志出现次数**: ___ 次
- **预期**: 2 次
- **结果**: [ ] 通过 / [ ] 失败

- **截图**: [如有异常，请提供截图]
```

---

### Test 3: 渲染计数器日志验证 ⭐ P0 阻塞
**目标**: 确认渲染计数器日志格式正确

#### 步骤
1. **访问 Flow 路径**
   - 访问：`http://localhost:3000/flow/test-flow-1`
   - 打开 Console

2. **触发快速渲染**（模拟超阈值场景）
   - 在 Console 执行以下代码：
     ```javascript
     // 快速刷新页面 10 次
     for (let i = 0; i < 10; i++) {
       setTimeout(() => window.location.reload(), i * 300);
     }
     ```
   - **注意**: 这会导致浏览器快速刷新，可能看到渲染计数器警告

3. **检查日志格式**
   - ✅ **通过**: 如出现日志，格式应为：
     ```
     [RenderCounter] component=FlowModule window=5s renders=120 mounts=60 threshold=100
     ```
   - ❌ **失败**: 格式不一致或缺少字段

4. **正常情况**
   - 如果**未出现**渲染计数器日志，说明渲染次数未超阈值，这是**正常现象**

#### 反馈格式
```markdown
### Test 3: 渲染计数器日志验证
- **状态**: [ ] 通过 / [ ] 失败 / [ ] 无日志（正常）

- **观察到的日志**:
  ```
  [粘贴实际日志，如有]
  ```

- **日志格式检查**:
  - [ ] 包含 `component=` 字段
  - [ ] 包含 `window=Xs` 字段
  - [ ] 包含 `renders=` 字段
  - [ ] 包含 `mounts=` 字段
  - [ ] 包含 `threshold=` 字段

- **结果**: [ ] 通过 / [ ] 失败 / [ ] 无日志（正常）
```

---

### Test 4: g7-tracking 渲染性能验证 ⭐ P0 阻塞
**目标**: 确认 g7-tracking 模块渲染次数 ≤ 80 / 15s

#### 步骤
1. **访问 g7-tracking 模块**
   - 访问：`http://localhost:3000/flow/grade-7-tracking`（如已配置）
   - 或访问：`http://localhost:3000/grade-7-tracking`（传统路径）

2. **保持页面打开 15 秒**
   - 不进行任何操作
   - 观察 Console 日志

3. **检查渲染计数器日志**
   - ✅ **通过**:
     - 日志显示 `renders=XX`，其中 `XX ≤ 80`
     - 或无日志（说明未超阈值，更好）
   - ❌ **失败**: `renders > 80`

4. **记录实际数值**
   - 粘贴完整日志供后续分析

#### 反馈格式
```markdown
### Test 4: g7-tracking 渲染性能验证
- **状态**: [ ] 通过 / [ ] 失败 / [ ] 无法测试（模块未配置）

- **测试时长**: 15 秒
- **观察到的日志**:
  ```
  [粘贴实际日志]
  ```

- **渲染次数**: ___ 次
- **挂载次数**: ___ 次
- **阈值**: 80 次
- **结果**: [ ] 通过（≤80） / [ ] 失败（>80） / [ ] 无日志（最佳）

- **备注**: [如有异常行为，请描述]
```

---

### Test 5: 页面功能正常性验证 ⭐ P0 阻塞
**目标**: 确认所有路由页面正常渲染，无白屏、无崩溃

#### 步骤
1. **测试 Flow 路径**
   - 访问：`http://localhost:3000/flow/test-flow-1`
   - ✅ **通过**: 页面正常显示，有内容
   - ❌ **失败**: 白屏、错误页、崩溃

2. **测试传统模块路径**
   - 访问：`http://localhost:3000/four-grade`
   - ✅ **通过**: 页面正常显示
   - ❌ **失败**: 白屏、错误页、崩溃

3. **测试主页/登录页**
   - 访问：`http://localhost:3000/`
   - ✅ **通过**: 登录页正常显示
   - ❌ **失败**: 白屏、错误页、崩溃

4. **检查控制台错误**
   - 打开 Console，检查是否有红色错误
   - ✅ **通过**: 无阻塞性错误（警告可忽略）
   - ❌ **失败**: 有严重错误（Error 级别）

#### 反馈格式
```markdown
### Test 5: 页面功能正常性验证
- **状态**: [ ] 通过 / [ ] 失败

#### 5.1 Flow 路径
- **URL**: http://localhost:3000/flow/test-flow-1
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

#### 5.2 传统模块路径
- **URL**: http://localhost:3000/four-grade
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

#### 5.3 主页/登录页
- **URL**: http://localhost:3000/
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

- **截图**: [如有异常，请提供截图]
```

---

## 四、综合测试报告模板

请测试工程师完成所有测试后，填写以下完整报告：

```markdown
# OpenSpec 变更测试报告

**变更 ID**: improve-flow-strictmode-and-tracking
**测试日期**: YYYY-MM-DD
**测试工程师**: [姓名]
**浏览器**: Chrome [版本号]
**测试环境**: 开发服务器 localhost:3000

---

## 测试结果汇总

| 测试项 | 状态 | 备注 |
|--------|------|------|
| Test 1: Hooks 错误验证 | [ ] 通过 / [ ] 失败 | |
| Test 2: StrictMode 行为验证 | [ ] 通过 / [ ] 失败 | |
| Test 3: 渲染计数器日志验证 | [ ] 通过 / [ ] 失败 / [ ] 无日志 | |
| Test 4: g7-tracking 性能验证 | [ ] 通过 / [ ] 失败 / [ ] 无法测试 | |
| Test 5: 页面功能正常性验证 | [ ] 通过 / [ ] 失败 | |

**总体结论**: [ ] 全部通过，可发布 / [ ] 部分失败，需修复

---

## 详细测试记录

### Test 1: Hooks 错误验证
- **状态**: [ ] 通过 / [ ] 失败
- **浏览器**: Chrome XXX
- **刷新次数**: 3 次
- **观察到的警告**:
  - [ ] 无警告（通过）
  - [ ] 有警告（失败）- 请粘贴完整错误日志
- **截图**: [链接或附件]

### Test 2: StrictMode 行为验证
- **状态**: [ ] 通过 / [ ] 失败

#### 2.1 Flow 路径测试
- **URL**: http://localhost:3000/flow/test-flow-1
- **日志出现次数**: ___ 次
- **预期**: 1 次
- **结果**: [ ] 通过 / [ ] 失败

#### 2.2 传统模块测试
- **URL**: http://localhost:3000/four-grade
- **日志出现次数**: ___ 次
- **预期**: 2 次
- **结果**: [ ] 通过 / [ ] 失败

- **截图**: [链接或附件]

### Test 3: 渲染计数器日志验证
- **状态**: [ ] 通过 / [ ] 失败 / [ ] 无日志（正常）

- **观察到的日志**:
  ```
  [粘贴实际日志，如有]
  ```

- **日志格式检查**:
  - [ ] 包含 `component=` 字段
  - [ ] 包含 `window=Xs` 字段
  - [ ] 包含 `renders=` 字段
  - [ ] 包含 `mounts=` 字段
  - [ ] 包含 `threshold=` 字段

- **结果**: [ ] 通过 / [ ] 失败 / [ ] 无日志（正常）

### Test 4: g7-tracking 渲染性能验证
- **状态**: [ ] 通过 / [ ] 失败 / [ ] 无法测试（模块未配置）

- **测试时长**: 15 秒
- **观察到的日志**:
  ```
  [粘贴实际日志]
  ```

- **渲染次数**: ___ 次
- **挂载次数**: ___ 次
- **阈值**: 80 次
- **结果**: [ ] 通过（≤80） / [ ] 失败（>80） / [ ] 无日志（最佳）

- **备注**: [如有异常行为，请描述]

### Test 5: 页面功能正常性验证
- **状态**: [ ] 通过 / [ ] 失败

#### 5.1 Flow 路径
- **URL**: http://localhost:3000/flow/test-flow-1
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

#### 5.2 传统模块路径
- **URL**: http://localhost:3000/four-grade
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

#### 5.3 主页/登录页
- **URL**: http://localhost:3000/
- **页面状态**: [ ] 正常 / [ ] 白屏 / [ ] 错误页
- **控制台错误**: [ ] 无 / [ ] 有（请粘贴）

- **截图**: [链接或附件]

---

## 问题与建议

### 发现的问题
1. [问题描述]
2. [问题描述]

### 改进建议
1. [建议内容]
2. [建议内容]

---

## 附件
- [ ] 控制台截图
- [ ] 错误日志文本
- [ ] 性能监控数据

**测试完成时间**: YYYY-MM-DD HH:MM
```

---

## 五、验收标准

### 5.1 P0 阻塞验收（必须全部通过）
| 标准 | 预期 | 实际 | 状态 |
|------|------|------|------|
| Hooks 错误消失 | 控制台无 "React has detected..." 警告 | ⏳ | [ ] 通过 / [ ] 失败 |
| StrictMode - Flow 路径 | `/flow/*` 日志出现 1 次 | ⏳ | [ ] 通过 / [ ] 失败 |
| StrictMode - 传统路径 | `/four-grade` 日志出现 2 次 | ⏳ | [ ] 通过 / [ ] 失败 |
| 渲染计数器格式 | 包含所有必需字段（如有日志） | ⏳ | [ ] 通过 / [ ] 失败 / [ ] 无日志 |
| g7-tracking 性能 | 15s ≤ 80 渲染（如有日志） | ⏳ | [ ] 通过 / [ ] 失败 / [ ] 无日志 |
| 页面功能正常 | 所有路由无白屏、无崩溃 | ⏳ | [ ] 通过 / [ ] 失败 |

### 5.2 发布决策
- **全部通过**: ✅ 可发布
- **Test 1-2 失败**: ❌ 阻塞发布，需紧急修复
- **Test 3-4 失败**: ⚠️ 评估影响后决定
- **Test 5 失败**: ❌ 严重问题，立即回滚

---

## 六、反馈方式

### 6.1 成功反馈
如所有测试通过，请回复：
```
✅ 所有测试通过，验收完成

测试报告：[粘贴完整报告]
```

### 6.2 失败反馈
如有测试失败，请回复：
```
❌ 发现问题，需要修复

失败测试项：Test X - [测试名称]
错误日志：
[粘贴完整错误日志]

截图：[附件链接]

详细报告：[粘贴完整报告]
```

### 6.3 反馈渠道
- **主渠道**: 回复本对话
- **紧急问题**: 标注 @开发工程师

---

## 七、常见问题 FAQ

### Q1: 开发服务器启动失败？
**A**: 执行以下命令：
```bash
rm -rf node_modules package-lock.json
npm install
npm run dev
```

### Q2: 页面一直白屏？
**A**:
1. 硬刷新（Ctrl+Shift+R）
2. 清除浏览器缓存
3. 检查控制台错误

### Q3: 控制台有很多警告？
**A**: 仅关注 **Error 级别**错误，Warning 可忽略

### Q4: g7-tracking 模块无法访问？
**A**: 如果 `/flow/grade-7-tracking` 404，尝试：
- `/grade-7-tracking`（传统路径）
- 如果仍无法访问，标记为"无法测试"

### Q5: 渲染计数器一直无日志？
**A**: 这是**正常现象**，说明渲染次数未超阈值（性能良好）

---

**文档版本**: v1.0
**生成时间**: 2025-11-16
**维护工程师**: Claude Code
**下次更新**: 测试反馈后
