# 模块化架构与新测评接入规范（当前项目分析 + 开发指引）

版本：1.0  
适用范围：本仓库（React + Vite 前端），所有测评模块（含现有四年级/七年级）

## 一、项目现状总览

- 技术栈与构建
  - 前端：React 18、Vite 4、React Router（按需使用）、CSS Modules（在四年级模块中）
  - 代码规范：ESLint（React/Hook）、Prettier 已配置
  - 目录入口：`src/main.jsx` → `src/App.jsx`

- 模块化路由与统一登录
  - 登录成功后，后端返回 `url`（模块标识）与 `pageNum`（进度恢复）。
  - App 通过 `AppContext` 持久化登录态与 `moduleUrl`；`App.jsx` 中若存在 `moduleUrl`，则渲染 `modules/ModuleRouter`。
  - `ModuleRouter` 通过 `ModuleRegistry` 根据 `url` 找到并加载对应模块，并将 `userContext`（统一上下文）与 `initialPageId`（根据 `pageNum` 恢复）传给模块组件。

- 已集成的测评模块
  - 七年级（蒸馒头）：沿用历史页面与 `PageRouter`，通过包装器 `src/modules/grade-7/wrapper.jsx` 接入模块系统。
    - 定义文件：`src/modules/grade-7/index.jsx`
    - 页面流映射：`src/utils/pageMappings.js`
  - 四年级（火车购票）：完全独立的模块化实现（自有 Context、页面、样式、导航等）。
    - 入口：`src/modules/grade-4/index.jsx`
    - 模块上下文：`src/modules/grade-4/context/Grade4Context.jsx`
    - 页面目录：`src/modules/grade-4/pages/`
    - 样式：CSS Modules，见 `src/modules/grade-4/styles/`

- 统一数据上报与 API
  - API 配置：`src/config/apiConfig.js`（区分开发/生产、代理、同源模式）
  - 登录与打点：`src/shared/services/apiService.js`、`src/shared/services/dataLogger.js`
  - App 侧统一打点：`AppContext.logOperation`、`AppContext.collectAnswer`；四年级模块内部也有打点集合并最终按统一格式提交。
  - 提交接口：`POST /stu/saveHcMark` 使用 `FormData`，字段 `mark` 为序列化 JSON（详见“数据上报契约”）。

## 二、关键流转（登录 → 模块加载 → 页面恢复）

1) 登录
- 开发态示例在 `src/pages/LoginPage.jsx`，真实环境调用 `loginUser`（`src/shared/services/apiService.js`）。
- 登录成功后调用 `AppContext.handleLoginSuccess(userData)`，并写入：`isAuthenticated`、`currentUser`、`batchCode`、`examNo`、`pageNum`、`moduleUrl`。

2) 选择模块并加载
- `App.jsx` 检测到 `moduleUrl` 后渲染 `modules/ModuleRouter.jsx`。
- `ModuleRouter`：构造 `userContext`（统一上下文）→ 初始化 `ModuleRegistry` → 按 `authInfo.url` 选定模块 → 计算 `initialPageId`（由模块 `getInitialPage(pageNum)` 决定）→ 渲染模块组件。

3) 页面恢复
- 七年级：调用 `getTargetPageIdFromPageNum`（`src/utils/pageMappings.js`）。
- 四年级：在模块内以自有映射将 `initialPageId` 转为数字页（1..n），完成恢复。

## 三、模块接口标准（必须实现）

所有测评模块需向 `ModuleRegistry` 注册一个“模块定义对象”，包含：

- `moduleId`：字符串，唯一标识（示例：`grade-7`、`grade-4`）。
- `displayName`：人类可读名称（示例：`7年级蒸馒头科学探究测评`）。
- `url`：路由选择键，必须以 `/` 开头，且与后端登录返回的 `url` 对齐（示例：`/seven-grade`、`/four-grade`）。
- `version`：版本号字符串，便于排障。
- `ModuleComponent`：React 组件，签名为 `({ userContext, initialPageId }) => ReactNode`。
- `getInitialPage(pageNum)`：根据后端 `pageNum` 返回模块内部的页面标识（如 `Page_14_Simulation_Intro_Exploration` 或自定义键 `notices` 等）。
- 可选：`onInitialize()`、`onDestroy()` 模块生命周期钩子。

约束与建议：
- `url` 必须全局唯一；`ModuleRegistry` 会在重复注册时发出警告。
- `getInitialPage` 需健壮处理非法/缺失的 `pageNum`（返回默认首页）。
- `ModuleComponent` 内部可选择：
  - 直接复用 App 的页面系统（如七年级包装 `PageRouter`）。
  - 构建自有 Context/页面系统（如四年级模块）。

## 四、目录与命名规范（新模块）

- 目录位置：`src/modules/grade-<年级或模块名>/`
- 推荐结构：
  - `index.jsx`：导出模块定义对象与 `ModuleComponent`。
  - `context/`：模块内状态管理（Context + Reducer）。
  - `pages/`：按步骤或功能拆分页面组件。
  - `components/`：模块内部通用组件。
  - `styles/`：CSS Modules（`*.module.css`）。
  - `moduleConfig.js`：模块元数据（模块 id、url、版本、定时配置、页面元信息等）。

- 文件命名：
  - 组件与页面文件：PascalCase（例：`UserSolutionDesignPage.jsx`）。
  - Hooks：`useXxx.js`（camelCase，`use` 前缀）。
  - 样式：`*.module.css`，类名 `kebab-case`，避免全局污染。

## 五、数据上报契约（统一、强制）

- 提交端点：`POST /stu/saveHcMark`
- 提交载体：`FormData`
  - `batchCode`：批次号
  - `examNo`：考号
  - `mark`：字符串，值为 JSON 序列化对象：
    - `pageNumber`：字符串（当前页号）
    - `pageDesc`：字符串（页面描述）
    - `operationList`：数组（操作日志）
    - `answerList`：数组（答案集合）
    - `beginTime`：`YYYY-MM-DD HH:mm:ss`
    - `endTime`：`YYYY-MM-DD HH:mm:ss`
    - `imgList`：数组（通常为空）

- 统一 API 帮助：`src/shared/services/apiService.js` 提供 `submitPageMarkData(payload)`，内部已处理端点、`FormData`、错误与 401 过期。
- 统一打点：优先调用 `AppContext.logOperation/collectAnswer`；若模块自有 Context，需在最终提交前合并为标准结构。

## 六、页面与导航（建议）

- 页面进入/退出应记录：`page_enter`、`page_exit` 操作，便于还原路径。
- 导航 API：
  - 七年级：沿用现有 `PageRouter` 与 `AppContext.navigateToPage`。
  - 四年级：模块内 `navigateToPage(pageId, { skipSubmit })` 会自动触发提交与清空操作记录（详见 `Grade4Context`）。
- 计时器：
  - 主任务计时：`AppContext.startTaskTimer()`；四年级有模块内部的全局计时器。
  - 问卷计时：`QuestionnaireTimer` 与相关上下文状态（七年级通用问卷页面）。

## 七、后端契约（登录返回）

- 登录成功返回对象需包含：
  - `batchCode`、`examNo`（必需）
  - `url`：模块选择键（如 `/seven-grade`、`/four-grade`），与前端 `ModuleRegistry` 对齐。
  - `pageNum`：用于页面恢复（数值或字符串）。
- App 侧处理：`AppContext.handleLoginSuccess` 会持久化上述字段并触发模块加载。

## 八、新测评接入步骤（SOP）

1) 新建目录与骨架
- 在 `src/modules/` 下创建 `grade-<新模块>/`，按“目录与命名规范”搭好结构。
- 在 `index.jsx` 中导出模块定义对象：`{ moduleId, displayName, url, version, ModuleComponent, getInitialPage }`。

2) 页面恢复规则
- 实现 `getInitialPage(pageNum)`，需覆盖：缺省/非法 `pageNum`、边界值（已全部完成时的降级）。

3) 数据与打点
- 页面进入时记录 `page_enter`，离开前记录 `page_exit`。
- 收集答案通过 `collectAnswer`，提交通过 `submitPageMarkData`（或沿用模块内封装但最终调用共享 API）。

4) 注册模块
- 在 `src/modules/ModuleRegistry.js` 的 `initialize()` 中动态导入并 `registerModule(NewModule)`（比照 4/7 年级写法）。

5) 打通后端
- 确认后端登录返回的 `url` 与新模块的 `url` 一致（例如：`/eight-grade`）。
- 在测试环境构造模拟登录响应或通过真实接口验证。

6) 自检清单
- 登录成功后是否正确进入新模块？
- 刷新页面后是否正确恢复？
- 导航是否单向、可控？
- 每页是否有进入/退出打点并随页提交？
- 401 过期能否正确提示和回到登录？
- 样式是否局部化（无全局污染）？

## 九、代码规范与质量

- 代码风格
  - 遵循仓库 `.eslintrc.json` 与 `.prettierrc`。
  - 函数组件 + Hooks；避免类组件。
  - 组件职责单一，拆分可复用逻辑到 `hooks/` 与 `components/`。

- 命名与可读性
  - 组件/页面使用 PascalCase，变量/函数使用 camelCase。
  - 关键流程与复杂计算（例如时间轴、计价、路径计算）需写明注释与输入/输出约束。

- 错误处理
  - 统一通过共享服务捕获 API 错误；识别 401 并触发登录恢复流程。
  - 模块内部错误在开发态可通过 `ModuleRouter` 的错误展示区输出详情。

## 十、调试与验证建议

- 本地启动：`npm run dev`。
- 登录：
  - 开发态可使用 `src/pages/LoginPage.jsx` 的简化表单；或接入 `loginUser`。
- 可视化信息：
  - `ModuleRouter` 在开发态会显示当前模块、初始页面等信息浮层（便于核对）。
  - API 配置日志输出当前模式与基地址（见 `src/config/apiConfig.js`）。

## 十一、示例与参考文件

- 模块注册：`src/modules/ModuleRegistry.js:1`
- 模块路由：`src/modules/ModuleRouter.jsx:1`
- 七年级模块定义：`src/modules/grade-7/index.jsx:1`
- 七年级包装器：`src/modules/grade-7/wrapper.jsx:1`
- 四年级模块定义：`src/modules/grade-4/index.jsx:1`
- 四年级模块上下文：`src/modules/grade-4/context/Grade4Context.jsx:1`
- App 全局上下文：`src/context/AppContext.jsx:1`
- 页面映射与页面恢复：`src/utils/pageMappings.js:1`
- 统一 API 服务：`src/shared/services/apiService.js:1`
- API 配置：`src/config/apiConfig.js:1`

---

附注：若需接入“第三个测评”，建议的 `url` 命名为 `/eight-grade` 或对应业务别名；目录名与 `moduleId` 与之对应以保持一致性。上线前与后端确认登录返回结构与 `url`，并确保 `ModuleRegistry.initialize()` 已包含注册逻辑。

