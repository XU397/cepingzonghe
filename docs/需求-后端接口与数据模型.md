需求文档：后端（API + DB + 算法）

背景与目标
- 背景：为支持“拼装式测评（Flow）”与批次绑定、账号登录直达流、进度恢复、评分与分析，需要后端提供数据模型、接口与校验能力。
- 目标：
  - 建立 Flow/步骤/批次绑定/用户进度的数据模型；
  - 登录返回 `/flow/<flowId>` 与结构化进度；
  - 兼容现有提交接口 `/saveHcMark`，并强化数据校验与观测；
  - 提供管理端所需的 CRUD/发布/绑定/查询接口；
  - 评分与分析的规则执行与报表导出。

数据模型（建议表）
- flows
  - flow_id (pk)、name、url、version、status(draft/published/archived)、definition(jsonb)、created_at、updated_at、published_by、audit_log
- flow_steps
  - flow_id、step_index、submodule_id、variant、overrides(jsonb)、transition_page(jsonb)
- batch_flows
  - batch_code (pk)、flow_id、version、bound_at、bound_by
- user_progress
  - exam_no、batch_code、flow_id、step_index、module_page_num、page_id(optional)、updated_at
- marks（沿用现有存储，或追加表以提升查询）
  - 保持 MarkObject 原样存储；必要时增加 flow_id/module_id/step_index 派生字段（或解析自 pageDesc）

API 规格
- 登录返回（扩展）
  - 入参：账号/密码（沿用现有）
  - 出参：
    - 正常单模块：`{ url: '/four-grade', pageNum: '11', ... }`
    - Flow：`{ url: '/flow/<flowId>', progress: { stepIndex: 1, modulePageNum: '13' }, ... }`
  - 说明：支持旧模式并存；Flow 优先返回结构化 `progress`，兼容复合 `pageNum`（如 `2.11`）。

- Flow 管理
  - `POST /api/flows`：创建 Flow，body 为 FlowDefinition（name/steps/…），返回 `{ flowId, url }`
  - `GET /api/flows/{flowId}`：查询定义
  - `GET /api/flows`：分页列表（过滤 status/version）
  - `POST /api/flows/{id}/publish`：发布，生成/提升 version，写入审计
  - （可选）`POST /api/flows/{id}/rollback`：回滚至指定 version

- 批次绑定
  - `POST /api/batches/{batchCode}/assign-flow`：绑定 `{ flowId }`
  - `GET /api/batches/{batchCode}/flow`：查询绑定情况

- 进度同步（可选）
  - `POST /api/progress`：更新 `{ examNo, batchCode, flowId, stepIndex, modulePageNum }`
  - 用于管理端进度可视化与断点恢复（考试端刷新也依赖本地持久化，服务端作为权威兜底）。

- 数据提交 `/saveHcMark`（保持不变）
  - 入参：FormData：`batchCode`、`examNo`、`mark`(JSON 字符串)
  - 要求：兼容 `Operation.value` 为对象/字符串；兼容复合 `pageNumber`；建议从 `pageDesc` 解析 `flowId/moduleId/stepIndex`（或在未来扩字段）。
  - 校验器：
    - 必填项检查（pageNumber/pageDesc/operationList/answerList/beginTime/endTime）
    - 事件类型枚举校验（引用 Data Format Spec）
    - 失败记录至异常日志表或日志系统（含 examNo/batchCode/flowId/stepIndex）。

- 数据查询与报表
  - `GET /api/marks`：支持多条件过滤（batchCode/examNo/flowId/moduleId/pageNumber/timeRange），分页；
  - `GET /api/reports/summary`：批次/模块/题型统计；
  - `GET /api/reports/export`：导出 CSV/Excel。

评分与分析（概要）
- 评分规则/量表配置接口：`POST /api/scoring/rules`、`GET /api/scoring/rules`；
- 规则执行接口：`POST /api/scoring/run`（按批次/账号范围）；
- 任务调度：日常批处理/大批量评分；
- 结果存储：scores（exam_no/batch_code/flow_id/module_id/score/details/json）。

安全与审计
- 鉴权/限流/权限校验；
- Flow 发布/回滚/绑定/账号导入等敏感操作写审计；
- 数据掩码与导出脱敏（必要时）。

性能与索引
- 为 user_progress、marks(flow_id,module_id,page_number,timestamp) 建立复合索引；
- 分区/归档策略，按批次或时间切分；
- 大字段（definition/mark）使用 jsonb 并合理建索引键。

验收标准
- 登录返回 Flow URL + 结构化 progress；
- Flow CRUD/发布/绑定接口可用并持久化；
- `/saveHcMark` 兼容对象化 value 与复合页码；
- 数据查询/报表/评分接口按规格工作；
- 审计记录完整；
- 压力下可用（目标 QPS 按业务评估）。

迁移与兼容
- 旧账号/批次可继续返回旧 URL；
- 逐步在 `pageDesc` 中加入 flow/module/step 描述；后续按窗口期扩字段；
- 数据回放校验评分一致性。

一、登录扩展：返回 Flow 入口与进度

放在文档现有 “登录返回（扩展）” 小节下，细化字段。

接口：POST /stu/login
入参：沿用现有账号登录字段（略）
出参（obj）：
{
  "url": "/flow/test-flow-1",          // 必填：考试入口路由
  "pageNum": "0.1",                    // 兼容旧模式：模块内页码（传统模块仍会用到）
  "batchCode": "250619",               // 必填：批次号
  "examNo": "1001",                    // 必填：考生编号
  "studentName": "本地模拟用户",        // 建议：用于前端展示
  "schoolCode": "24146",               // 业务已有字段
  "schoolName": "开发环境（Mock）",    // 业务已有字段

  // Flow 模式新增（当 url 以 /flow/ 开头时建议返回）
  "flowId": "test-flow-1",             // 建议：冗余传回，等同于 url 中的 ID
  "progress": {
    "stepIndex": 0,                    // 当前步骤索引，0 起
    "modulePageNum": "1"              // 子模块内页码（字符串），为空表示从模块默认起始页开始
    // 可选：未来可扩展 pageId、completed 等
  }
}
说明：
传统单模块场景可以不返回 flowId/progress，仅保留 url + pageNum；
Flow 场景建议同时返回 url='/flow/<flowId>' + flowId + progress，前端已经按此结构实现。
二、Flow 定义接口（考试端 & 管理端共用）

对应当前前端 endpoints.flow.getDefinition(flowId)，建议在“Flow 管理”下细化。

接口：GET /api/flows/{flowId}

路径参数：

flowId: string — Flow 唯一标识（例如 g7a-mix-001 或 test-flow-1）
响应（成功 200，obj 为 FlowDefinition）：

{
  "code": 200,
  "msg": "ok",
  "obj": {
    "flowId": "test-flow-1",
    "name": "测试 Flow - 7年级实验+4年级实验",
    "url": "/flow/test-flow-1",        // 前端根据此值路由
    "description": "用于开发测试的混合 Flow",
    "status": "draft",                 // draft/published/archived
    "version": "0.1.0",

    "steps": [
      {
        "submoduleId": "g7-experiment",         // 必填：子模块 ID（kebab-case）
        "displayName": "7年级蒸馒头实验",      // 显示名称（管理端/前端可用）
        "overrides": {                         // 可选：计时配置覆盖
          "timers": {
            "task": 2700,                      // 秒，覆盖子模块默认任务计时
            "questionnaire": 600               // 秒，覆盖问卷计时
          }
        },
        "transitionPage": {                    // 可选：过渡页配置
          "title": "第一部分已完成",
          "content": "您已完成7年级蒸馒头实验部分，稍后将进入4年级火车票任务。",
          "autoNextSeconds": 5                // 秒，为 0/缺省 表示需手动点击
        }
      },
      {
        "submoduleId": "g4-experiment",
        "displayName": "4年级火车票规划任务",
        "overrides": null,
        "transitionPage": null
      }
    ]
  }
}
与前端类型对齐：
对应 src/shared/types/flow.ts 里的 FlowDefinition 与 FlowStep；
前端 FlowOrchestrator 已按这个结构读取 flowId/name/url/steps[].submoduleId/overrides/transitionPage。
三、Flow 进度接口（Heartbeat + 进度恢复）

对应前端的 endpoints.flow.getProgress/getDefinition/updateProgress 和 useHeartbeat。

获取进度（可选，用于恢复）
接口：GET /api/flows/{flowId}/progress/{examNo}
路径参数：
flowId: string
examNo: string
查询参数（可选）：batchCode: string — 如需更严格区分同一个 examNo 在多个批次的情况。
响应：
{
  "code": 200,
  "msg": "ok",
  "obj": {
    "stepIndex": 0,               // 当前步骤索引，0 起
    "modulePageNum": "1",         // 子模块内页码，null 表示未开始
    "completed": false,           // 可选：是否整条 Flow 已完成
    "stepCompleted": {            // 可选：各步骤完成情况
      "0": true,
      "1": false
    },
    "lastUpdated": "2025-11-16T09:00:00Z"  // ISO 字符串，可选
  }
}
对应前端类型：FlowProgress（见 src/shared/types/flow.ts）。
更新/心跳写入进度（考试端调用，后端 upsert）
接口：POST /api/flows/{flowId}/progress
路径参数：
flowId: string
请求 Body（JSON）：
{
  "examNo": "1001",               // 必填
  "batchCode": "250619",          // 建议必填，便于区分批次
  "stepIndex": 1,                 // 必填：当前步骤索引
  "modulePageNum": "11",          // 必填：当前子模块页码（复合子页码已经由前端解析后传入）
  "pageId": "Page_11_Task_Experiment", // 可选：便于排错/查询
  "ts": 1763302463996             // 可选：前端心跳时间戳（毫秒）
}
响应：
{
  "code": 200,
  "msg": "ok",
  "obj": true
}
后端建议行为：
在 user_progress 中做 upsert(exam_no,batch_code,flow_id)；
stepIndex/module_page_num/page_id/updated_at 按最新一次写入；
不阻塞考试流程：即使写入失败，只记日志即可（前端已做本地持久化）。
四、统一提交接口 /stu/saveHcMark 的字段细化

这部分文档已有描述，这里补齐和当前前端实现完全一致的细节。

接口：POST /stu/saveHcMark

请求：Content-Type: multipart/form-data

batchCode: string — 批次号
examNo: string — 考生编号
mark: string — JSON 字符串，内容为 MarkObject
MarkObject 结构（与 specs/data-format/spec.md、前端 createMarkObject.js 一致）：

{
  "pageNumber": "M1:11",              // 复合页码编码，如 M<stepIndex>:<subPageNum>，或 "1.11"
  "pageDesc": "[flowId/submoduleId/stepIndex] 7年级实验-第1步", // 含 Flow 前缀
  "operationList": [
    {
      "code": 1,
      "targetElement": "按钮:下一页",
      "eventType": "page_exit",
      "value": "",
      "time": "2025-11-16 09:00:01",
      "pageId": "Page_11_Task_Experiment"    // 可选
    },
    {
      "code": 2,
      "targetElement": "页面",
      "eventType": "flow_context",
      "value": {
        "flowId": "g7a-mix-001",
        "stepIndex": 1,
        "submoduleId": "g7-experiment",
        "moduleName": "7年级蒸馒头实验"
      },
      "time": "2025-11-16 09:00:01"
    }
  ],
  "answerList": [
    {
      "code": 1,
      "targetElement": "Q1",
      "value": "A"
    }
  ],
  "beginTime": "2025-11-16 08:59:30",
  "endTime": "2025-11-16 09:00:01",
  "imgList": []
}
关键约束（与前端 validateMarkObject.js 一致）：

pageNumber/pageDesc/operationList/answerList/beginTime/endTime 必填，类型固定；
operationList[].code、answerList[].code 必须从 1 连续递增；
eventType 必须属于 EventTypes 枚举集合，包括：
page_enter/page_exit/page_submit_success/page_submit_failed/flow_context
click/input/input_blur/radio_select/checkbox_check/checkbox_uncheck/...
Operation.value 允许为字符串或对象（实验类操作、flow_context 等）；
time/beginTime/endTime 为 YYYY-MM-DD HH:mm:ss 字符串（前端已统一格式化）。
响应：

{ "code": 200, "msg": "ok", "obj": true }
出错约定：
401：视为会话过期，前端统一调用 handleSessionExpired，清理状态并回登录；
4xx/5xx：视为提交失败，前端会按指数退避重试，最终失败时提示用户并阻断下一步（Dev 可放行，Prod 阻断）。
五、批次绑定接口（供管理端使用，前端 Flow 也依赖）

这里主要重申字段名，与现有文档一致，方便后端照着实现。

绑定 Flow 到批次：POST /api/batches/{batchCode}/assign-flow
{
  "flowId": "g7a-mix-001",
  "version": "1.0.0"           // 可选：指定版本，默认最新已发布版
}
查询批次绑定：GET /api/batches/{batchCode}/flow
响应：

{
  "code": 200,
  "msg": "ok",
  "obj": {
    "batchCode": "250619",
    "flowId": "g7a-mix-001",
    "version": "1.0.0",
    "boundAt": "2025-11-16 09:00:00",
    "boundBy": "admin"
  }
}