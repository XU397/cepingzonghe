需求文档：后端（API + DB + 算法）

背景与目标
- 背景：为支持“拼装式测评（Flow）”与批次绑定、账号登录直达流、进度恢复、评分与分析，需要后端提供数据模型、接口与校验能力。
- 目标：
  - 建立 Flow/步骤/批次绑定/用户进度的数据模型；
  - 登录返回 `/flow/<flowId>` 与结构化进度；
  - 兼容现有提交接口 `/saveHcMark`，并强化数据校验与观测；
  - 提供管理端所需的 CRUD/发布/绑定/查询接口；
  - 评分与分析的规则执行与报表导出。

数据模型（建议表）
- flows
  - flow_id (pk)、name、url、version、status(draft/published/archived)、definition(jsonb)、created_at、updated_at、published_by、audit_log
- flow_steps
  - flow_id、step_index、submodule_id、variant、overrides(jsonb)、transition_page(jsonb)
- batch_flows
  - batch_code (pk)、flow_id、version、bound_at、bound_by
- user_progress
  - exam_no、batch_code、flow_id、step_index、module_page_num、page_id(optional)、updated_at
- marks（沿用现有存储，或追加表以提升查询）
  - 保持 MarkObject 原样存储；必要时增加 flow_id/module_id/step_index 派生字段（或解析自 pageDesc）

API 规格
- 登录返回（扩展）
  - 入参：账号/密码（沿用现有）
  - 出参：
    - 正常单模块：`{ url: '/four-grade', pageNum: '11', ... }`
    - Flow：`{ url: '/flow/<flowId>', progress: { stepIndex: 1, modulePageNum: '13' }, ... }`
  - 说明：支持旧模式并存；Flow 优先返回结构化 `progress`，兼容复合 `pageNum`（如 `2.11`）。

- Flow 管理
  - `POST /api/flows`：创建 Flow，body 为 FlowDefinition（name/steps/…），返回 `{ flowId, url }`
  - `GET /api/flows/{flowId}`：查询定义
  - `GET /api/flows`：分页列表（过滤 status/version）
  - `POST /api/flows/{id}/publish`：发布，生成/提升 version，写入审计
  - （可选）`POST /api/flows/{id}/rollback`：回滚至指定 version

- 批次绑定
  - `POST /api/batches/{batchCode}/assign-flow`：绑定 `{ flowId }`
  - `GET /api/batches/{batchCode}/flow`：查询绑定情况

- 进度同步（可选）
  - `POST /api/progress`：更新 `{ examNo, batchCode, flowId, stepIndex, modulePageNum }`
  - 用于管理端进度可视化与断点恢复（考试端刷新也依赖本地持久化，服务端作为权威兜底）。

- 数据提交 `/saveHcMark`（保持不变）
  - 入参：FormData：`batchCode`、`examNo`、`mark`(JSON 字符串)
  - 要求：兼容 `Operation.value` 为对象/字符串；兼容复合 `pageNumber`；建议从 `pageDesc` 解析 `flowId/moduleId/stepIndex`（或在未来扩字段）。
  - 校验器：
    - 必填项检查（pageNumber/pageDesc/operationList/answerList/beginTime/endTime）
    - 事件类型枚举校验（引用 Data Format Spec）
    - 失败记录至异常日志表或日志系统（含 examNo/batchCode/flowId/stepIndex）。

- 数据查询与报表
  - `GET /api/marks`：支持多条件过滤（batchCode/examNo/flowId/moduleId/pageNumber/timeRange），分页；
  - `GET /api/reports/summary`：批次/模块/题型统计；
  - `GET /api/reports/export`：导出 CSV/Excel。

评分与分析（概要）
- 评分规则/量表配置接口：`POST /api/scoring/rules`、`GET /api/scoring/rules`；
- 规则执行接口：`POST /api/scoring/run`（按批次/账号范围）；
- 任务调度：日常批处理/大批量评分；
- 结果存储：scores（exam_no/batch_code/flow_id/module_id/score/details/json）。

安全与审计
- 鉴权/限流/权限校验；
- Flow 发布/回滚/绑定/账号导入等敏感操作写审计；
- 数据掩码与导出脱敏（必要时）。

性能与索引
- 为 user_progress、marks(flow_id,module_id,page_number,timestamp) 建立复合索引；
- 分区/归档策略，按批次或时间切分；
- 大字段（definition/mark）使用 jsonb 并合理建索引键。

验收标准
- 登录返回 Flow URL + 结构化 progress；
- Flow CRUD/发布/绑定接口可用并持久化；
- `/saveHcMark` 兼容对象化 value 与复合页码；
- 数据查询/报表/评分接口按规格工作；
- 审计记录完整；
- 压力下可用（目标 QPS 按业务评估）。

迁移与兼容
- 旧账号/批次可继续返回旧 URL；
- 逐步在 `pageDesc` 中加入 flow/module/step 描述；后续按窗口期扩字段；
- 数据回放校验评分一致性。

