用户故事 2.4: 交互式地图与数据录入 (开发详稿 v2 - 修订版)
状态: 草稿 (Draft)

父级史诗: 2 - 购票流程页面开发

用户故事 (User Story)
作为一名应用开发者，
我需要实现一个高度交互的地图页面，允许用户通过点击左侧按钮或直接点击地图上的路径来探索5条不同路线，地图会高亮显示所选路线并在每一分段上展示里程，同时我需要能在指定的输入框中计算并填入总里程，
以便让用户通过多种直观的操作方式，深入理解路线构成并完成教学任务。

验收标准 (Acceptance Criteria) - 已更新
[布局与静态元素] 页面初始状态的布局和静态元素必须与截图 image_e8c382.png 完全一致。 (无变化)

[按钮交互] 点击左侧任一“路线”按钮，地图区域必须无延迟地更新，高亮显示对应路线，并展示各分段里程。 (无变化)

[<ins>新增</ins> - 路径点击交互] 用户可以直接点击地图上的任一灰色路径段来激活对应的完整路线。

点击任意属于某特定路线的灰色路段，效果等同于点击该路线的左侧按钮，整条路线将被高亮显示，并出现相应的分段里程标签。

对于被多条路线共享的路段（例如“小明家”到交叉点J5），点击它应激活编号较小的路线（例如，点击该路段会激活“路线4”）。

点击任一灰色路径段时，系统根据该段的归属映射激活编号最小的路线（即便当前已有高亮）。

[地图高亮细节] 路线高亮显示时，视觉效果必须精确。

高亮路径的颜色、分段里程标签的内容和位置，必须与对应路线的截图 (image_e8c667.png 至 image_e8ca25.png) 完全一致。

分段里程标签只在对应路线被激活时显示。

高亮路径应以更粗的线条叠加在灰色底图之上进行渲染。

[数据输入与验证] “路线1”和“路线5”的输入框功能必须符合要求。 (AC #3 -> #5, 无变化)

[状态控制] “下一页”按钮的状态必须由输入框的内容动态控制。 (AC #4 -> #6, 无变化)

任务 / 子任务 (Tasks / Subtasks) - 已更新
[ ] 任务 1: 页面基础布局搭建 (AC: #1) (无变化)

[ ] 任务 2: 基础地图绘制 (AC: #1, #2, #3)

[ ] 2.1: 根据“开发说明”中定义的节点坐标，在中央地图区域绘制所有10个节点，并确保其样式（图标、颜色）正确。

[ ] 2.2: 根据“开发说明”中的线段定义，为每一条基础灰色路径创建可点击的SVG路径元素，并赋予唯一的ID。

[ ] 任务 3: 状态管理与交互逻辑 (AC: #2, #3, #6)

[ ] 3.1: 设置状态变量 activeRoute。

[ ] 3.2: 为五个路线按钮和所有12个灰色路径元素绑定点击事件。

按钮点击事件直接更新 activeRoute。

路径点击事件需要先查询该路径属于哪条路线（参考开发说明中的路径归属映射），然后更新 activeRoute。

[ ] 3.3: 设置并绑定输入框的状态变量。

[ ] 3.4: 实现监听逻辑，根据输入框状态更新“下一页”按钮。

[ ] 任务 4: 路线高亮与里程渲染 (AC: #2, #4) (无变化)

[ ] 任务 5: 输入框功能实现 (AC: #5, #6) (无变化)

开发说明 (Dev Notes) - 已更新和复核
1. 统一坐标系与节点定义

坐标系 300 x 200。节点定义如下，已增加节点样式说明：

节点ID	节点名称	坐标 (x, y)	样式说明
NCN_STATION	南充北站	(30, 30)	圆形背景，内含“火车”图标
XIAOMING_HOME	小明家	(120, 80)	紫色圆形背景，内含“图钉”图标
NC_STATION	南充站	(240, 180)	圆形背景，内含“火车”图标
J1 - J7	(交叉点)	(见上文)	实心灰色小圆点

导出到 Google 表格
2. 基础地图线段定义 (灰色路径)

(此部分无变化，但请注意在实现时，每个<path>元素都应有一个ID，以便于事件绑定)

3. <ins>新增</ins> - 路径归属映射 (用于点击交互)

这是实现路径点击功能的关键逻辑。开发时需建立一个从路径ID到路线编号的映射关系。

Route 1: 包含线段 (XIAOMING_HOME, J2), (J2, NCN_STATION)

Route 2: 包含线段 (XIAOMING_HOME, J1), (J1, NCN_STATION)

Route 3: 包含线段 (XIAOMING_HOME, J3), (J3, J4), (J4, J7), (J7, NC_STATION)

Route 4: 包含线段 (XIAOMING_HOME, J5), (J5, J4), (J4, J7), (J7, NC_STATION)

Route 5: 包含线段 (XIAOMING_HOME, J5), (J5, J6), (J6, J7), (J7, NC_STATION)

决策规则: 当一个路段属于多条路线时（如 (XIAOMING_HOME, J5)），点击该路段默认激活编号最小的路线。因此，点击 (XIAOMING_HOME, J5) 应激活 Route 4。

4. 交互式路线覆盖层定义 - 已复核

(此部分内容经复核无误，完全覆盖了图片中的所有分段里程标签)

关于标签：所有分段里程标签的字体为无衬线体（如Arial, Helvetica），白色背景，黑色文字，带有细边框。它们仅在对应路线高亮时才显示。

如果 activeRoute === 1:

高亮路径: XIAOMING_HOME -> J2 -> NCN_STATION

里程标签: 3.64km, 4.26km

如果 activeRoute === 2:

高亮路径: XIAOMING_HOME -> J1 -> NCN_STATION

里程标签: 5.32km, 3.33km

如果 activeRoute === 3:

高亮路径: XIAOMING_HOME -> J3 -> J4 -> J7 -> NC_STATION

里程标签: 2.5km, 3km, 2.4km, 2.3km

如果 activeRoute === 4:

高亮路径: XIAOMING_HOME -> J5 -> J4 -> J7 -> NC_STATION

里程标签: 2km, 2.93km, 2.4km, 2.3km


如果 activeRoute === 5:

高亮路径: XIAOMING_HOME -> J5 -> J6 -> J7 -> NC_STATION

里程标签: 2km, 2.09km, 1.49km, 2.3km

测试 (Testing) - 已更新
集成测试:

新增：模拟点击灰色路段 (J2, NCN_STATION)，验证路线1被完整高亮。

新增：模拟点击共享路段 (XIAOMING_HOME, J5)，验证路线4被高亮，而不是路线5。

(其余测试用例无变化)

QA 结果 (QA Results)

结论: 有条件通过（关键不一致已修复；以下建议不阻塞上线）

关键问题 - 已修复
1. 路线4定义不一致问题已统一：
   - 现文档与实现保持一致：Route 4 = XIAOMING_HOME -> J5 -> J4 -> J7 -> NC_STATION。
   - 同步修订了“路径归属映射”、“高亮路径描述”及相关测试条目。

一般问题与改进建议
2. 文档状态与完成度不符：文件头为“状态: 草稿”，且任务清单均未勾选。若开发已完成，应将状态更新为“完成”或“就绪待测”，并同步勾选完成的任务，以便测试与追踪。
3. 点击规则边界未完全明确：说明“点击已处于高亮状态的路线上的路段，无任何变化”。建议补充当点击当前高亮路线上的“共享段”（例如 (XIAOMING_HOME, J5)）时是否允许切换路线，或保持不变，避免实现歧义。
4. 可访问性与移动端：未定义键盘导航（按钮与路径段的可聚焦性与 ARIA 标签）、触摸命中区域（建议≥24px）、读屏描述与焦点管理。建议补充无障碍规范与移动端命中区域说明。
5. 输入校验细节（建议，非本迭代必做）：若未来启用数字校验，需明确小数点规则、负数是否允许、最大长度/范围、粘贴与空格处理、科学计数法、前导零、非法字符反馈方式（阻止输入或提示错误）。
6. 左侧导航高亮持久性：建议明确跨路由返回/刷新后的状态保持方案（例如依赖全局状态或路由守卫），并在测试中覆盖。
7. 性能与抖动：路线切换与分段标签渲染需避免重复创建节点/重绘闪烁，建议明确是否复用 SVG 节点与标签容器，以及快速连击（按钮/路径）下的节流/去抖策略。

建议补充测试用例（在现有“测试 (Testing)”基础上）
- 路线切换一致性：依次点击五个“路线”按钮与对应任一灰色路径段，验证 activeRoute 与可视结果完全一致。
- 共享段优先级：点击 (XIAOMING_HOME, J5) 时优先激活路线4；随后点击同一段不应切换为路线5。
- 重复点击无副作用：对已高亮路线上的任意路段重复点击，验证无二次渲染或状态抖动（可通过渲染计数或 DOM 变更快照校验）。
- 标签唯一性：任一时刻仅显示当前路线的分段里程标签，切换路线后旧标签应立即隐藏；标签位置与截图像素对齐（可设容差±1px/±1pt）。
- 输入校验：
  - 非法字符（字母、符号、空格）被拦截或提示，值不进入状态；
  - 合法数值（含小数）可输入；超长/超范围值给出用户可见反馈；
  - 两输入框均为有效数值时“下一页”激活；清空任一后立即禁用。
- 导航高亮：在 2.4 全流程中持续高亮“4 火车购票:出发站”；刷新与返回后一致。
- 移动端触控：在触摸设备/模拟器上点击所有路径段均可触发正确路线，命中区域满足≥24px。
- 快速交互稳定性：对按钮/路径进行快速连续点击，验证无错乱和状态竞态。

验收建议
- 先修复路线4定义不一致问题，并与截图/里程数据复核一致后再进行回归。
- 明确输入格式/范围与错误反馈策略，补充无障碍与移动端命中区域细节。
- 将“状态”与任务清单更新为实际完成度，便于测试与追踪。

回归通过标准
- 路线4定义一致，相关测试全部通过；
- 新增输入校验与导航持久性测试全部通过；
- 快速交互稳定性与移动端触控测试通过；
- 像素与标签位置对齐度满足容差要求。

版本标记
- QA-2.4-20250818