# 故事 2.3: 因素分析与多选交互 (Factor Analysis and Multi-Selection Interaction)

**状态**: Ready to Developement  
**Epic**: 史诗 2 - "火车购票"测评模块 (基于PDF)  
**优先级**: High  
**估算**: 5 Story Points  

## 故事

作为一名四年级学生，我想要在火车购票测评中分析影响购票决策的相关因素，并通过多选交互方式选择这些因素，以便我能够系统性地思考购票过程中需要考虑的各种要素，为后续的路线分析和决策制定奠定基础。

## 业务价值

- **认知能力培养**: 帮助学生学会分析复杂问题的影响因素，培养系统性思维
- **交互体验优化**: 通过直观的多选界面提升学生的操作体验和参与度
- **数据收集完整性**: 确保收集到学生对购票因素的完整认知数据，为教学评估提供依据
- **学习路径连贯性**: 承接问题识别阶段，为后续路线分析阶段提供思维基础

## 验收标准

- [x] **AC1**: 因素展示界面
  - 页面顶部显示"火车购票"标题
  - 左侧显示小明角色图像和对话气泡，内容为："我要为爸爸妈妈和自己购买从南充到成都的火车票。从家出发到成都东站的总用时要尽量短，且要在18时30分前到达。"
  - 右侧显示问题提示："为解决上述问题，请问小明在购票时需要考虑以下哪些因素？单击选择你认为正确的选项，再次单击可取消选择（可多选）。"
  - 展示6个预定义的因素选项，分为两列布局：
    - 左列：小明家到出发站的路程、成都东站到舅舅家的路程、剩余车票数
    - 右列：火车车厢数、火车到达时间、火车发展历史
  - 每个因素以可点击的复选框形式呈现，复选框左侧带有方形选择框
  - 界面布局参考现有ProblemIdentificationPage的左右分栏设计

- [x] **AC2**: 多选交互逻辑
  - 学生可以选择多个因素（至少1个，最多6个）
  - 点击复选框时，选中状态有明显的视觉反馈（选中时复选框内显示勾选标记）
  - 支持取消已选择的因素（再次点击已选中的选项）
  - 选择状态实时更新到Grade4Context状态管理中的relevantFactors字段
  - 每次选择/取消选择操作都记录到操作日志中

- [x] **AC3**: 表单验证与导航
  - 当没有选择任何因素时，"下一页"按钮保持禁用状态
  - 当至少选择一个因素时，"下一页"按钮变为可用状态
  - 点击"下一页"按钮时，收集所有选中的因素并提交到后端
  - 成功提交后跳转到下一个页面（路线分析页面）

- [x] **AC4**: 数据记录与日志
  - 记录页面进入时间和离开时间
  - 记录每次因素选择/取消选择的操作日志
  - 记录最终选择的因素列表作为答案数据
  - 所有操作数据符合MarkObject数据格式规范

- [x] **AC5**: 视觉一致性与响应式设计
  - 页面样式严格遵循现有的CSS变量系统
  - 选择框样式与整体设计风格保持一致
  - 支持不同屏幕尺寸的响应式布局
  - 动画效果流畅，提升用户体验

## 任务分解

### Task 1: 创建因素分析页面组件 (AC1, AC5)
- [ ] 创建 `src/modules/grade-4/pages/TrainTicketFactorsPage.jsx` 文件
- [ ] 参考现有ProblemIdentificationPage的左右分栏布局设计
- [ ] 实现页面顶部绿色圆形编号"3"和"火车购票"标题
- [ ] 实现左侧小明角色图像和对话气泡展示
- [ ] 实现右侧问题提示和6个因素选项的展示界面
- [ ] 应用符合ProblemIdentificationPage样式规范的CSS设计

### Task 2: 实现多选交互逻辑 (AC2, AC4)
- [ ] 在Grade4Context中添加 `relevantFactors` 状态字段
- [ ] 实现因素选择/取消选择的状态管理逻辑
- [ ] 添加选中状态的视觉反馈效果
- [ ] 集成操作日志记录功能，记录每次选择操作

### Task 3: 实现表单验证与导航 (AC3)
- [ ] 添加表单验证逻辑，检查是否至少选择一个因素
- [ ] 实现"下一页"按钮的启用/禁用状态控制
- [ ] 实现页面跳转逻辑，更新 `currentPage` 状态
- [ ] 集成答案收集功能，提交选中的因素列表

### Task 4: 数据收集与提交集成 (AC4)
- [ ] 实现页面进入和离开时间的记录
- [ ] 集成 `logOperation` 和 `collectAnswer` 函数
- [ ] 确保数据格式符合MarkObject规范
- [ ] 添加数据提交的错误处理机制

### Task 5: 样式优化与测试 (AC5)
- [ ] 优化选择框的视觉设计和交互动画
- [ ] 测试不同屏幕尺寸下的响应式布局
- [ ] 验证与现有页面的视觉一致性
- [ ] 进行用户体验测试和优化

## 开发笔记

### 前一故事的关键洞察 [Source: docs/stories/2.2.scenario-definition-problem-identification.md#Dev Notes]

**页面组件标准模板**:
```jsx
import React, { useEffect, useState } from 'react';
import { useAppContext } from '../../../context/AppContext';
import { useGrade4Context } from '../context/Grade4Context';
// 参考ProblemIdentificationPage的样式结构，不使用AssessmentPageLayout
import styles from './TrainTicketFactorsPage.module.css';

const TrainTicketFactorsPage = () => {
  const { logOperation, collectAnswer } = useAppContext();
  const { state, updateState } = useGrade4Context();
  const [pageEnterTime] = useState(new Date());

  useEffect(() => {
    logOperation({
      targetElement: '页面',
      eventType: 'page_enter',
      value: '进入因素分析页面'
    });
  }, []);

  // 页面布局参考ProblemIdentificationPage.jsx：
  // - 使用CSS Modules进行样式管理
  // - 左右分栏布局：leftImageArea + rightInputArea
  // - 页面顶部：titleContainer + pageTitle
  // - 左侧：小明角色图像和对话气泡
  //   - 角色图像：卡通风格的小男孩形象
  //   - 对话气泡：橙色背景，内容："我要为爸爸妈妈和自己购买从南充到成都的火车票。从家出发到成都东站的总用时要尽量短，且要在18时30分前到达。"
  // - 右侧：问题提示和因素选择界面
  //   - 问题标题："为解决上述问题，请问小明在购票时需要考虑以下哪些因素？"
  //   - 操作提示："单击选择你认为正确的选项，再次单击可取消选择（可多选）。"
  //   - 因素选项：6个复选框，分为两列布局
  // - 页面顶部：绿色圆形编号"3"和"火车购票"标题
  // - 底部：导航按钮区域
  
  return (
    <div className={styles.trainTicketFactorsContainer}>
      {/* 参考ProblemIdentificationPage的结构实现 */}
    </div>
  );
};
```

**状态管理扩展** [Source: docs/architecture/data-models.md#Grade4State]:
```javascript
// Grade4State 中需要添加的字段
const stateExtension = {
  currentPage: 3, // 因素分析页面编号
  relevantFactors: [], // 选中的因素列表: string[]
};
```

**操作日志记录规范** [Source: docs/architecture/data-models.md#操作日志记录]:
```javascript
// 因素选择操作记录
logOperation({
  targetElement: '因素选择框',
  eventType: 'click',
  value: '时间' // 选中的因素名称
});

// 因素取消选择操作记录
logOperation({
  targetElement: '因素选择框',
  eventType: 'click',
  value: '取消选择-时间'
});
```

### 技术实现架构

**多选组件设计** [Source: docs/architecture/components.md#UI组件规范]:
```jsx
// 因素选择组件实现
const FactorSelector = ({ factors, selectedFactors, onFactorToggle }) => {
  return (
    <div className="factor-selector-grid">
      {factors.map(factor => (
        <div
          key={factor}
          className={`factor-option ${selectedFactors.includes(factor) ? 'selected' : ''}`}
          onClick={() => onFactorToggle(factor)}
        >
          <div className="factor-checkbox">
            {selectedFactors.includes(factor) && <span className="checkmark">✓</span>}
          </div>
          <span className="factor-label">{factor}</span>
        </div>
      ))}
    </div>
  );
};
```

**CSS样式规范** [参考: ProblemIdentificationPage.module.css]:
```css
/* 火车购票因素分析页面样式 - 参考ProblemIdentificationPage的设计模式 */
@import '../styles/shared-variables.css';

/* 页面根容器 - 参考problemIdentificationContainer */
.trainTicketFactorsContainer {
  width: 100%;
  height: 100%;
  min-height: 100vh;
  position: relative;
  display: flex;
  flex-direction: column;
  font-family: var(--font-family-primary);
  overflow: hidden;
}

/* 页面标题容器 - 参考titleContainer */
.titleContainer {
  position: absolute;
  top: var(--spacing-lg);
  left: 50%;
  transform: translateX(-50%);
  z-index: 3;
  background: rgba(255, 255, 255, 0.95);
  padding: var(--spacing-sm) var(--spacing-xl);
  border-radius: var(--button-border-radius-round);
  border: 2px solid var(--border-color);
  box-shadow: var(--shadow-card);
  backdrop-filter: blur(10px);
}

/* 主内容区域 - 参考mainContent左右分栏 */
.mainContent {
  width: 100%;
  height: 100%;
  min-height: 100%;
  display: flex;
  flex-direction: row;
}

/* 左侧图像区域 - 参考leftImageArea */
.leftImageArea {
  width: 50%;
  height: 100%;
  min-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
}

/* 右侧输入区域 - 参考rightInputArea */
.rightInputArea {
  width: 50%;
  height: 100%;
  min-height: 100%;
  padding: calc(var(--spacing-4xl) + var(--spacing-lg)) var(--spacing-3xl) var(--spacing-3xl) var(--spacing-3xl);
  display: flex;
  flex-direction: column;
  justify-content: center;
  box-sizing: border-box;
}

/* 因素选择器网格布局 */
.factorSelectorGrid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  padding: var(--spacing-xl);
}

/* 因素选项样式 */
.factorOption {
  display: flex;
  align-items: center;
  padding: var(--spacing-lg);
  border: 3px solid var(--border-color);
  border-radius: var(--border-radius-large);
  background: var(--bg-white);
  cursor: pointer;
  transition: var(--transition-normal);
  font-family: var(--font-family-primary);
}

.factorOption:hover {
  border-color: var(--color-primary);
  box-shadow: var(--shadow-card);
}

.factorOption.selected {
  border-color: var(--color-success);
  background: rgba(var(--color-success-rgb), 0.1);
}

/* 复选框样式 */
.factorCheckbox {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-radius: 4px;
  margin-right: var(--spacing-md);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-white);
}

.factorOption.selected .factorCheckbox {
  border-color: var(--color-success);
  background: var(--color-success);
  color: white;
}

.factorLabel {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  color: var(--color-dark);
  line-height: var(--line-height-normal);
}
```

**表单验证逻辑** [Source: docs/architecture/core-workflows.md#表单验证]:
```jsx
// 表单验证和按钮状态控制
const isFormValid = selectedFactors.length > 0;

const handleNextPage = () => {
  if (!isFormValid) return;
  
  // 收集答案
  collectAnswer({
    targetElement: '因素分析',
    value: selectedFactors
  });
  
  // 页面跳转
  updateState({ currentPage: state.currentPage + 1 });
};
```

### 数据模型集成

**Grade4Context状态更新** [Source: docs/architecture/data-models.md#Grade4State]:
```javascript
// 因素选择状态管理
const handleFactorToggle = (factor) => {
  const currentFactors = state.relevantFactors || [];
  const isSelected = currentFactors.includes(factor);
  
  let updatedFactors;
  if (isSelected) {
    updatedFactors = currentFactors.filter(f => f !== factor);
    logOperation({
      targetElement: '因素选择框',
      eventType: 'click',
      value: `取消选择-${factor}`
    });
  } else {
    updatedFactors = [...currentFactors, factor];
    logOperation({
      targetElement: '因素选择框',
      eventType: 'click',
      value: factor
    });
  }
  
  updateState({ relevantFactors: updatedFactors });
};
```

**预定义因素列表** [Source: PDF第3页设计稿]:
```javascript
const PURCHASE_FACTORS = [
  '小明家到出发站的路程',
  '成都东站到舅舅家的路程', 
  '剩余车票数',
  '火车车厢数',
  '火车到达时间',
  '火车发展历史'
];
```

### 文件位置规范

**页面组件位置** [Source: docs/architecture/unified-project-structure.md]:
- 主页面组件: `src/modules/grade-4/pages/TrainTicketFactorsPage.jsx`
- 页面样式文件: `src/modules/grade-4/pages/TrainTicketFactorsPage.module.css`
- 因素选择器组件: `src/modules/grade-4/components/ui/FactorSelector.jsx`
- 参考现有ProblemIdentificationPage的样式结构和CSS Modules模式

**导入路径规范** [Source: docs/architecture/coding-standards.md]:
```javascript
// 标准导入路径
import { useAppContext } from '../../../context/AppContext';
import { useGrade4Context } from '../context/Grade4Context';
import styles from './TrainTicketFactorsPage.module.css';
// 不使用AssessmentPageLayout，直接参考ProblemIdentificationPage的结构
```

### 测试要求

**单元测试覆盖** [Source: docs/architecture/testing-standards.md]:
- [ ] 因素选择/取消选择逻辑测试
- [ ] 表单验证逻辑测试  
- [ ] 状态管理集成测试
- [ ] 操作日志记录测试

**集成测试覆盖**:
- [ ] 与Grade4Context的状态同步测试
- [ ] 与AppContext的数据收集集成测试
- [ ] 页面导航流程测试
- [ ] 数据提交格式验证测试

## 测试

### 功能测试
1. **因素展示测试**
   - 验证页面正确显示小明角色图像和对话内容
   - 验证6个因素选项正确显示：
     - 左列：小明家到出发站的路程、成都东站到舅舅家的路程、剩余车票数
     - 右列：火车车厢数、火车到达时间、火车发展历史
   - 验证页面布局符合左右分栏设计

2. **多选交互测试**
   - 测试单个因素的选择和取消选择
   - 测试多个因素的同时选择（最多6个）
   - 验证选中状态的视觉反馈效果
   - 测试选择状态在Grade4Context中的正确更新

3. **表单验证测试**
   - 测试未选择任何因素时"下一页"按钮的禁用状态
   - 测试选择至少一个因素后"下一页"按钮的启用状态
   - 验证表单提交时数据的正确收集和传递

### 测试标准
- **单元测试**: 使用Jest和React Testing Library
- **集成测试**: 验证与上下文管理器的集成
- **用户体验测试**: 验证多选交互的流畅性和直观性

### 测试文件位置
- `src/modules/grade-4/pages/__tests__/TrainTicketFactorsPage.test.jsx`
- `src/modules/grade-4/pages/__tests__/TrainTicketFactorsPage.module.css.test.js`
- `src/modules/grade-4/components/ui/__tests__/FactorSelector.test.jsx`

### 特定测试要求
- 验证至少选择一个因素时按钮启用
- 验证选择状态的视觉反馈正确性
- 验证操作日志的完整性和准确性
- 验证数据提交格式符合MarkObject规范

## 变更日志

| 日期 | 版本 | 变更描述 | 作者 |
|------|------|----------|------|
| 2025-01-27 | 1.0 | 创建故事文档，定义因素分析与多选交互需求 | Scrum Master |
| 2025-01-27 | 1.1 | 根据截图更新界面描述，替换PDF引用为详细文字描述，添加具体因素选项和布局规范 | Assistant |
| 2025-01-27 | 1.2 | 修正错误的AssessmentPageLayout引用，改为参考现有ProblemIdentificationPage的样式设计和CSS Modules模式 | Assistant |
| 2025-01-27 | 1.3 | 根据PRD要求修正文件命名：将FactorAnalysisPage改为TrainTicketFactorsPage，以更好地反映页面功能和内容 | Assistant |

## 开发代理记录

*此部分将由开发代理在实现过程中填写*

**使用的代理模型**: 待填写  
**调试日志引用**: 待填写  
**完成笔记**: 待填写  
**文件列表**: 待填写  

## QA结果

*此部分将由QA代理在审查过程中填写*

**QA代理**: 待分配  
**审查日期**: 待定  
**审查结果**: 待填写  
**发现的问题**: 待填写  
**修复建议**: 待填写