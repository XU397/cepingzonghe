# **HCI-Evaluation 棕地增强产品需求文档 (PRD)**

## **1.0 项目分析与背景 (Intro Project Analysis and Context)**

### **1.1 现有项目概述 (Existing Project Overview)**

* **分析来源**: 基于架构师Winston于2025年7月25日创建的《HCI-Evaluation 棕地增强架构文档》。  
* **当前项目状态**: 当前应用是一个基于React和Vite的单模块人机交互测评工具，其核心功能是七年级的“蒸馒头”科学探究任务。应用具备全局状态管理、自定义页面路由和用户数据上报功能。

### **1.2 增强范围定义 (Enhancement Scope Definition)**

* **增强类型**: 新功能添加 (New Feature Addition)。  
* **增强描述**: 在现有应用框架内，集成一个全新的、独立的四年级“火车购票”人机交互测评模块。同时，建立一个可扩展的多模块路由系统，以支持未来更多测评模块的加入。  
* **影响评估**: 中等影响 (Moderate Impact)。此次增强需要在不改动现有“蒸馒头”模块代码的前提下，引入新的顶层路由和模块加载机制。

### **1.3 目标与背景 (Goals and Background Context)**

* **目标**:  
  * 成功将“火车购票”模块作为第二个独立测评单元集成到应用中。  
  * 建立一个灵活的、由后端URL驱动的模块化路由框架。  
  * 确保对现有七年级模块的零干扰和零代码修改。  
  * 为未来快速集成更多测评模块奠定架构基础。  
* **背景**: 本次增强是为了响应项目扩展的需求，将应用从一个单一用途的工具，升级为一个多功能的测评平台，以满足不同年级和学科的测评要求。

### **1.4 变更日志 (Change Log)**

| 变更 | 日期 | 版本 | 描述 | 作者 |
| :---- | :---- | :---- | :---- | :---- |
| 创建文档 | 2025-07-25 | 1.0 | 初始PRD草案，定义了多模块增强的范围和目标。 | John |

## **2.0 需求 (Requirements)**

### **2.1 功能需求 (Functional Requirements)**

* **FR1**: 应用必须支持一个多模块架构，允许不同的测评模块（如“蒸馒头”和“火车购票”）独立运行。  
* **FR2**: 系统必须实现一个顶层的模块路由器 (ModuleRouter.jsx)。该路由器需能根据用户登录后API返回的 url 字段，自动将用户导航至正确的测评模块。  
* **FR3**: 必须根据《Web端人机交互测评需求文档》的详细规格，完整地实现一个全新的、功能独立的“火车购票”测评模块。  
* **FR4**: “火车购票”模块必须包含一个全局的、从40分钟开始的倒计时器。当计时结束时，系统必须能自动提交用户的作答数据。  
* **FR5**: “火车购票”模块必须强制实现一个单向、不可逆的页面流程。用户完成一页并点击“下一页”后，应禁止其通过任何方式（包括浏览器后退按钮）返回上一页。  
* **FR6**: 在“火车购票”模块的时间规划任务（题目 7 & 8）中，必须实现一个拖拽式的交互界面。该界面计算“总用时”的逻辑，必须基于任务排列的**关键路径**，而非简单的时长累加。  
* **FR7**: 在“火车购票”模块的票价计算任务（题目 10）中，必须实现一个自定义的屏幕小键盘，用于分别捕获用户的计算公式和最终结果。  
* **FR8**: 所有模块（包括新的“火车购票”模块）上报用户数据时，都必须严格遵守既有的数据标准：通过 POST 请求将 FormData 发送至 /stu/saveHcMark 端点，且 mark 字段的内容必须是符合规范的 markObject JSON字符串。

### **2.2 非功能需求 (Non-Functional Requirements)**

* **NFR1**: 在测评进行期间，应用界面必须维持一个固定的布局框架，该框架包含一个主内容区、一个左侧导航栏和一个全局计时器显示区。  
* **NFR2**: 左侧导航栏必须能够根据用户当前所处的测评逻辑阶段，动态地高亮对应的导航项。  
* **NFR3**: 所有为新模块开发的UI组件（如按钮、输入框、自定义键盘等），在设计时应考虑到未来的可复用性，以便能逐步迁移到共享组件库 src/shared/components/ 中。  
* **NFR4**: 应用必须能够优雅地处理会话过期的情况（例如，当API返回401错误时），应能引导用户重新登录，并尽可能地保留其未提交的作答进度。

### **2.3 兼容性需求 (Compatibility Requirements)**

* **CR1**: **（核心约束）** 现有的七年级“蒸馒头”模块必须保持其功能的完整性和稳定性，其内部所有文件**绝不能**进行任何代码修改。它将通过一个包装器 (wrapper.js) 的方式被集成到新的模块化系统中。  
* **CR2**: 所有与后端交互的API端点和数据格式（特别是 FormData 和 markObject 结构）必须保持与现有实现完全一致，以确保后端的向后兼容性。  
* **CR3**: 新模块系统的引入，不得对现有“蒸馒头”模块的性能（如加载速度、交互响应）或用户体验产生任何负面影响。  
* **CR4**: 必须保留并复用现有的用户认证流程及密码加密机制 (jsencrypt.ts)，仅在其基础上扩展，以支持新模块的路由选择逻辑。

## **3.0 用户界面增强目标 (User Interface Enhancement Goals)**

由于本次增强的核心是添加一个全新的功能模块，UI/UX的目标是确保新模块在视觉和交互上与应用框架和谐统一，同时实现其独特的功能需求。

### **3.1 与现有UI的集成 (Integration with Existing UI)**

* **FRM-1 (应用框架)**: 新的“火车购票”模块必须无缝地嵌入到应用的主框架中。这意味着它将共享全局的左侧导航栏、顶部计时器显示区和主内容渲染区 \[cite: Web人机交互测评需求文档\_.md\]。  
* **FRM-2 (导航栏)**: “火车购票”模块需要一个专属的、包含11个逻辑阶段的左侧导航列表。当用户在模块内进行操作时，此导航栏必须能准确高亮其当前所处的逻辑阶段 \[cite: Web人机交互测评需求文档\_.md\]。

### **3.2 新增屏幕与视图 (Modified/New Screens and Views)**

本次增强将引入一套全新的页面，以构成“火车购票”模块的完整测评流程。主要视图包括：

* **引导与情景页面** (题目 0.1 \- 3): 包括强制阅读的注意事项、情景介绍、问题识别和因素分析。  
* **出发站分析页面** (题目 4 \- 5): 包括交互式地图探索、数据计算与录入、以及基于分析的站点推荐。  
* **时间管理任务页面** (题目 6 \- 8): 包括交互教程、基于关键路径计算的拖拽式方案设计，以及方案优化。  
* **车票选择与购买页面** (题目 9 \- 10): 包括多约束条件下的信息筛选、自定义小键盘计价和最终决策。  
* **测评完成页面** (题目 11): 测评流程的终点，并触发最终数据提交。

### **3.3 UI一致性需求 (UI Consistency Requirements)**

* **FRM-3**: 新模块中所有标准的UI元素（如按钮、输入框、复选框）在视觉风格上应与现有应用保持一致，以提供统一的用户体验。  
* **FRM-4**: 新模块中所有自定义的、复杂的交互组件（如拖拽界面、自定义键盘）在设计时，应遵循应用的整体设计语言和色彩方案。

---

## **4.0 技术约束与集成需求 (Technical Constraints and Integration Requirements)**

本部分定义了在实现上述功能时必须遵守的技术边界和集成方法，这些内容直接来源于已确定的架构方案。

### **4.1 现有技术栈 (Existing Technology Stack)**

* **核心框架**: React, Vite  
* **语言**: TypeScript  
* **包管理器**: PNPM  
* **项目结构**: Turborepo Monorepo  
* **关键依赖**: jsencrypt (用于密码加密)

**约束**: 所有新开发的代码都必须与此技术栈兼容。**禁止**为新模块引入与此技术栈冲突或功能重复的核心库。

### **4.2 集成方法 (Integration Approach)**

* **数据库集成**: 无直接的数据库集成。所有数据通过既有的后端API进行交互。  
* **API集成**: 必须复用 src/services/apiService.js 中定义的现有API通信模式。所有数据提交严格遵循 POST /stu/saveHcMark 的 FormData 格式。  
* **前端集成**: 采用**混合架构**。新的顶层路由 ModuleRouter.jsx 将根据登录后API返回的 url 字段，动态加载相应的模块（七年级“蒸馒头”或四年级“火车购票”）。  
* **测试集成**: 新模块的单元测试和端到端测试，必须在现有的测试框架和流程下进行，确保新增测试不会破坏原有的测试套件。

### **4.3 代码组织与标准 (Code Organization and Standards)**

* **文件结构**: 所有新模块的代码**必须**存放在 src/modules/grade-4/ 目录下。所有可能被复用的代码（如服务、Hooks）**必须**存放在 src/shared/ 目录下。  
* **编码标准**: **严禁**修改 src/modules 和 src/shared 目录之外的任何现有文件。  
* **命名约定**: 新文件和组件的命名需遵循架构文档中定义的 PascalCase 和 camelCase 规范。

### **4.4 风险评估与缓解 (Risk Assessment and Mitigation)**

* **技术风险**: 最大的技术风险是新模块的引入可能会意外地影响到现有“蒸馒头”模块的稳定性。  
* **缓解策略**:  
  1. **代码隔离**: 通过严格遵守文件组织规范，确保新旧代码在物理上分离。  
  2. **包装器模式**: 将现有模块完整封装，作为一个“黑盒”来对待，不触及任何内部实现。  
  3. **功能开关 (Feature Flag)**: 建议在部署初期，通过一个环境变量来控制新模块路由系统的启用/禁用，以便在出现问题时可以快速回滚到原有单模块状态。

## **5.0 史诗列表 (Epic List)**

* **史诗 1: 多模块应用框架 (Multi-Module Application Framework)**  
  * **目标**: 搭建并激活支持多模块运行的核心技术框架。这是实现项目扩展能力的基石，为所有未来模块（包括“火车购票”）提供运行环境。  
* **史诗 2: “火车购票”测评模块 (“Train Ticket” Assessment Module)**  
  * **目标**: 完整地开发并集成全新的四年级“火车购票”测评模块。这个模块将作为一个独立的单元，在新的应用框架内运行，并实现其所有独特的交互功能。


## **6.0 史诗详情 (Epic Details)**

### **史诗 1: 多模块应用框架 (Multi-Module Application Framework)**

**史诗目标**: 对现有应用进行升级，搭建一个灵活、可扩展的多模块基础框架。此框架将能够根据用户身份动态加载不同的测评模块，同时必须确保现有七年级“蒸馒头”模块的绝对稳定和零代码改动。

---

#### **故事 1.1 (修订版): 基础设施搭建与安全重构 (Infrastructure Setup & Safe Refactoring)**

* **用户故事**: 作为一个开发者，我想要创建新的 modules 和 shared 目录结构，并将核心的API服务和数据上报逻辑**通过配置路径别名的方式**安全地迁移到 shared 目录中，以便为模块化开发和代码复用打下基础，**同时确保不修改任何现有模块的源代码**。  
* **验收标准**:  
  1. 项目根目录下成功创建 src/modules 和 src/shared 两个新目录。  
  2. src/shared 目录下包含 services, utils, hooks, components 等子目录。  
  3. 现有的 apiService.js 文件被移动到 src/shared/services/ 目录下。  
  4. **vite.config.js 文件被更新，添加了路径别名，使得对 src/services/apiService.js 的导入能够被正确解析到新路径。**  
  5. 创建一个新的 dataLogger.js 文件于 src/shared/services/，并封装数据上报逻辑。  
  6. 七年级模块的源代码**没有任何改动**，并且在功能上验证通过，能够正常调用API。

---

#### **故事 1.2: 模块注册与封装 (Module Registration & Wrapping)**

* **用户故事**: 作为一个开发者，我想要创建一个模块注册表 (ModuleRegistry.js) 来定义所有可用的测评模块，并为现有的七年级模块创建一个包装器 (wrapper.jsx)，以便新系统能将其作为一个标准模块来对待。  
* **验收标准**:  
  1. 成功创建 src/modules/ModuleRegistry.js 文件。  
  2. 注册表中至少定义了两个模块：grade-7 (蒸馒头) 和 grade-4 (火车购票)，并分别映射到URL路径 "/seven-grade" 和 "/four-grade"。  
  3. 成功创建 src/modules/grade-7/wrapper.jsx 文件。  
  4. 该包装器组件的功能是渲染现有的 PageRouter.jsx 组件，除此之外无任何其他逻辑。  
  5. 现有七年级模块的所有代码文件**未被**做任何修改。

---

#### **故事 1.3: 认证流程增强 (Authentication Flow Enhancement)**

* **用户故事**: 作为一个开发者，我需要修改登录逻辑，使其能够正确处理并存储从后端API返回的 url 字段，以便为后续的动态模块路由提供决策依据。  
* **验收标准**:  
  1. 当用户成功登录后，应用能从API响应中正确提取 url 字段。  
  2. 提取出的 url 值被成功存储到全局的 AppContext 状态中。  
  3. 如果API没有返回 url 字段，系统应有默认的处理方式（例如，默认导航至七年级模块）。  
  4. 现有的密码加密和用户认证逻辑保持不变。

---

#### **故事 1.4: 顶层模块路由器实现 (Top-Level Module Router Implementation)**

* **用户故事**: 作为一个开发者，我想要创建一个新的顶层路由组件 (ModuleRouter.jsx)，它将作为整个应用的入口，负责根据全局状态中的 url 值来动态加载和渲染对应的模块。  
* **验收标准**:  
  1. 成功创建 src/modules/ModuleRouter.jsx 文件。  
  2. 该组件能够从 AppContext 中读取 url 值。  
  3. 该组件能够使用 ModuleRegistry.js 来查找 url 对应的模块组件。  
  4. 当 url 为 "/seven-grade" 时，ModuleRouter 成功渲染七年级的包装器组件。  
  5. 当 url 为 "/four-grade" 时，ModuleRouter 能够尝试渲染四年级的模块组件（即使该模块此时尚不存在，也应有占位符或空组件）。

---

#### **故事 1.5: 激活新模块系统 (Activate New Module System)**

* **用户故事**: 作为一个开发者，我想要在主应用文件 (App.jsx) 中，用我们新创建的 ModuleRouter 替换掉旧的、直接调用 PageRouter 的逻辑，从而正式激活整个多模块路由系统。  
* **验收标准**:  
  1. App.jsx 文件被更新，其主要的渲染内容现在是 \<ModuleRouter /\>。  
  2. 应用启动后，能够成功完成登录流程。  
  3. 登录后，应用能够根据API返回的 url（例如 "/seven-grade"），正确地渲染出七年级“蒸馒头”模块的第一个页面。  
  4. 整个应用的现有功能（特指七年级模块）在新路由系统下运行正常，无任何功能衰退。

### **史诗 2 (修订版): “火车购票”测评模块 (基于PDF)**

**史诗目标**: 在新的多模块框架下，严格按照《【四年级数学】火车购票0401.pdf》的视觉稿和交互流程，从零开始完整开发并集成全新的四年级“火车购票”测评模块。

---

#### **故事 2.1: 模块骨架与引导页 (修订版)**

* **用户故事**: 作为一个开发者，我想要为四年级模块创建基本的目录结构，并精确实现PDF第2页的“注意事项”页面，包括其40秒强制阅读计时器。  
* **验收标准**:  
  1. src/modules/grade-4/ 目录下成功创建了 pages, components, assets 等子目录。  
  2. 成功创建并渲染了“注意事项”页面，其布局、文本内容与PDF第2页完全一致。  
  3. 页面加载时，标签为“我已阅读上述注意事项(40s)”的复选框处于禁用状态，并启动一个40秒的倒计时。  
  4. 倒计时期间，标签中的秒数动态更新。  
  5. 倒计时结束后，标签中的秒数文本消失，复选框变为可用状态。  
  6. 用户勾选复选框后，“下一页”按钮被激活。

---

#### **故事 2.2: 情景定义与问题识别 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第3页的静态“情景介绍”页面和第4页的“问题识别”页面，精确复现其视觉布局和交互逻辑。  
* **验收标准**:  
  1. “情景介绍”页面（PDF第3页）的图文内容、布局和左侧导航栏状态与PDF完全一致。  
  2. “问题识别”页面（PDF第4页）成功渲染了“假期安排讨论群”的对话框样式和右侧的提问与输入区域。  
  3. 当右侧的文本输入框内容不为空时，“下一页”按钮被激活。  
  4. 用户输入的文本被正确捕获。  
  5. 左侧导航栏能够根据页面正确高亮“1 出行方案”和“2 出行方案”。

---

#### **故事 2.3: 因素分析与多选交互 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第5页的“因素分析”页面，该页面包含一个带有自定义复选框样式的多选列表。  
* **验收标准**:  
  1. 页面布局、文本和人物插图与PDF第5页完全一致。  
  2. 成功渲染了六个选项，每个选项都带有方形选择框。  
  3. 用户可以点击选项来选中它（显示勾选标记），再次点击可以取消选择。  
  4. 当至少有一个选项被选中时，“下一页”按钮被激活。  
  5. 左侧导航栏正确高亮“3 火车购票”。

---

#### **故事 2.4: 交互式地图与数据录入 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第6页至第11页所展示的“路线探索”交互功能，允许用户点击按钮切换不同的路线详情图，并输入计算结果。  
* **验收标准**:  
  1. 页面布局与PDF第6页完全一致，包含左侧的路线按钮、中央的地图区域和右侧的路程表格。  
  2. 点击左侧的“路线1”至“路线5”按钮，中央地图区域能正确地切换并显示PDF中对应的路线详情图（如PDF第7页显示路线1详情，第8页显示路线2详情等）。  
  3. “路线1”和“路线5”的路程输入框允许自由文本输入（本迭代不强制数字校验）。  
  4. 当两个输入框均为非空时，“下一页”按钮被激活。  
  5. 左侧导航栏在整个交互过程中持续高亮“4 火车购票:出发站”。

---

#### **故事 2.5: 决策制定与信息回顾 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第12页的“站点推荐”页面，用户在此页面做出最终决策，并能通过点击页面下方的按钮回顾路线信息。  
* **验收标准**:  
  1. 页面布局、表格内容和文本与PDF第12页完全一致。  
  2. 点击页面下方的“路线1”至“路线5”按钮，能够以模态框（Modal）的形式弹出对应的路线详情图。  
  3. 当用户选择了“南充北站”或“南充站”中的一个，**并且**在“请简要说明理由”的文本框中输入了内容后，“下一页”按钮被激活。  
  4. 左侧导航栏正确高亮“5 火车购票:出发站”。

---

#### **故事 2.6: 拖拽式时间规划 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第14页的“用户方案设计”拖拽交互界面，并能根据任务的**关键路径**实时计算总用时。  
* **验收标准**:  
  1. 页面布局与PDF第14页完全一致，包含顶部的五个可拖拽任务块和下方的两个方案放置区。  
  2. 用户可以将任务块从顶部拖入任一方案区。  
  3. 在方案区内，任务块可以被排列为串行或并行。  
  4. **（核心）当任务块被放置或移动时，关联的“总用时”能够根据任务排列的关键路径实时、正确地**更新。  
  5. 当“方案一”和“方案二”两个区域都至少包含一个任务块时，“下一页”按钮被激活。  
  6. 左侧导航栏正确高亮“7 火车购票:出发时间”。  
  7. \*\*（新增）\*\*同时需要实现PDF第13页的交互教程，点击播放按钮后，能以动画形式演示拖拽操作。

---

#### **故事 2.7: 条件渲染与方案优化 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第15页和第16页的“方案评估与优化”功能，该功能能根据用户的单选结果，条件性地显示或隐藏一个用于改进方案的拖拽界面。  
* **验收标准**:  
  1. 页面初始状态与PDF第15页一致，改进方案的拖拽区域是隐藏的。  
  2. 当用户选择“是”时，“下一页”按钮直接激活。  
  3. 当用户选择“否”时，页面下方会显示如PDF第16页所示的拖拽区域，且“下一页”按钮保持禁用。  
  4. 在选择“否”后，只有当用户在**新出现的拖拽区域**中创建了一个有效的方案后，“下一页”按钮才被激活。  
  5. 左侧导航栏正确高亮“8 火车购票:出发时间”。

---

#### **故事 2.8: 车票筛选与自定义键盘 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第17页的“车票筛选”和第18页的“最终推荐与计价”页面，后者包含一个功能和布局都与PDF完全一致的自定义屏幕小键盘。  
* **验收标准**:  
  1. “车票筛选”页面（PDF第17页）成功渲染了包含5个车次信息的表格，并支持通过点击车次前的圆形图标进行多选。  
  2. “最终推荐与计价”页面（PDF第18页）成功渲染了筛选后的2个车次信息、推荐理由输入框、公式输入框、总票价输入框和自定义小键盘。  
  3. 自定义小键盘的布局、按键（包括数字、运算符、等于号和换行键）与PDF完全一致，并能将用户点击的字符正确输入到公式区域。  
  4. 当所有必填项（车次选择、理由、公式、总票价）都完成后，“下一页”按钮被激活。  
  5. 左侧导航栏根据页面正确高亮“9”和“10”。

---

#### **故事 2.9: 测评完成与数据总提交 (修订版)**

* **用户故事**: 作为一个开发者，我需要实现PDF第19页的最终“测评完成”页面，点击此页的“完成”按钮将触发整个模块所有作答数据的汇总和提交。  
* **验收标准**:  
  1. “测评完成”页面的图文和按钮与PDF第19页完全一致。  
  2. 点击“完成”按钮后，全局计时器停止。  
  3. 应用能够将“火车购票”模块会话期间收集到的所有数据，整合成一个符合规范的JSON对象。  
  4. 通过调用共享的 dataLogger 服务，将该数据对象成功提交到后端。  
  5. 左侧导航栏正确高亮“11 火车购票”。
