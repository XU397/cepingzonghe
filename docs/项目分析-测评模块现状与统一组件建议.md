项目分析：模块规则对齐与统一组件建议

概述
- 目标：梳理当前三类测评模块（四年级火车购票、七年级蒸馒头、七年级追踪蜂蜜黏度）的实现与既定统一规则之间的差异，给出改进建议，并评估可复用的“统一导航”“统一计时器”“统一页面框架”等通用组件的可行性。
- 方法：阅读模块代码、上下文与路由、计时与持久化逻辑、数据提交链路，结合登录/跳转机制进行对照分析。

统一规则回顾（需求基线）
- 刷新后停留在当前页面，且计时器不中断、不重置（延续剩余时间）。
- 登录后根据后端返回的模块 URL 和 pageNum，直接跳转至对应页面。
- 每页点击“下一页”时向后端提交当前页数据（含操作/答案/起止时间）。
- 倒计时结束后，如未完成当前子模块题目，自动跳转到该子模块的最后一页（总结/完成）。
- 如果当前页记录丢失或提交失败（尤其是会话过期），回到登录页；重新登录后按后端记录恢复到对应页面。

项目与架构总览
- 模块注册与路由
  - 模块注册：`src/modules/ModuleRegistry.js:1` 统一注册 `/seven-grade`（七年级蒸馒头）、`/four-grade`（四年级火车票）、`/grade-7-tracking`（七年级追踪蜂蜜黏度）。
  - 动态加载与页面恢复：`src/ModuleRouter.jsx:1` 根据后端返回 `url` 查模块、基于模块的 `getInitialPage(pageNum)` 计算初始页面。
- 应用上下文与两套“引擎”
  - 传统 7 年级“蒸馒头”模块使用全局 `AppContext`（计时、问卷、数据提交、导航、持久化）。参考 `src/context/AppContext.jsx:1`。
  - 7 年级“追踪蜂蜜黏度”模块使用独立的 `TrackingProvider`（会话、计时器、导航、提交与本地持久化）。参考 `src/modules/grade-7-tracking/context/TrackingProvider.jsx:1`。
  - 4 年级模块使用 `Grade4Context` 独立管理（页面路由、全局计时 UI、数据提交）。参考 `src/modules/grade-4/context/Grade4Context.jsx:1`。

模块逐项对照分析

一、七年级（蒸馒头）
- 刷新与计时持久化
  - `AppContext` 在挂载时恢复 `taskStartTime/remainingTime/currentPageId` 等（localStorage），到点置 `isTimeUp` 并保持剩余时间连贯；参考 `src/context/AppContext.jsx:1166` 一段的“恢复任务状态”逻辑与定时器 `setInterval` 更新。
  - 问卷计时同样有独立持久化键与恢复流程（`isQuestionnaireStarted/RemainingTime/...`）。
- 登录直达对应页面
  - 登录成功在 `handleLoginSuccess` 写入 `moduleUrl/pageNum`；`ModuleRouter` 用 `url` 选模块、用 `getInitialPage(pageNum)` 计算起始页。`src/ModuleRouter.jsx:1`；页码映射见 `src/utils/pageMappings.js:1` 中的 `getTargetPageIdFromPageNum`。
- 下一页自动提交
  - 统一通过 `navigateToPage(nextPageId)` 自动追加 `page_exit` 操作并调用 `submitPageDataWithInfo`；参考 `src/context/AppContext.jsx:1105`。
- 倒计时到期自动跳转
  - 应用层 effect 监控 `isTimeUp`，自动导航到任务完成页 `Page_19_Task_Completion`；参考 `src/App.jsx:157`。
- 提交失败/会话过期处理
  - `submitPageDataWithInfo` 捕获 401/会话过期，调用 `handleSessionExpired` 完整清理并跳回登录页；参考 `src/context/AppContext.jsx:387`。

结论（与规则对齐度）
- 强一致：刷新恢复、登录直达、下一页提交、会话过期回登录 均已覆盖；倒计时自动跳转也符合“跳到总结/完成页”的意图。

二、七年级追踪（蜂蜜黏度）
- 刷新与计时持久化
  - `TrackingProvider` 使用 `tracking_session` 等键完整持久化 `currentPage/navigationMode/计时器状态`，启动时先做账号比对防止串号污染，恢复后继续倒计时；参考 `src/modules/grade-7-tracking/context/TrackingProvider.jsx:110`、`:213`。
- 登录直达对应页面
  - 模块 `getInitialPage(pageNum)` 与 `getPageId`/`getRelativePageInfo` 映射；页面映射与导航模式在 `src/modules/grade-7-tracking/config.js:1`。
- 下一页自动提交
  - 页面侧统一调用 `useDataLogger().submitPageData(mark)` 并成功后 `navigateToPage`。例如 `Page10_Experiment.jsx:136` 先 `buildMarkObject` 再 `submitPageData` 成功后跳转。
- 倒计时到期自动跳转
  - 计时器监听 effect：实验阶段 40 分钟到期跳 `13`（总结），问卷阶段 10 分钟到期跳 `22`（问卷完成）；参考 `src/modules/grade-7-tracking/context/TrackingProvider.jsx:868` 与 `:907` 两处 effect。
- 提交失败/会话过期处理
  - `useDataLogger` 对 401 做“清空本地 + reload 到登录页”，非 401 带指数退避重试；参考 `src/modules/grade-7-tracking/hooks/useDataLogger.js:1`。

结论（与规则对齐度）
- 强一致：刷新恢复、登录直达、下一页提交、倒计时自动跳转、401 统一回登录，均实现良好且鲁棒（含重试、账号比对、防串号）。

三、四年级（火车购票）
- 刷新与计时持久化
  - 页面位置：有，`navigateToPage` 同步 `pageNum` 到 localStorage，刷新可回当前页。
  - 40 分钟计时：`GlobalTimer` 来自 `Grade4Context` 的内存状态（`globalTimer.startTime/isActive/remainingTime`），未见持久化与跨刷新恢复；参考 `src/modules/grade-4/components/GlobalTimer.jsx:1` 与上下文 `src/modules/grade-4/context/Grade4Context.jsx:1`。与统一规则“刷新计时不重置”存在差距。
- 登录直达对应页面
  - 模块 `getInitialPage(pageNum)` 将数字映射为模块自有 `pageId`；参考 `src/modules/grade-4/index.jsx:120`。
- 下一页自动提交
  - `navigateToPage` 在跳转前自动拼接 `page_exit` 并调用 `submitPageDataInternal` 提交（使用 shared dataLogger → `submitPageMarkData`）；参考 `src/modules/grade-4/context/Grade4Context.jsx:555`。
- 倒计时到期自动跳转
  - 未实现自动“到期跳最后页”。`completeGlobalTimer` 仅在完成页按钮触发；参考 `src/modules/grade-4/pages/12-TaskCompletionPage.jsx:11`。与统一规则存在差距。
- 提交失败/会话过期处理
  - `submitPageDataInternal` 检测“session 过期”仅提示 `alert('重新登录')` 并返回 false，未统一触发登出/跳登录；且 `navigateToPage` 在生产会弹窗询问“是否继续导航”，并非强制回登录后恢复。与统一规则差距较大。

结论（与规则对齐度）
- 局部满足：页面位置恢复、下一页自动提交已对齐；计时器跨刷新、到期自动跳转、失败统一回登录三项需要补齐。

横向差异与潜在问题
- 计时器与显示方式分裂
  - App 全局计时（7 年级蒸馒头）、模块内计时（7 年级追踪）、模块内内存计时（4 年级），实现与持久化策略不统一，UI 警示阈值也存在差异。
- 数据提交链路不统一
  - AppContext 的 `submitPageDataWithInfo` 与 追踪模块的 `useDataLogger/submitPageMarkData` 并存；4 年级复用 shared dataLogger。但失败策略、重试与 401 处理路径不一致。
- 本地持久化键名分散
  - 如 `pageNum`/`hci-pageNum` 与 `tracking_*`，跨模块并行时容易产生混淆与清理不彻底。
- 模块路由参数潜在错配
  - `App.jsx` 中以 `<ModuleRouter globalContext={...} authInfo={...} />` 调用，而 `src/ModuleRouter.jsx` 仅接收 `userContext`；建议统一 `userContext` 结构并在调用端修正，避免后续依赖（如 `userContext.submitPageDataWithInfo`）无效。

可复用的通用能力与组件建议

一、统一计时器（引擎 + 展示）
- 引擎（TimerService/TimerProvider）
  - 能力：
    - 任务计时与问卷计时双通道。
    - 标准持久化键（如 `timer.taskStartAt/taskRemaining` 与 `timer.qStartAt/qRemaining`），统一离线时间抵扣算法，支持账号切换校验。
    - 生命周期：start/pause/resume/reset，超时回调（emit event）。
    - 统一超时策略：按导航模式自动跳至“总结/问卷完成”，并发保护（只触发一次）。
  - 复用方式：
    - 7 年级蒸馒头：替换/适配 AppContext 内部计时实现，保留其上下文 API 兼容层。
    - 7 年级追踪：复用引擎，保留现有 localStorage 键向后兼容映射一段时间。
    - 4 年级：接入引擎，补齐跨刷新恢复与超时自动跳转。
- 展示组件（TimerDisplay/QuestionnaireTimerDisplay/WarningBadge）
  - Props：`remainingSeconds`、`variant`（task/questionnaire/compact）、`warningThreshold`、`criticalThreshold`。
  - UI 一致性：统一样式变量与视觉（现存三处 UI 合并，保留轻量主题差异）。

二、统一导航组件（LeftStepperNav）
- 能力：
  - 两种模式：`experiment` 与 `questionnaire`（题点数不同、连接线样式不同）。
  - 只读数字步进（默认不可点击），可选支持“可点击预览/禁止跳转”开关。
  - Props：`currentStep`、`totalSteps`、`mode`、`compact`。
- 替换点：
  - 替换 `src/components/common/StepNavigation.jsx`、`src/modules/grade-4/components/LeftNavigation.jsx`、`grade-7-tracking` 的内联导航，统一到 shared 组件。

三、统一页面框架（AssessmentPageFrame）
- 目标：拼装“导航（可控）+ 顶部计时 + 主体内容 + 底部导航/下一页按钮 + 错误托盘”且内置标准页面事件。
- 能力：
  - `onBeforeNext`/`onSubmit`/`onAfterNext`/`onError` 钩子。
  - 自动追加 `page_exit` 操作并提交，失败时统一 401 处理与回登录，其它错误可配置“允许继续/强制留在本页”。
  - 与 TimerService 联动，自动浮层提醒、自动跳转最后页的回调出入口。
  - Props：`navigationMode`（hidden/experiment/questionnaire）、`showTimer`、`nextEnabled`、`nextText` 等。
- 替换点：
  - `grade-7-tracking/components/layout/PageLayout.jsx`、`grade-4/components/layout/AssessmentPageLayout.jsx` 与 App 层“模块模式”的页面布局统一到该组件。

四、统一数据提交与错误处理（usePageSubmission）
- 能力：
  - 统一构建 `mark`（沿用 `src/shared/services/dataLogger.js` 的 `createMarkObject`）。
  - 统一提交 `submitPageMarkData`；指数退避重试；401 → 统一回登录（调用 `handleSessionExpired`）。
  - 提供“仅校验不提交”模式用于开发。
  - 出口：`submit(mark, {force?: boolean}) → Promise<boolean>`。
- 集成点：
  - 7 年级蒸馒头：`navigateToPage` 内改用统一 Hook；
  - 7 年级追踪：替换现有 `useDataLogger` 或让其包到 shared Hook；
  - 4 年级：`submitPageDataInternal` 改为调用统一 Hook，并将 session 过期处理与回登录流程一致化。

五、统一持久化键与清理策略
- 约定 namespace：
  - `core.auth/*`、`core.page/*`、`core.timer/*`、`module.<id>/*`，避免键名冲突。
  - 迁移期保留旧键读取 + 新键写入，最终只保持新键。
- 统一清理：
  - `handleSessionExpired`/`handleLogout` 调用统一清理表（含 `tracking_*`、旧键别名与全局计时键），确保回登录后零污染。

模块级差异与改造建议（逐模块）

四年级（高优先）
- 计时器持久化与恢复：接入统一计时引擎，刷新不重置，恢复剩余时间；支持 40 秒注意事项 + 40 分钟主任务的双计时用例。
- 到期自动跳转：到时自动导航到“完成页”，并记录 `timer_complete` 与 `auto_jump` 操作。
- 失败统一回登录：`submitPageDataInternal` 的会话过期改为调用统一 `handleSessionExpired`；其它提交失败默认阻止导航（可配置开发模式下放行）。

七年级蒸馒头（中优先）
- 统一提交 Hook：`navigateToPage` 切换到 shared `usePageSubmission`，减少与追踪模块差异。
- 统一计时展示：UI 与阈值提示统一到 `TimerDisplay`，保留现有样式变量主题化。
 - 修正 ModuleRouter 调用参数为 `userContext`（若当前为 `globalContext/authInfo`），统一 `userContext` 结构包含提交方法与必要状态。

七年级追踪（中优先）
- 计时引擎对齐：现逻辑完善，可包在统一引擎上，仅做接口适配，保留现有本地化键的兼容读写一段时间。
- 数据提交流程：将 `useDataLogger` 的 401 处理直接复用至 shared Hook，避免重复维护。
- 布局与导航：将内置左侧导航切换为 shared LeftStepperNav，减少样式与行为分歧。

实施与风险控制
- 建议先做“文档 → OpenSpec 变更提案 → 小步落地”：
  1) 起草变更提案：统一计时器、统一提交 Hook、统一导航与页面框架（3 个 change-id）。
  2) 分支验证：先在四年级接入统一计时与提交；回归测试刷新、超时、失败回登录；
  3) 逐步推广到七年级蒸馒头与七年级追踪，期间保留兼容层与开关。
- 风险点：
  - 清理本地键名时需谨慎，避免误清其他模块关键状态；
  - 计时器“只触发一次”的并发保护需在全局与模块内同时考虑（避免双重跳转/重复提交）。

可行性结论与收益
- 可行性：高。现有三类实现都已具备标准化的“页码映射、操作/答案收集、提交 API、计时器与持久化”骨架，差异主要在“谁来管（全局 vs 模块）”与“失败/超时策略是否一致”。通过统一的服务（Timer/Submission）与壳（PageFrame/Nav）可最小侵入落地。
- 收益：
  - 研发一致性：新增模块直接套共用壳 + Hook，减少重复劳动与回归范围；
  - 可靠性：401 与失败流统一，避免某模块“继续导航但未登录”的不一致；
  - 可观测性：统一日志字段与埋点（如 `page_exit`、`auto_jump`），便于后端分析。

附：关键文件索引（用于快速定位）
- 七年级追踪配置与页面映射：`src/modules/grade-7-tracking/config.js:1`
- 七年级追踪上下文（计时/导航/提交/持久化）：`src/modules/grade-7-tracking/context/TrackingProvider.jsx:1`
- 七年级追踪数据提交 Hook（401 统一回登录）：`src/modules/grade-7-tracking/hooks/useDataLogger.js:1`
- 传统 7 年级全局上下文（计时/问卷/提交/导航）：`src/context/AppContext.jsx:1`
- 7 年级页码映射与恢复：`src/utils/pageMappings.js:1`
- 四年级模块上下文与全局计时 UI：`src/modules/grade-4/context/Grade4Context.jsx:1`、`src/modules/grade-4/components/GlobalTimer.jsx:1`
- 模块注册与模块路由：`src/modules/ModuleRegistry.js:1`、`src/ModuleRouter.jsx:1`

后续工作（OpenSpec）
- 本文为分析文档，不直接改代码。若接受上述方向，建议按 OpenSpec 流程创建 3 个变更提案：
  - change-id: add-unified-timer-service（统一计时器引擎 + 展示）
  - change-id: add-unified-page-submission-hook（统一数据提交与错误处理）
  - change-id: add-unified-assessment-frame（统一页面框架与导航）
- 每个提案内列出 ADDED/MODIFIED Requirements 与典型 Scenario，再据此实施。


**拼装式测评方案（组合多子模块为一体）**
- 可行性
  - 可实现。现有系统已具备“按 URL 映射模块、模块自带计时与导航、分页提交与恢复”的基础能力（参考 `src/modules/ModuleRegistry.js:1` 与 `src/ModuleRouter.jsx:1`）。在不重写现有模块的前提下，通过“子模块接口 + 流编排器（Flow Orchestrator）+ 过渡页”即可实现可拼装的完整测评流。

- 目标能力
  - 子模块化拆分：把现有内容按类型拆为“4年级交互、4年级问卷、7年级交互、7年级问卷、7年级追踪交互1、7年级追踪问卷1”等“子模块”（实际以包装器形式提供，不强制物理拆分）。
  - 测评流拼接：通过“拼接器”选取子模块序列（例如：新交互A → 7年级交互 → 4年级问卷），生成新的测评流，对应唯一 URL（例如 `/flow/g7a-mix-001`）。
  - 过渡页面：每个子模块结束展示过渡页，点击继续进入下一个子模块；支持自动跳转（完成或超时）。
  - 计时与导航：每个子模块保有自身计时器与导航风格（交互/问卷），互不干扰但可统一样式与行为。
  - 恢复与登录：后端给账号配置该“流”的 URL 与进度（流内的子模块索引 + 子模块内页码），登录后精确恢复。
  - 数据存储：按“模块 + 模块页面”的结构记录（建议 pageNumber 支持 `M{序号}:{页码}` 或 `mod:{page}` 形式），与批次和学生 ID 关联。

- 核心设计
  - 子模块接口（Composable Module Interface，CMI）
    - 最小要求：`moduleId`、`displayName`、`ModuleComponent`、`getInitialPage(pageNumInModule)`、`onInitialize/onDestroy`、`getFeatures()`。
    - 可选：`getStateSnapshot()`（调试/诊断）、`onComplete()`（子模块边界事件）。
    - 现有模块可通过“包装器”快速适配：
      - 7年级交互：沿用 `Grade7Module`（参考 `src/modules/grade-7/index.jsx:1`）。
      - 7年级追踪：沿用 `Grade7TrackingModule_Definition`（参考 `src/modules/grade-7-tracking/index.jsx:1`）。
      - 4年级交互/问卷：以 `Grade4Module_Definition` 为基础（参考 `src/modules/grade-4/index.jsx:1`），拆分问卷部分时通过配置开关或派生包装器实现。
  - 流定义（Flow Definition）
    - 以配置（JSON/JS）声明流：`flowId`、`url`、`steps: [{ moduleId, variant?, overrides?, transitionPage? }]`。
    - 进度标识：`stepIndex` + `modulePageNum` 或 `modulePageId`；支持 `pageNumber` 复合编码如 `2.11`（第2模块第11页）。
    - 计时：每步限定自身 `timer`（如 40 分钟交互或 10 分钟问卷），默认取子模块配置，可由流覆盖。
  - 流编排器（Flow Orchestrator）
    - 作为“流模块（FlowModule）”注册到 `ModuleRegistry`，暴露唯一 `url`（如 `/flow/g7a-mix-001`）。
    - 负责：
      - 根据 `stepIndex` 加载相应子模块定义（从 `ModuleRegistry` 查找或动态 import）。
      - 把“流级 userContext”（账号、批次、进度）下传为子模块的 `userContext`，并注入统一提交与会话处理方法。
      - 维护跨子模块的进度恢复、持久化键（建议 `flow.<flowId>.*` 命名）。
      - 渲染“过渡页面”，并在子模块 `onComplete` 或计时器到期时自动切换到下一步。
  - 统一计时与提交
    - 计时：沿用前文的“统一计时器引擎”，每个子模块内独立启停；刷新恢复由引擎处理；到期触发“子模块内最后页/总结页”，之后进入“过渡页→下一模块”。
    - 提交：统一使用 shared `usePageSubmission`（对齐 `src/shared/services/dataLogger.js:1` 与 追踪模块 `useDataLogger` 的 401 处理），所有子模块的“下一页/完成/过渡前”走同一提交流程。
  - URL 与注册
    - 为每条拼装流注册一个 `FlowModuleDefinition`（`moduleId: flow-<id>`, `url: /flow/<id>`）。
    - 后端账号配置只需返回该 URL 与进度标识（`stepIndex`+`modulePageNum` 或复合 `pageNum` 字符串）。

- 恢复与登录流程
  - 后端返回：`url: '/flow/<id>'`，以及 `progress`（推荐结构化：`{ stepIndex: number, modulePageNum: string }`；兼容复合 `pageNum: '2.11'`）。
  - `ModuleRouter` 查到 `FlowModule` 后，交由编排器定位 step 与子模块页码，调用该子模块的 `getInitialPage` 进行页面恢复。
  - 刷新：编排器持久化 `flow.<id>.stepIndex` 与 `flow.<id>.modulePageNum`，子模块内部再持久化自身细节状态（如追踪模块的 `tracking_*`）。

- 数据存储建议
  - `mark.pageNumber`：采用复合编码（如 `M2:11` 或 `2.11`）；`mark.pageDesc` 追加 `flowId/moduleAlias` 方便查询与人工审阅。
  - 账号/批次维度：保持现有 `batchCode/examNo`；可在 `operationList` 第一条加一条 `flow_context` 记录，写入 `flowId`、`moduleId`、`stepIndex`（无后端 schema 变更的前提下，增强可追溯性）。
  - 会话过期：统一按 `handleSessionExpired` 路径回登录（参考 `src/context/AppContext.jsx:387`），避免“继续导航但未登录”的不一致。

- 过渡页面（TransitionPage）
  - 功能：展示“已完成 {模块名}”，显示下一模块信息与提示按钮；在自动模式下 N 秒后自动开始下一模块。
  - 行为：确保当前子模块的最后一次提交已完成；调用编排器 `advanceTo(stepIndex+1)`，并切换至下一个子模块 `ModuleComponent`。

- 后端配合点
  - URL：为新拼装流建立唯一 URL 与路由；账号登录返回该 URL。
  - 进度：支持 `progress` 结构化字段（推荐）或复合 `pageNum` 字符串；若仍只回 `pageNum`，约定格式并在前端解析。
  - 报表：接受 `pageNumber` 为字符串复合编码；或保留纯数字 `pageNumber`，把 `flowId/moduleId/stepIndex/modulePageNum` 追加到 `pageDesc`，由后端解析。

- 方案落地步骤
  - 1) 规范子模块接口（CMI）并提供包装器，保持现有模块零改动或最小改动即可接入。
  - 2) 实现 Flow Orchestrator（流编排模块），引入 `flowId/url/steps` 配置解析与进度持久化。
  - 3) 引入统一计时器引擎与统一提交 Hook，先接入 4 年级以补齐“刷新不重置、超时自动跳转、401 统一回登录”。
  - 4) 实现通用 TransitionPage；在追踪与 7 年级模块中验证“自动完成→过渡→下一模块”的链路。
  - 5) 在 `ModuleRegistry` 为每条拼装流注册 `FlowModuleDefinition`，并准备一个“开发者拼装器”（可选）用于本地生成 flow 配置。
  - 6) 与后端对齐进度字段与复合页码编码，完成联调。

- 风险与边界
  - 现有模块上下文不统一（AppContext、Grade4Context、TrackingProvider）；通过包装器与统一计时/提交层可屏蔽差异，但需小心“重复计时/重复跳转”并发情况，建议以“并发保护位 + 单点触发”处理。
  - 本地键名冲突与清理：采用命名空间 `flow.<id>`、`module.<id>`，清理时统一在 `handleLogout/handleSessionExpired` 执行。
  - 登录/恢复协议：若仅有数字 `pageNum` 难以表达“流内位置”，需后端升级协议或前端采用可解析的复合编码并在 `FlowModule` 中实现自定义解析。

- 结论
  - 拼装模式可行，建议以“子模块接口 + 流编排器 + 统一计时与提交 + 过渡页 + 复合页码编码”的方案落地。与前文“统一组件”建设互补，能显著提升复用率与新测评搭建效率。


**拼装配置与操作流程（Flow 管理）**
- 谁来定义与存储拼装流（Flow）
  - 推荐：后端持久化为权威数据源（数据库/配置中心）。原因：
    - 需要与“批次/账号”建立可靠映射；
    - 便于审计、版本化、回滚与回溯；
    - 登录时后端根据账号直接返回对应 Flow 的 `url` 与进度。
  - 前端页面仅作为“管理界面”（Admin UI），负责编辑与提交 Flow 配置到后端，不作为存储源。

- 是否需要一个配置页面（在哪里）
  - 需要。建议提供“拼装器（Composer）”管理页：
    - 放在前端（受保护的 Admin 路由）或单独的后台管理端；
    - 管理页通过 API 读/写 Flow 定义与批次映射；
    - 支持“草稿/发布”状态与版本号。
  - 开发期可提供“开发者拼装器（Dev Composer）”，用于快速拼装并导出 JSON，再由管理员导入/发布。

- 典型使用流程
  1) 管理员在“拼装器”界面选择子模块序列（如：交互A → 7年级交互 → 4年级问卷），可设置过渡页与计时覆盖；
  2) 保存并发布，系统生成 `flowId` 与唯一 `url`（形如：`/flow/<flowId>`）；
  3) 在“批次管理”中将 `flowId` 绑定到一个或多个批次/账号范围；
  4) 考生登录后端，后端按账号返回该 `url` 与进度（`stepIndex` + 子模块页码），前端 `ModuleRouter` 进入 Flow 模块；
  5) 运行中：流编排器负责子模块切换、过渡页展示、到期自动跳转与进度持久化；
  6) 支持预览：管理员可通过“预览模式”跳入 Flow 验证配置正确性（不写正式数据或写入沙箱批次）。

- 流定义（数据模型建议）
  - FlowDefinition（服务端存储，JSON）：
    ```json
    {
      "flowId": "g7a-mix-001",
      "name": "交互A+7年级交互+4年级问卷",
      "url": "/flow/g7a-mix-001",
      "version": 1,
      "status": "published",
      "steps": [
        {
          "moduleId": "interactive-A",
          "variant": "default",
          "overrides": { "timers": { "task": 2400 } },
          "transitionPage": { "title": "交互A完成", "autoNextSeconds": 3 }
        },
        {
          "moduleId": "grade-7",
          "variant": "experiment-only",
          "overrides": {},
          "transitionPage": { "title": "进入7年级交互", "autoNextSeconds": 2 }
        },
        {
          "moduleId": "grade-4",
          "variant": "questionnaire-only",
          "overrides": { "timers": { "questionnaire": 600 } },
          "transitionPage": { "title": "进入4年级问卷", "autoNextSeconds": 2 }
        }
      ]
    }
    ```
  - 进度标识（服务端记录到账号/批次）：
    ```json
    {
      "flowId": "g7a-mix-001",
      "stepIndex": 1,
      "modulePageNum": "13"  // 子模块内页码（或 pageId）
    }
    ```

- API 契约建议（后端）
  - Flow 管理
    - `POST /api/flows` 创建 Flow，返回 `{ flowId, url }`
    - `GET /api/flows/{flowId}` 查询 Flow 定义
    - `POST /api/flows/{flowId}/publish` 发布 Flow（写入 `version/status`）
  - 批次绑定
    - `POST /api/batches/{batchCode}/assign-flow` 绑定 `{ flowId }`
    - `GET /api/batches/{batchCode}/flow` 查询已绑定 Flow
  - 登录返回（不改现有格式，可扩展）：
    - 在现有登录响应中返回 `url: "/flow/<flowId>"` 与 `progress`（结构化 `stepIndex/modulePageNum` 或兼容复合 `pageNum` 字符串）。

- 前端流编排器运行时逻辑
  - `ModuleRouter` 接收 `url` 为 `/flow/<flowId>` → 加载 FlowModule；
  - FlowModule 通过 API 拉取 `FlowDefinition` 与 `progress`（或直接由登录响应携带），确定 `stepIndex` 与子模块起始页；
  - 动态加载 `moduleId` 对应的子模块定义（从 `ModuleRegistry` 获取）；
  - 子模块渲染时注入统一提交/会话处理/计时服务；
  - 子模块完成或到期 → 进入 `TransitionPage`（可自动），随后 `stepIndex + 1`；
  - 持久化：前端写 `flow.<flowId>.stepIndex/modulePageNum`；后端在每次提交或心跳时可同步进度。

- 与批次/数据提交的对应关系
  - 账号-批次-Flow 三者的绑定由后端维护；
  - 前端提交 `MarkObject` 不变，但建议：
    - `pageNumber` 支持复合编码（如 `M2:11`）；
    - `pageDesc` 附加 `flowId/moduleId/stepIndex`（便于检索）；
    - 在 `operationList` 追加一次性 `flow_context` 记录（页面首次进入时），包含 `flowId/moduleId/stepIndex`。

- 风险与边界
  - 流变更影响进行中的考生：建议 Flow 发布后“冻结”，若需调整则新增版本 `flowId@v2` 并只影响新登录的账号；
  - 子模块内部计时/导航差异：由统一计时与提交层屏蔽；
  - 账号切换与恢复：严格校验考号一致性，清理不匹配命名空间键（`flow.*`/`module.*`）。

- 建议的实现顺序
  1) 完成“子模块接口（CMI）”与“统一计时/提交/页面框架”；
  2) 实现 FlowModule 与编排器；
  3) 提供最小可用的 Admin 拼装器页面（前端），后端落表并暴露 API；
  4) 对接批次绑定、登录返回、恢复与过渡页；
  5) 联调与灰度，完善版本与冻结策略。
