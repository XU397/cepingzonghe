# 七年级追踪测评（蜂蜜黏度）与七年级蒸馒头：数据提交规范对齐分析与修复方案

本文对比了两个测评模块的页面数据提交方式（载荷结构、收集流程、调用路径），定位“追踪测评 answerList 为空”的主要成因，给出与“蒸馒头”一致的标准化方案与落地修改建议。

## 结论概览

- 两个模块的后端载荷结构一致，关键差异在于“答案收集时机与提交路径”。
- 追踪测评部分页面在点击“下一页”时先调用 collectAnswer 再立即提交，因 React 状态异步导致 buildMarkObject 读取到的 answers 仍为空，answerList 提交为空数组。
- 建议对齐“蒸馒头”做法：在页面内同步构建答案列表，并以参数形式传入提交（或直接传 customData），避免依赖异步状态；统一提交入口与规范化流程。

---

## 提交结构（两模块一致）

- 顶层 FormData：`batchCode`、`examNo`、`mark`
- `mark` 结构：`pageNumber`、`pageDesc`、`operationList[]`、`answerList[]`、`beginTime`、`endTime`、`imgList`
- 规范化：时间统一 `YYYY-MM-DD HH:mm:ss`、所有值字符串化、`code` 自增（1 起）

参考：
- 追踪测评标准化实现：`src/shared/services/dataLogger.js:19`
- 追踪测评提交入口（Hook）：`src/modules/grade-7-tracking/hooks/useDataLogger.js:1`
- 追踪测评提交规范说明：`src/modules/grade-7-tracking/DATA_SUBMISSION_STANDARD.md:1`

---

## 七年级蒸馒头（现状）

提交路径与职责拆分：
- 页面侧：在“下一页”时同步构造 `answerList`，直接传入提交，不依赖异步状态。
- 提交侧：`AppContext.submitPageDataWithInfo()` 组装 `mark` 并调 `apiService.submitPageMarkData()`。

要点示例（P18 方案选择页）：
- 同步构造答案：`src/pages/Page_18_Solution_Selection.jsx:260`
- 自定义数据提交：`src/pages/Page_18_Solution_Selection.jsx:286`
- AppContext 组装与提交：`src/context/AppContext.jsx:417`、`src/context/AppContext.jsx:473`

特性：
- 页面立即生成 `answerList` 后提交，避免异步状态竞争。
- `preparePageSubmissionData` 也可走统一路径，保持 answerList 一致性。

---

## 七年级追踪测评（现状）

两种提交方式并存：
- A. 通过 `TrackingProvider.submitPageData()` → 委托到外部 `userContext.submitPageDataWithInfo()`（即 AppContext）
  - 位置：`src/modules/grade-7-tracking/context/TrackingProvider.jsx:706`
- B. 通过 `useDataLogger.submitPageData()` 直接构造 payload 并提交（内部复用 shared 标准化）
  - 位置：`src/modules/grade-7-tracking/hooks/useDataLogger.js:41`

答案收集与 mark 构建：
- 页面调用 `collectAnswer()` 将答案放入 Provider 内部状态 `answers`
- 调用 `buildMarkObject(page, desc)` 将 `answers` 转为 `answerList`
- 位置：
  - `collectAnswer`：`src/modules/grade-7-tracking/context/TrackingProvider.jsx:522`
  - `buildMarkObject`：`src/modules/grade-7-tracking/context/TrackingProvider.jsx:546`

问题根因：
- 多个页面（含 12 页“方案选择”）在同一点击里“先 collectAnswer 再立刻提交”，但 `answers` 更新是异步的；`buildMarkObject` 读取旧值，导致 `answerList` 为空。
- 示例（修复前）：“方案选择”页：`src/modules/grade-7-tracking/pages/Page14_Solution.jsx:106` 附近，先 `collectAnswer` 再 `buildMarkObject` 并提交。

---

## 差异与影响

- 答案生成时机：
  - 蒸馒头：在页面函数内同步构建，保证提交时 answerList 已就绪。
  - 追踪测评：依赖 Provider 内部状态，setState 异步导致竞态，answerList 易空。

- 提交路径：
  - 蒸馒头：统一走 AppContext 的 `submitPageDataWithInfo`，并支持传入 `customData`。
  - 追踪测评：页面有时用 Hook 直提、有时走 Provider → 外部 AppContext，路径不统一。

---

## 修复方案（对齐蒸馒头）

目标：避免异步状态竞态、统一答案构造与提交路径、确保 answerList 在应有页面非空。

1) 页面内同步构造 answerList
- 在“下一页”处理函数中直接构造 `answerList`，不要依赖 `collectAnswer` 后的内部 state。
- 将 `answerList` 以参数形式传给 `buildMarkObject(page, desc, { answerList })`。
- 或者直接传 `customData` 给提交函数（对齐蒸馒头）。

2) 统一提交路径（推荐其一）
- 方案 A（最小改动）：保留 `useDataLogger`，但所有页面都传 `answerList` 给 `buildMarkObject` 再提交。
- 方案 B（完全对齐蒸馒头）：调用 `userContext.submitPageDataWithInfo(batchCode, examNo, customData)` 提交，`customData` 内包含页面的 `operationList` 与同步构造的 `answerList`。

3) 事件与时间规范保持一致
- 事件映射（如 click/input/radio_select 等）已在 `buildMarkObject` 处理：`src/modules/grade-7-tracking/context/TrackingProvider.jsx:575`
- 时间/字符串化与 code 自动补齐由 `shared/dataLogger.createMarkObject()` 保障：`src/shared/services/dataLogger.js:45`

4) 引导规范（页面分类）
- 纯指引/过渡页（如 page 1、过渡页）：answerList 允许为空；保证 `operationList` 有 page_enter 与关键点击。
- 含题面/文本/选择的功能页：answerList 必须包含最终答案。

---

## 已修复：P12（方案选择）空 answerList

页面：`src/modules/grade-7-tracking/pages/Page14_Solution.jsx`

修复点：同步构造答案并传入 `buildMarkObject(..., { answerList })`，不再依赖 `collectAnswer` 的异步状态。

变更摘要：
- 新增本地 `answerList`：`src/modules/grade-7-tracking/pages/Page14_Solution.jsx:120`
- 传入 `buildMarkObject` 的第三参：`src/modules/grade-7-tracking/pages/Page14_Solution.jsx:132`

效果：提交时 answerList 含
- `solution_combinations`: 所有有效温度×含水量组合
- `solution_reason`: 学生填写理由
- `best_solutions`: 学生标记的最佳方案（如果有）

---

## 建议的后续对齐清单

优先级高（同类问题风险页）：
- 实验分析问答页：
  - `src/modules/grade-7-tracking/pages/Page11_Analysis1.jsx:112`
  - `src/modules/grade-7-tracking/pages/Page12_Analysis2.jsx:111`
  - `src/modules/grade-7-tracking/pages/Page13_Analysis3.jsx:111`
  - 采用与 P12 相同手法：本地同步构造 answerList 并传入 `buildMarkObject`

统一提交路径（可选迭代）：
- 将所有页面改为统一走 Provider → AppContext 的 `submitPageDataWithInfo`，与“蒸馒头”完全一致；或统一走 `useDataLogger` 但要求页面侧必须同步构造 answerList。

---

## 验收要点（对齐蒸馒头）

- 任意含答题的页面：提交的 `mark.answerList.length > 0`，内容应为最终答案（含中文 label 或 JSON 字符串）。
- 纯展示页允许 `answerList: []`，但 `operationList` 至少包含页面进入与关键点击。
- 若会话过期（401）：自动清缓存与回登录（两模块一致）。

---

## 附：关键文件参考

- 追踪测评
  - `src/modules/grade-7-tracking/pages/Page14_Solution.jsx:120`
  - `src/modules/grade-7-tracking/context/TrackingProvider.jsx:546`
  - `src/modules/grade-7-tracking/hooks/useDataLogger.js:41`
  - `src/modules/grade-7-tracking/DATA_SUBMISSION_STANDARD.md:1`

- 蒸馒头
  - `src/pages/Page_18_Solution_Selection.jsx:260`
  - `src/pages/Page_18_Solution_Selection.jsx:286`
  - `src/context/AppContext.jsx:417`
  - `src/context/AppContext.jsx:473`

---

如需，我可以继续批量对齐其它页面（分析页等），并统一提交路径以完全与“蒸馒头”一致。

