需求补充：后端业务逻辑与设计说明

本文补充说明后端在“拼装式测评（Flow）”架构下的端到端业务流程、对象关系、时序、失败/边界处理与设计取舍，配合《需求-后端接口与数据模型.md》一起阅读。

一、端到端业务流程
- 登录与入口选择
  - 学生登录后，后端根据账号/批次查询 `batch_flows`：
    - 未绑定 Flow → 返回旧模式：`{ url: '/<module>', pageNum: '...' }`
    - 已绑定 Flow → 返回新模式：`{ url: '/flow/<flowId>', progress: { stepIndex, modulePageNum } }`
  - 前端据 `url` 进入单模块或 Flow；进入 Flow 后加载 FlowDefinition（可由登录响应内嵌或前端 GET 拉取）。
- 页面答题与提交
  - 前端统一使用 `usePageSubmission` 构建 MarkObject（参见 Data Format Spec）提交 `/saveHcMark`；
  - 成功返回后前端推进下一页/下一步；失败策略：非 401 指数退避重试；401 统一回登录。
- 计时与过渡
  - 前端统一计时器到期 → 自动跳子模块总结/完成页 → 进入 TransitionPage → 推进 `stepIndex+1`；
  - 进度持久化可仅在前端（本地）或通过 `/api/progress` 同步至后端 `user_progress`（用于管理端查看与兜底恢复）。
- 恢复与重登录
  - 刷新：前端按本地持久化恢复；
  - 重登录：后端以 `user_progress` 为权威返回最新 progress，前端据此精确恢复。

二、对象与关系（业务视角）
- flows：一个“测评流”定义，支持版本与状态（draft/published/archived）。
- flow_steps：某 Flow 下的有序步骤，每步绑定 `submoduleId` + 可选 `variant/overrides/transitionPage`。
- batch_flows：批次到 Flow 的绑定，作为登录入口来源；
- user_progress：账号在 Flow 内的当前位置：`stepIndex` + `modulePageNum`；
- marks：原始提交数据（MarkObject），建议后期派生 `flow_id/submodule_id/step_index` 字段便于检索。

三、典型时序
1) 登录 → 进入 Flow
   - FE: POST /login → BE: 认证、查询 batch_flows → 返回 `{ url: '/flow/<id>', progress }`
   - FE: 读取/拉取 FlowDefinition → 渲染当前 `stepIndex/modulePageNum` 对应子模块页面
2) 页面提交
   - FE: usePageSubmission → POST /saveHcMark
   - BE: 校验/入库 → 返回 200；（可选）记录审计
   - FE: 导航到下一页或 TransitionPage
3) 进度回写（可选）
   - FE: POST /api/progress `{ examNo,batchCode,flowId,stepIndex,modulePageNum }`
   - BE: upsert user_progress

四、错误与边界处理
- 401/会话过期：
  - /saveHcMark 与管理接口均返回 401；前端统一回登录；
  - 配合 Cookie 安全属性（HttpOnly/SameSite/Secure）减少凭证暴露风险。
- 非法 MarkObject：
  - 必填字段/类型/事件枚举校验失败 → 400，并写异常日志（包含 examNo/batchCode/flowId/stepIndex）。
- 并发与幂等：
  - /saveHcMark：同页多次提交，以最后一次为准（按时间戳）；
  - /api/progress：unique(exam_no,batch_code,flow_id) upsert。

五、设计取舍（Why）
- 后端权威入口（batch→flow）与版本化（flows.version/status）
  - 支持发布冻结/回滚/灰度与审计；避免前端拼装导致口径不一致；
- 低耦合：
  - step 仅存 submoduleId 与少量可选参数，子模块细节在前端，方便独立演进；
- 兼容演进：
  - 不改 /saveHcMark 协议；在 pageDesc 附加 flow/submodule/step，窗口期后再扩字段；
- 可观测：
  - user_progress + marks 提供进度与内容的双视角观测，便于评分与报表；
- 性能策略：
  - JSON 存储采用 jsonb + 必要索引；大表分页 + 条件筛选；分区与归档策略按批次或时间。

六、字段与返回示例
- flows.definition 示例：详见主文档
- /saveHcMark 响应：`{ "code": 200, "msg": "ok" }`
- /api/progress 请求：`{ "examNo":"1001","batchCode":"250619","flowId":"g7a-mix-001","stepIndex":2,"modulePageNum":"11" }`

七、安全与权限
- 管理接口严格鉴权（RBAC）；敏感操作写审计；
- 导出脱敏与越权校验；对公网接口限流与风控（可选）。

八、迁移步骤建议
- 阶段1：启用 Flow 表与绑定，小批次试点；
- 阶段2：新批次全部使用 Flow；旧批次逐步迁移绑定；
- 阶段3：扩展 marks 派生字段与报表；
- 回滚：保留上一版本，可一键回滚；
- 上线验证：抽样回放 MarkObject，校验评分和报表一致性。

