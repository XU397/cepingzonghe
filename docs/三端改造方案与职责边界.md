三端改造方案与职责边界

目标
- 在“人机交互前端（考试端）/管理后台前端（Admin）/后端（API+DB+算法）”的三端架构下，明确各自需要做的改造项、原因与可行落地步骤，支撑拼装式测评与统一规范的实施。

人机交互前端（考试端）
- 必做改造
  - 统一数据提交
    - 对齐《数据提交格式规格》（openspec/specs/data-format/spec.md）与《Assessment Core》（openspec/specs/assessment-core/spec.md）。
    - 使用 shared 的 `createMarkObject/validateMarkObject` 与统一事件类型；允许 `Operation.value` 为对象；可选 `pageId`。
  - 统一计时器
    - 引入统一计时器引擎（主任务/问卷/注意事项），支持跨刷新恢复、并发保护、到期自动跳转（总结/问卷完成），统一 UI 警示阈值；优先补齐四年级缺口（跨刷新/超时自动跳转/401 回登录）。
  - 统一页面框架
    - 采用 AssessmentPageFrame（导航+计时+主体+下一页+错误托盘）与 LeftStepperNav；通过包装器适配 7 年级/7 年级追踪/4 年级，不破坏现有页面组件。
  - Flow 编排运行时
    - 新增 FlowModule（注册到 `ModuleRegistry`），从 `/flow/<flowId>` 进入；拉取 FlowDefinition，与进度（`stepIndex/modulePageNum`）配合恢复；动态加载子模块；过渡页自动跳转；本地 `flow.<id>` 持久化；支持复合页码编码。
  - 401/会话过期统一处理
    - 统一走 `handleSessionExpired`（清空状态→回登录），避免“提交失败仍继续导航”。
  - 上报上下文
    - 在首个进入该子模块的页面操作列表中追加一次性 `flow_context` 操作（写入 `flowId/moduleId/stepIndex`），便于后端检索。
- 可选增强
  - 心跳与进度同步：定时心跳（如 30s）或页面提交后回写服务端进度。
 - 运行日志埋点：关键链路（提交/导航/计时器）输出结构化日志，便于排查。

管理后台前端（Admin）
- Flow 管理
  - Flow Composer（拼装器）：选择子模块序列、过渡页、计时覆盖、变体参数；草稿/发布/版本。
  - Flow 列表/详情：展示 JSON、版本对比、预览入口。
- 批次与账号管理
  - 批次-Flow 绑定页：批次绑定 Flow；支持批量账号导入与校验；账号/批次页显示已绑定 Flow 与进度概览。
- 数据查看与评分
  - 原始数据浏览器：按 `batchCode/examNo/flowId/moduleId/pageNumber` 检索 Mark 数据。
  - 评分/量表配置与人工校对页（按业务需要）。
  - 分析报表：总体、分模块、分题型维度统计导出。
- 安全与审计
  - RBAC 权限、操作日志、版本发布记录、回滚按钮。

后端（API+DB+算法）
- 数据模型
  - `flows`：flowId、name、url、version、status、definition JSON、审计字段。
  - `flow_steps`：flowId、stepIndex、moduleId、variant、overrides、transition。
  - `batch_flows`：batchCode→flowId、version、绑定时间。
  - `user_progress`：examNo、batchCode、flowId、stepIndex、modulePageNum、更新时间。
- API
  - Flow CRUD/发布：`POST/GET /api/flows`、`POST /api/flows/{id}/publish`。
  - 批次绑定：`POST /api/batches/{batchCode}/assign-flow`、`GET /api/batches/{batchCode}/flow`。
  - 登录返回扩展：在登录响应中返回 `url: '/flow/<flowId>'` 与 `progress`（结构化 `stepIndex/modulePageNum` 或兼容复合 `pageNum`）。
  - 进度同步（可选）：`POST /api/progress` 更新当前 `stepIndex/modulePageNum`。
- 提交与验证
  - 保持 `saveHcMark` 不变，兼容 `Operation.value`(object)、复合 `pageNumber`、扩展 `pageDesc`。
  - 服务端验证器：快速校验必备字段与事件枚举，记录异常数据。
- 评分与分析
 - 规则引擎/算法服务接口：按批次/Flow 聚合计算分数；任务调度与导出。

设计理由
- 职责清晰：后端为权威配置与绑定源，保障审计/回滚/发布；考试端只负责执行，Admin 负责配置与运营。
- 低风险演进：不改提交流程/核心接口；先补齐四年级缺口；统一计时/提交后再上 Flow。
- 复用最大化：统一壳与能力层（计时/提交/过渡/导航），模块仅需“包装器”接入。
- 运维友好：Flow 版本化/冻结、进度拉取/回写、标准化日志与报表。

里程碑
- M1：统一数据提交规格与工具；修复四年级计时与 401 流程。
- M2：落地统一计时/页面框架；引入最小 FlowModule（读静态 JSON）。
- M3：上线 Admin 拼装器 + 后端 Flow CRUD/发布 + 批次绑定；登录返回 `/flow/<id>`。
- M4：完善进度同步、报表与评分链路；灰度→全量。

兼容策略
- 登录：旧 `url`（直达单模块）与新 `/flow/<id>` 并存；
- 页码：兼容纯数字与复合编码；
- 数据：后端兼容 `Operation.value` 为字符串与对象；
- 模块：保留旧实现入口（开关化），逐步切换到统一框架与 Hook。


子模块接口规范（CMI）与拆分指南
- CMI 目标
  - 让“交互端”以统一方式加载与运行任意子模块（交互或问卷），并在 Flow 中编排；
  - 降低对现有模块代码的侵入，通过包装器适配；
  - 为后端/管理端提供稳定的子模块标识（submoduleId），用于拼装与追踪。

- CMI 必需字段与能力
  - `submoduleId`: string（唯一，例如：`g7-experiment`、`g7-questionnaire`、`g7-tracking-experiment`、`g7-tracking-questionnaire`、`g4-experiment`）
  - `displayName`: string
  - `version`: string
  - `Component`: React 组件（入口），签名：`({ userContext, initialPageId, options })`
  - `getInitialPage(subPageNum: string|number): pageId`（子模块内页码 → 子模块页面 ID）
  - `getTotalSteps(): number`（用于导航步数）
  - `getNavigationMode(pageId): 'experiment'|'questionnaire'|'hidden'`
  - `getDefaultTimers(): { task?: number, questionnaire?: number, notice?: number }`（可选）
  - `onInitialize()/onDestroy()`（可选）

- 子模块“包装器”适配示例
  - 七年级（蒸馒头）：以现有 `Grade7Module` 派生两套包装器，按页码映射切分 P02–P19（交互）与 P20–P28（问卷），分别导出 `g7-experiment` 与 `g7-questionnaire`；
  - 七年级追踪：直接导出两套包装器，映射 1–13（交互）与 14–21（问卷）；
  - 四年级：当前仅交互，导出 `g4-experiment`；如后续新增问卷，再增加对应包装器。

- 子模块最小内容清单
  - 页面映射：`subPageNum → pageId` 与 `pageId → 相对序号`；
  - 计时器基准：默认用统一计时器引擎，子模块提供默认时长（可被 Flow 覆盖）；
  - 导航：统一导航组件所需的步数与当前步计算；
  - 提交：使用统一提交 Hook；
  - 进入/退出事件：自动上报 `page_enter/page_exit`；
  - 可选：`isComplete()` 针对子模块末页判定，配合过渡页。


Flow 编排运行时（前后端协议）
- 后端如何知道有哪些子模块？
  - 后端维护“子模块注册表”（可与 Flow 配置同表或独立表），至少包含：`submoduleId`、`displayName`、`version`、`status`；
  - 管理端的 Flow Composer 从该注册表拉取可选子模块清单；
  - 交互端不直接依赖后端注册表，而是靠 FlowDefinition 的 `steps[].submoduleId` 与本地 `ModuleRegistry` 的映射加载组件。

- 管理端如何编排新测评？
  - 选择：`A(submoduleId) + B(submoduleId) + E(submoduleId)`，并为每步设置 `overrides`（如计时）、`transitionPage`；
  - 发布后生成 `flowId` 与唯一 `url`（`/flow/<flowId>`），写入数据库；
  - 在“批次管理”中将 `flowId` 绑定到目标批次或账号集。

- 后端记录哪些信息？
  - FlowDefinition（JSON）：`{ flowId, name, url, version, status, steps: [{ submoduleId, variant?, overrides?, transitionPage? }] }`
  - 进度（每账号）：`{ flowId, stepIndex, modulePageNum }`（或 `{ flowId, stepIndex, pageId }`）

- 登录返回哪些信息给交互端？
  - `url: '/flow/<flowId>'`
  - `progress: { stepIndex, modulePageNum }`（结构化）或兼容复合 `pageNum` 字符串（如 `2.11` 表示第 2 子模块第 11 页）；
  - 可选：直接内嵌 `flowDefinition` 以减少接口往返；否则 FlowModule 首屏拉取。

- 交互端如何渲染？
  - `ModuleRouter` 识别 `/flow/<id>` → 加载 FlowModule；
  - FlowModule 获取 `flowDefinition + progress`，定出当前 `stepIndex` 与 `modulePageNum`；
  - 通过 `submoduleId → Component` 映射加载子模块包装器，注入 `userContext` 与 `initialPageId`（由 `getInitialPage(modulePageNum)` 计算）；
  - 统一计时与提交贯穿始终；子模块完成/超时进入 `TransitionPage` → `stepIndex+1`。

- 页面编码与数据库标识策略
  - 复合页码：推荐 `pageNumber = 'M<stepIndex>:<subPageNum>'` 或 `'stepIndex.subPageNum'`；
  - 描述增强：`pageDesc += [flowId/moduleId/stepIndex]` 便于检索；
  - 上下文埋点：在每个子模块首个页面上报 `flow_context` 操作（含 flowId/moduleId/stepIndex）；
  - 兼容：如后端暂不改 schema，可将 `flowId/moduleId/stepIndex` 附加在 `pageDesc`；待时机成熟再扩列字段。

- 批次（batch）与 URL 的关系（复用现概念）
  - 继续以“批次配置 URL”为准：后端将批次绑定到某个 `flowId`（新 URL `/flow/<id>`）或单模块 URL（旧模式），登录时直接返回；
  - 交互端据返回 URL 决定进入 Flow 还是单模块；不需要前端自行推断。

