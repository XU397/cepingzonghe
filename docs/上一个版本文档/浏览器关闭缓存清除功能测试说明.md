# 浏览器关闭缓存清除功能测试说明

## 功能概述

本功能确保用户关闭浏览器标签页后，所有的认证信息和状态缓存都会被清除，下次打开应用时必须从登录页面重新开始。

## 核心特性

✅ **自动检测浏览器关闭**: 区分页面刷新和真正的标签页关闭  
✅ **智能缓存清除**: 仅在真正关闭时清除，刷新时保持状态  
✅ **强制重新登录**: 下次打开时强制从登录页面开始  
✅ **开发调试工具**: 提供可视化测试面板  

## 测试步骤

### 1. 基础功能测试

1. **启动应用**
   ```bash
   npm run dev
   ```

2. **登录并浏览页面**
   - 打开 http://localhost:5173
   - 输入账号密码登录
   - 导航到任意页面（如注意事项页面、介绍页面等）

3. **测试页面刷新**
   - 按 `F5` 或 `Ctrl+R` 刷新页面
   - 确认页面刷新后仍保持在当前页面，不会跳转到登录页

4. **测试浏览器关闭**
   - 关闭浏览器标签页（点击 ✕ 按钮）
   - 重新打开 http://localhost:5173
   - 确认页面跳转到登录页面，之前的状态已被清除

### 2. 使用调试工具测试

1. **打开调试面板**
   - 在页面右下角找到绿色的 🧪 按钮
   - 点击打开浏览器关闭测试面板

2. **查看当前状态**
   - 面板显示当前认证状态和页面信息
   - 查看 localStorage 中存储的数据

3. **测试清除功能**
   - 点击 "🔄 刷新状态" 查看最新数据
   - 点击 "🧽 手动清除" 测试清除功能
   - 点击 "💣 完全清除" 测试完全清除
   - 点击 "🚪 模拟关闭" 模拟浏览器关闭效果

4. **验证清除效果**
   - 使用 "模拟关闭" 后刷新页面
   - 确认跳转到登录页面
   - 在调试面板中确认 localStorage 数据已清除

### 3. 边界情况测试

1. **测试多标签页**
   - 打开多个标签页
   - 在一个标签页中登录
   - 关闭其中一个标签页
   - 验证其他标签页的行为

2. **测试浏览器最小化**
   - 最小化浏览器窗口
   - 重新打开窗口
   - 确认状态保持不变

3. **测试网络断开重连**
   - 断开网络连接
   - 重新连接网络
   - 确认状态保持不变

## 技术实现细节

### 核心机制

1. **事件监听**
   - `beforeunload`: 检测页面即将卸载
   - `unload`: 执行清除操作
   - `visibilitychange`: 辅助检测页面状态

2. **刷新检测**
   - 检查 `event.persisted`
   - 检查 `window.performance.navigation.type`
   - 检查键盘快捷键（Ctrl+R, F5等）

3. **状态管理**
   - 使用 `sessionStorage` 标记关闭状态
   - 使用 `localStorage` 存储清除标志
   - 应用启动时检查清除标志

### 清除的数据项

- `isAuthenticated`: 认证状态
- `currentUser`: 用户信息
- `batchCode`: 批次号
- `examNo`: 考号
- `currentPageId`: 当前页面ID
- `taskStartTime`: 任务开始时间
- `remainingTime`: 剩余时间
- `isTaskFinished`: 任务完成状态
- `questionnaireAnswers`: 问卷答案
- `lastUserId`: 上次登录的用户名

## 调试信息

### 控制台日志

查看浏览器控制台中的日志信息：

```
[BrowserCloseHandler] beforeunload触发: {...}
[BrowserCloseHandler] unload触发: {...}
[BrowserCloseHandler] 检测到浏览器关闭，清除所有缓存...
[AppContext] 检测到缓存已被清除，强制从登录页面开始
```

### localStorage 检查

在开发者工具中检查 localStorage：
1. 打开开发者工具 (F12)
2. 转到 Application/存储 选项卡
3. 查看 Local Storage 项目
4. 验证关闭后数据被清除

## 故障排除

### 常见问题

1. **刷新后仍跳转到登录页**
   - 检查刷新检测逻辑
   - 查看控制台是否有错误信息

2. **关闭后状态未清除**
   - 确认 `unload` 事件是否触发
   - 检查浏览器是否支持相关事件

3. **调试面板不显示**
   - 确认在开发环境运行
   - 检查组件是否正确引入

### 浏览器兼容性

- ✅ Chrome 88+
- ✅ Firefox 85+  
- ✅ Safari 14+
- ✅ Edge 88+

注意：某些浏览器可能对 `beforeunload` 和 `unload` 事件有限制，特别是在移动设备上。

## 生产环境注意事项

1. **调试面板**: 生产环境会自动隐藏调试面板
2. **日志输出**: 建议在生产环境中减少或移除详细日志
3. **性能影响**: 事件监听对性能影响极小
4. **用户体验**: 用户关闭浏览器时不会有任何提示或延迟

## 更新记录

- **2024-01-XX**: 初始版本实现
- 功能完整，测试通过
- 已集成到开发规范文档中 