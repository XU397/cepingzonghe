# 缓存持久化修改说明

## 修改概述

根据新的业务需求，项目已从"浏览器关闭清空缓存"模式改为"状态持久化"模式，确保用户关闭网页后重新打开时能够恢复到之前的状态，包括页面位置和倒计时时间。

## 主要修改内容

### 1. 浏览器关闭处理逻辑修改
**文件**: `src/hooks/useBrowserCloseHandler.js`

- **原逻辑**: 浏览器关闭时清除所有用户数据和认证信息
- **新逻辑**: 浏览器关闭时保持所有状态，记录关闭时间用于倒计时计算
- **关键变化**:
  - 移除了`shouldClearOnNextSession`标志的设置
  - 保留`lastSessionEndTime`记录，用于计算离线时间
  - 不再执行缓存清除操作

### 2. AppContext初始化逻辑修改
**文件**: `src/context/AppContext.jsx`

- **移除缓存清除检测**: 不再检查`shouldClearCache`等标志
- **增强状态恢复**: 默认总是尝试恢复用户状态
- **倒计时精确恢复**:
  - 测评倒计时：从`lastSessionEndTime`计算离线时间，从存储的剩余时间中减去
  - 问卷倒计时：同样支持离线时间计算和状态恢复

### 3. 倒计时超时处理
**文件**: `src/context/AppContext.jsx`

- **测评倒计时为0**: 自动跳转到`Page_19_Task_Completion`（任务完成页面）
- **问卷倒计时为0**: 自动跳转到`Page_28_Effort_Submit`（问卷完成页面）
- **超时跳转**: 添加1秒延迟确保状态更新完成

### 4. 计时器切换逻辑
**文件**: `src/pages/Page_19_Task_Completion.jsx`

- **P19按钮点击**: 
  - 清除测评计时器相关localStorage数据
  - 设置`isTaskFinished = true`
  - 跳转到问卷说明页面

**文件**: `src/pages/questionnaire/Page_20_Questionnaire_Intro.jsx`

- **P20按钮点击**:
  - 启动10分钟问卷倒计时
  - 持久化问卷计时器状态到localStorage
  - 跳转到问卷第一页

### 5. 缓存清除时机
**文件**: `src/context/AppContext.jsx` (handleLogout函数)

- **唯一清除时机**: 仅在问卷完成后点击"返回登录页面"按钮时清除
- **完整清除**: 清除所有认证信息、状态数据、计时器数据和会话标志

## 新的业务流程

### 测评阶段（40分钟）
1. 用户登录后进入测评任务
2. 关闭浏览器后重新打开，自动恢复到关闭时的页面和剩余倒计时
3. 倒计时为0时自动跳转到P19任务完成页面
4. 点击"继续完成问卷调查"按钮，停止测评计时器

### 问卷阶段（10分钟）
1. P20页面点击"开始作答"启动问卷计时器
2. 关闭浏览器后重新打开，自动恢复问卷倒计时和页面位置
3. 倒计时为0时自动跳转到P28问卷完成页面
4. 问卷完成后点击"返回登录页面"清除所有缓存

### 状态持久化数据
- 认证信息：`isAuthenticated`, `currentUser`, `batchCode`, `examNo`
- 测评状态：`taskStartTime`, `remainingTime`, `isTaskFinished`
- 问卷状态：`questionnaireStartTime`, `questionnaireRemainingTime`, `isQuestionnaireStarted`, `isQuestionnaireCompleted`
- 页面状态：`currentPageId`, `pageEnterTime`
- 会话状态：`lastSessionEndTime`

## 向后兼容性
- 清理旧的缓存清除标志：`shouldClearCache`, `cacheCleared`, `shouldClearOnNextSession`
- 保持现有API接口不变
- 保持页面组件接口不变

## 测试要点
1. 登录后在任意页面关闭浏览器，重新打开应恢复到同一页面
2. 测评期间关闭浏览器，倒计时应从关闭时间继续
3. 问卷期间关闭浏览器，问卷倒计时应从关闭时间继续
4. 测评倒计时为0时应自动跳转到P19
5. 问卷倒计时为0时应自动跳转到P28
6. 只有在P28完成后点击"返回登录页面"才清除缓存
7. 新用户登录应正常工作，不受旧缓存影响 